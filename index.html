<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK Command Center â€” Mike Bernhardt | Xerox IT Solutions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: #0b0d11;
            --bg2: #10131a;
            --bg3: #161a24;
            --card: #161a24;
            --card-hover: #1c2030;
            --text: #e8eaed;
            --text2: #9aa0ac;
            --text3: #5a6070;
            --accent: #4f8cff;
            --accent2: #34d399;
            --accent3: #f59e0b;
            --accent4: #ef4444;
            --accent5: #a78bfa;
            --xerox-red: #e4002b;
            --border: rgba(255,255,255,.07);
            --border2: rgba(255,255,255,.12);
            --font: 'DM Sans', system-ui, sans-serif;
            --mono: 'JetBrains Mono', 'SF Mono', monospace;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.5; -webkit-font-smoothing: antialiased; }
        .container { max-width: 1360px; margin: 0 auto; padding: 0 24px; }

        /* AUTH SCREEN */
        .auth-overlay {
            position: fixed; inset: 0; z-index: 999;
            background: var(--bg);
            display: flex; align-items: center; justify-content: center;
        }
        .auth-overlay.hidden { display: none; }
        .auth-box {
            background: var(--card); border: 1px solid var(--border2);
            border-radius: 16px; padding: 40px 36px; width: 360px; text-align: center;
        }
        .auth-logo { font-size: 18px; font-weight: 700; color: var(--xerox-red); margin-bottom: 4px; }
        .auth-logo span { color: var(--text2); font-weight: 400; font-size: 14px; }
        .auth-subtitle { font-size: 13px; color: var(--text3); margin-bottom: 28px; }
        .auth-input {
            width: 100%; padding: 12px 16px; border-radius: 10px;
            background: var(--bg); border: 1px solid var(--border2); color: var(--text);
            font-family: var(--font); font-size: 14px; outline: none; text-align: center;
            letter-spacing: .1em;
        }
        .auth-input:focus { border-color: var(--accent); }
        .auth-btn {
            width: 100%; padding: 12px; border-radius: 10px; margin-top: 12px;
            background: var(--xerox-red); color: #fff; border: none;
            font-family: var(--font); font-size: 14px; font-weight: 600; cursor: pointer;
            transition: opacity .2s;
        }
        .auth-btn:hover { opacity: .9; }
        .auth-error { font-size: 12px; color: var(--accent4); margin-top: 10px; display: none; }

        /* APP WRAPPER */
        .app { display: none; }
        .app.visible { display: block; }

        /* NAV */
        .topbar {
            position: sticky; top: 0; z-index: 50;
            background: rgba(11,13,17,.92); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border); padding: 10px 0;
        }
        .topbar-inner { display: flex; justify-content: space-between; align-items: center; }
        .topbar-left { display: flex; align-items: center; gap: 20px; }
        .topbar-brand { display: flex; align-items: center; gap: 10px; }
        .topbar-xerox { font-weight: 700; font-size: 15px; color: var(--xerox-red); letter-spacing: .02em; }
        .topbar-its { font-size: 13px; color: var(--text2); font-weight: 500; }
        .topbar-sep { color: var(--text3); font-size: 12px; }
        .topbar-name { font-size: 12px; color: var(--text3); }
        .topbar-tabs { display: flex; gap: 3px; overflow-x: auto; }
        .topbar-tab {
            padding: 6px 13px; border-radius: 8px; font-size: 12px; font-weight: 500;
            color: var(--text2); cursor: pointer; border: none; background: none;
            transition: all .15s; white-space: nowrap;
        }
        .topbar-tab:hover { color: var(--text); background: rgba(255,255,255,.05); }
        .topbar-tab.active { color: var(--accent); background: rgba(79,140,255,.1); }
        .topbar-right { display: flex; align-items: center; gap: 14px; flex-shrink: 0; }
        .topbar-target { font-size: 11px; color: var(--text3); font-family: var(--mono); }
        .topbar-target strong { color: var(--accent2); }
        .topbar-restore {
            font-size: 11px; color: var(--text3); cursor: pointer; border: none;
            background: none; font-family: var(--font); padding: 4px 8px; border-radius: 6px;
            transition: all .15s;
        }
        .topbar-restore:hover { color: var(--text); background: rgba(255,255,255,.05); }
        .restore-modal {
            position: fixed; inset: 0; z-index: 998; background: rgba(0,0,0,.6);
            display: flex; align-items: center; justify-content: center;
        }
        .restore-modal.hidden { display: none; }
        .restore-box {
            background: var(--card); border: 1px solid var(--border2);
            border-radius: 16px; padding: 28px 24px; width: 400px; text-align: center;
        }
        .restore-box h3 { font-size: 16px; margin-bottom: 12px; }
        .restore-box p { font-size: 13px; color: var(--text2); margin-bottom: 16px; line-height: 1.6; }
        .restore-box .restore-info { font-size: 12px; color: var(--text3); margin-bottom: 16px; font-family: var(--mono); }
        .restore-btns { display: flex; gap: 10px; justify-content: center; }
        .restore-btns button {
            padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600;
            font-family: var(--font); cursor: pointer; border: none; transition: opacity .2s;
        }
        .restore-btns .btn-cancel { background: var(--bg); color: var(--text2); border: 1px solid var(--border2); }
        .restore-btns .btn-restore { background: var(--accent); color: #fff; }

        /* PAGES */
        .page { display: none; }
        .page.active { display: block; }

        /* DASH HEADER */
        .dash-header { padding: 28px 0 20px; }
        .dash-header h1 { font-size: 22px; font-weight: 700; color: var(--text); }
        .dash-header p { font-size: 13px; color: var(--text2); margin-top: 3px; }

        /* KPI */
        .kpi-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 16px; }
        .kpi {
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 18px 16px; position: relative;
        }
        .kpi-label { font-size: 10px; font-weight: 600; letter-spacing: .08em; text-transform: uppercase; color: var(--text3); margin-bottom: 6px; }
        .kpi-value { font-size: 26px; font-weight: 700; color: var(--text); font-family: var(--mono); }
        .kpi-sub { font-size: 11px; color: var(--text2); margin-top: 3px; }
        .kpi-accent .kpi-value { color: var(--accent); }
        .kpi-green .kpi-value { color: var(--accent2); }
        .kpi-warn .kpi-value { color: var(--accent3); }
        .kpi-red .kpi-value { color: var(--accent4); }

        /* TARGET BAR */
        .target-bar-wrap { margin-bottom: 20px; }
        .target-bar-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
        .target-bar-title { font-size: 13px; font-weight: 600; color: var(--text); }
        .target-bar-pct { font-size: 18px; font-weight: 700; color: var(--accent2); font-family: var(--mono); }
        .target-bar-outer { height: 16px; border-radius: 10px; background: var(--bg3); overflow: hidden; }
        .target-bar-inner { height: 100%; border-radius: 10px; background: linear-gradient(90deg, var(--xerox-red), var(--accent2)); transition: width 1s ease; }
        .target-bar-markers { display: flex; justify-content: space-between; font-size: 10px; color: var(--text3); margin-top: 4px; font-family: var(--mono); }

        /* GRIDS */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; margin-bottom: 16px; }

        .panel { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; }
        .panel-title { font-size: 12px; font-weight: 600; letter-spacing: .04em; text-transform: uppercase; color: var(--text2); margin-bottom: 14px; }

        /* BARS */
        .bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .bar-label { font-size: 12px; color: var(--text2); width: 110px; flex-shrink: 0; text-align: right; }
        .bar-track { flex: 1; height: 20px; background: var(--bg); border-radius: 6px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 6px; display: flex; align-items: center; padding-left: 8px; font-size: 10px; font-weight: 600; color: var(--bg); min-width: 20px; }
        .bar-count { font-size: 12px; color: var(--text3); width: 28px; text-align: right; font-family: var(--mono); }

        /* TABLES */
        .tbl-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th {
            text-align: left; padding: 9px 10px; font-size: 10px; font-weight: 600;
            letter-spacing: .06em; text-transform: uppercase; color: var(--text3);
            border-bottom: 1px solid var(--border2); position: sticky; top: 0; background: var(--card);
        }
        td { padding: 9px 10px; border-bottom: 1px solid var(--border); color: var(--text2); vertical-align: top; }
        tr:hover td { background: rgba(255,255,255,.02); color: var(--text); }
        .tag { display: inline-block; padding: 2px 7px; border-radius: 6px; font-size: 10px; font-weight: 600; letter-spacing: .02em; white-space: nowrap; }
        .tag-a { background: rgba(239,68,68,.12); color: #f87171; }
        .tag-b { background: rgba(245,158,11,.12); color: #fbbf24; }
        .tag-c { background: rgba(100,116,139,.15); color: #94a3b8; }
        .tag-new { background: rgba(100,116,139,.1); color: var(--text3); }
        .tag-db { background: rgba(79,140,255,.1); color: var(--accent); }

        /* FILTERS */
        .filter-bar { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
        .filter-input {
            flex: 1; min-width: 180px; padding: 9px 13px; border-radius: 10px;
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            font-family: var(--font); font-size: 13px; outline: none;
        }
        .filter-input:focus { border-color: var(--accent); }
        .filter-input::placeholder { color: var(--text3); }
        .filter-select {
            padding: 9px 13px; border-radius: 10px;
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            font-family: var(--font); font-size: 12px; outline: none; cursor: pointer;
        }

        /* PILLAR CARDS */
        .pillar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .pillar-card {
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 16px 14px; transition: all .2s;
        }
        .pillar-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .pillar-icon { font-size: 20px; margin-bottom: 8px; }
        .pillar-name { font-size: 12px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: .04em; margin-bottom: 4px; }
        .pillar-vendors { font-size: 11px; color: var(--text3); line-height: 1.5; }
        .pillar-services { font-size: 11px; color: var(--accent); margin-top: 6px; }

        /* PLAYBOOK */
        .play-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; }
        .play-card {
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 22px 18px; transition: all .2s;
        }
        .play-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .play-card h3 { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
        .play-card p { font-size: 12px; color: var(--text2); line-height: 1.65; }
        .play-example {
            margin-top: 10px; padding: 10px; border-radius: 8px;
            background: rgba(255,255,255,.03); border: 1px solid var(--border);
            font-size: 11px; color: var(--text2); line-height: 1.6;
        }
        .play-example strong { color: var(--accent); }

        /* CALC */
        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .calc-panel { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px; }
        .calc-panel h3 { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 14px; }
        .calc-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid var(--border); }
        .calc-row:last-child { border: none; font-weight: 700; color: var(--accent); }
        .calc-label { font-size: 12px; color: var(--text2); }
        .calc-val { font-size: 13px; color: var(--text); font-family: var(--mono); }

        .sec-header { padding: 24px 0 16px; }
        .sec-header h2 { font-size: 18px; font-weight: 700; }
        .sec-header p { font-size: 13px; color: var(--text2); margin-top: 3px; }

        .tbl-scroll { max-height: 600px; overflow-y: auto; border-radius: var(--radius); }
        .tbl-scroll::-webkit-scrollbar { width: 5px; }
        .tbl-scroll::-webkit-scrollbar-thumb { background: var(--text3); border-radius: 3px; }

        .action-item { padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 12px; color: var(--text2); }
        .action-item:last-child { border: none; }

        .count-badge { display: inline-block; background: rgba(79,140,255,.15); color: var(--accent); font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 10px; margin-left: 6px; font-family: var(--mono); }

        /* SECTION TABS */
        .section-tabs { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
        .section-tab {
            padding: 7px 14px; border-radius: 8px; font-size: 11px; font-weight: 600;
            color: var(--text3); cursor: pointer; border: 1px solid var(--border); background: none;
            transition: all .15s; text-transform: uppercase; letter-spacing: .04em;
        }
        .section-tab:hover { color: var(--text); border-color: var(--border2); }
        .section-tab.active { color: var(--accent); border-color: var(--accent); background: rgba(79,140,255,.08); }
        .section-content { display: none; }
        .section-content.active { display: block; }

        /* DISCOVERY Q */
        .q-group { margin-bottom: 14px; }
        .q-group-header {
            display: flex; align-items: center; gap: 8px; padding: 10px 14px;
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            cursor: pointer; transition: all .15s;
        }
        .q-group-header:hover { border-color: var(--border2); }
        .q-group-header .q-icon { font-size: 16px; }
        .q-group-header .q-title { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; }
        .q-group-header .q-toggle { font-size: 11px; color: var(--text3); transition: transform .2s; }
        .q-group.open .q-toggle { transform: rotate(90deg); }
        .q-body { display: none; padding: 12px 16px; border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius) var(--radius); background: rgba(22,26,36,.6); }
        .q-group.open .q-body { display: block; }
        .q-item { padding: 5px 0; font-size: 12px; color: var(--text2); border-bottom: 1px solid var(--border); }
        .q-item:last-child { border: none; }
        .q-item strong { color: var(--accent); font-weight: 500; }

        /* BATTLE CARDS */
        .battle-card {
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 20px; margin-bottom: 12px;
        }
        .battle-card h3 { font-size: 14px; font-weight: 700; margin-bottom: 10px; }
        .battle-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .battle-col h4 { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; margin-bottom: 6px; }
        .battle-col.strengths h4 { color: var(--accent4); }
        .battle-col.weaknesses h4 { color: var(--accent2); }
        .battle-col li { font-size: 12px; color: var(--text2); margin-bottom: 3px; margin-left: 14px; }
        .battle-counter { margin-top: 10px; padding: 10px; border-radius: 8px; background: rgba(79,140,255,.06); border: 1px solid rgba(79,140,255,.15); }
        .battle-counter strong { color: var(--accent); font-size: 11px; text-transform: uppercase; letter-spacing: .04em; }
        .battle-counter p { font-size: 12px; color: var(--text2); margin-top: 4px; }

        /* EMAIL TEMPLATES */
        .email-tpl {
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 18px; margin-bottom: 12px;
        }
        .email-tpl h3 { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
        .email-tpl .email-subject { font-size: 11px; color: var(--accent); margin-bottom: 8px; }
        .email-tpl .email-body {
            font-size: 12px; color: var(--text2); line-height: 1.7;
            padding: 12px; border-radius: 8px; background: var(--bg); border: 1px solid var(--border);
            white-space: pre-line;
        }
        .copy-btn {
            margin-top: 8px; padding: 5px 12px; border-radius: 6px; font-size: 11px;
            font-weight: 600; background: rgba(79,140,255,.1); color: var(--accent);
            border: 1px solid rgba(79,140,255,.2); cursor: pointer; transition: all .15s;
        }
        .copy-btn:hover { background: rgba(79,140,255,.2); }

        /* DEAL CALC */
        .deal-input {
            width: 100%; padding: 9px 12px; border-radius: 8px; margin-bottom: 8px;
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            font-family: var(--mono); font-size: 13px; outline: none;
        }
        .deal-input:focus { border-color: var(--accent); }
        .deal-label { font-size: 11px; color: var(--text3); margin-bottom: 3px; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
        .deal-result {
            padding: 12px; border-radius: 8px; background: rgba(52,211,153,.06);
            border: 1px solid rgba(52,211,153,.15); margin-top: 10px;
        }
        .deal-result .dr-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; }
        .deal-result .dr-label { color: var(--text2); }
        .deal-result .dr-val { color: var(--accent2); font-family: var(--mono); font-weight: 600; }

        /* NOTES */
        .notes-area {
            width: 100%; min-height: 120px; padding: 12px; border-radius: 8px;
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            font-family: var(--font); font-size: 13px; outline: none; resize: vertical;
        }
        .notes-area:focus { border-color: var(--accent); }
        .notes-saved { font-size: 11px; color: var(--accent2); margin-top: 4px; opacity: 0; transition: opacity .3s; }
        .notes-saved.show { opacity: 1; }

        /* CALENDAR */
        .cal-month { margin-bottom: 12px; }
        .cal-month-name { font-size: 13px; font-weight: 700; color: var(--text); padding: 8px 0 6px; border-bottom: 1px solid var(--border); }
        .cal-event { display: flex; gap: 10px; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
        .cal-event:last-child { border: none; }
        .cal-date { color: var(--accent); font-family: var(--mono); font-weight: 600; width: 50px; flex-shrink: 0; }
        .cal-desc { color: var(--text2); }
        .cal-type { font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 4px; margin-left: auto; flex-shrink: 0; }
        .cal-budget { background: rgba(245,158,11,.12); color: var(--accent3); }
        .cal-rfp { background: rgba(239,68,68,.12); color: var(--accent4); }
        .cal-renewal { background: rgba(167,139,250,.12); color: var(--accent5); }
        .cal-outreach { background: rgba(52,211,153,.12); color: var(--accent2); }

        /* MODAL */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,.6); backdrop-filter: blur(4px);
            display: flex; align-items: flex-start; justify-content: center;
            padding: 40px 20px; overflow-y: auto;
        }
        .modal-overlay.hidden { display: none; }
        .modal {
            background: var(--bg2); border: 1px solid var(--border2);
            border-radius: 16px; width: 680px; max-width: 100%;
            animation: modalIn .2s ease;
        }
        @keyframes modalIn { from { opacity: 0; transform: translateY(10px); } }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 22px; border-bottom: 1px solid var(--border);
        }
        .modal-header h2 { font-size: 16px; font-weight: 700; }
        .modal-close {
            width: 30px; height: 30px; border-radius: 8px; border: 1px solid var(--border);
            background: none; color: var(--text3); font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close:hover { color: var(--text); border-color: var(--border2); }
        .modal-body { padding: 18px 22px; }
        .modal-section { margin-bottom: 18px; }
        .modal-section-title {
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            letter-spacing: .08em; color: var(--text3); margin-bottom: 8px;
        }
        .modal-row { display: flex; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .modal-field { flex: 1; min-width: 140px; }
        .modal-field label { display: block; font-size: 10px; color: var(--text3); margin-bottom: 3px; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
        .modal-field input, .modal-field select {
            width: 100%; padding: 8px 10px; border-radius: 8px;
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            font-family: var(--font); font-size: 12px; outline: none;
        }
        .modal-field input:focus, .modal-field select:focus { border-color: var(--accent); }
        .modal-field input[type="date"] { font-family: var(--mono); font-size: 11px; }
        .check-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .check-item {
            display: flex; align-items: center; gap: 5px; padding: 5px 10px;
            border-radius: 8px; border: 1px solid var(--border); cursor: pointer;
            font-size: 11px; color: var(--text2); transition: all .15s; user-select: none;
        }
        .check-item:hover { border-color: var(--border2); }
        .check-item.checked { border-color: var(--accent); color: var(--accent); background: rgba(79,140,255,.08); }
        .check-item input { display: none; }
        .modal-notes {
            width: 100%; min-height: 80px; padding: 10px; border-radius: 8px;
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            font-family: var(--font); font-size: 12px; outline: none; resize: vertical;
        }
        .modal-notes:focus { border-color: var(--accent); }
        .modal-footer {
            display: flex; justify-content: flex-end; gap: 8px;
            padding: 14px 22px; border-top: 1px solid var(--border);
        }
        .modal-btn {
            padding: 9px 20px; border-radius: 8px; font-size: 12px; font-weight: 600;
            cursor: pointer; border: none; transition: all .15s;
        }
        .modal-btn-primary { background: var(--accent); color: #fff; }
        .modal-btn-primary:hover { opacity: .9; }
        .modal-btn-ghost { background: none; border: 1px solid var(--border); color: var(--text2); }
        .modal-btn-ghost:hover { border-color: var(--border2); color: var(--text); }
        .tbl-clickable tbody tr { cursor: pointer; }
        .tbl-clickable tbody tr:hover td { background: rgba(79,140,255,.04); }
        .tag-discovery { background: rgba(79,140,255,.12); color: var(--accent); }
        .tag-needs-analysis { background: rgba(99,102,241,.12); color: #818cf8; }
        .tag-qualifying { background: rgba(167,139,250,.12); color: var(--accent5); }
        .tag-proposal { background: rgba(245,158,11,.12); color: var(--accent3); }
        .tag-negotiation { background: rgba(239,68,68,.12); color: var(--accent4); }
        .tag-won { background: rgba(52,211,153,.15); color: var(--accent2); }
        .tag-lost { background: rgba(100,116,139,.15); color: var(--text3); text-decoration: line-through; }
        .tag-fresh { background: rgba(100,116,139,.1); color: var(--text3); }
        .pillar-dots { display: flex; gap: 2px; flex-wrap: wrap; }
        .pdot { display: inline-block; padding: 1px 4px; border-radius: 3px; font-size: 8px; font-weight: 700; background: rgba(79,140,255,.12); color: var(--accent); letter-spacing: .02em; }
        .flag-icons { display: flex; gap: 3px; font-size: 12px; }
        .cal-embed { width: 100%; height: 700px; border: none; border-radius: var(--radius); background: var(--card); }
        .grid-4 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
        .mtg-item { display: flex; align-items: flex-start; gap: 10px; padding: 7px 0; border-bottom: 1px solid var(--border); }
        .mtg-item:last-child { border-bottom: none; }
        .mtg-time { min-width: 52px; font-family: var(--mono); font-size: 11px; color: var(--accent); font-weight: 600; line-height: 1.4; }
        .mtg-time .mtg-date { font-size: 9px; color: var(--text3); font-weight: 400; }
        .mtg-info { flex: 1; min-width: 0; }
        .mtg-info .mtg-title { font-size: 12px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mtg-info .mtg-acct { font-size: 10px; color: var(--text3); }
        .mtg-add-row { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .mtg-add-row input { flex: 1; min-width: 70px; font-size: 11px; padding: 5px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-family: var(--sans); }
        .mtg-add-row input:focus { border-color: var(--accent); outline: none; }
        .mtg-add-btn { font-size: 11px; padding: 5px 10px; background: var(--accent); color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .mtg-add-btn:hover { opacity: .85; }
        .mtg-del { font-size: 10px; color: var(--text3); cursor: pointer; padding: 2px 4px; border-radius: 3px; }
        .mtg-del:hover { color: var(--accent4); background: rgba(239,68,68,.1); }
        .oc-note { display: flex; gap: 8px; align-items: flex-start; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 11px; }
        .oc-note:last-child { border-bottom: none; }
        .oc-note-type { font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 600; flex-shrink: 0; text-transform: uppercase; }
        .oc-note-type.note { background: rgba(99,102,241,.15); color: #818cf8; }
        .oc-note-type.follow-up { background: rgba(251,191,36,.15); color: #fbbf24; }
        .oc-note-type.pipeline { background: rgba(52,211,153,.15); color: #34d399; }
        .oc-note-type.flag { background: rgba(239,68,68,.15); color: #ef4444; }
        .oc-note-body { flex: 1; min-width: 0; }
        .oc-note-text { color: var(--text); word-break: break-word; }
        .oc-note-meta { color: var(--text3); font-size: 9px; margin-top: 2px; }
        .oc-note-dismiss { font-size: 10px; color: var(--text3); cursor: pointer; padding: 2px 4px; border-radius: 3px; flex-shrink: 0; }
        .oc-note-dismiss:hover { color: var(--accent4); background: rgba(239,68,68,.1); }

        /* QUICK ACTIONS */
        .quick-actions { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .qa-btn {
            padding: 8px 16px; border-radius: 8px; font-size: 11px; font-weight: 600;
            cursor: pointer; border: 1px solid var(--border); background: var(--card);
            color: var(--text2); transition: all .15s; font-family: var(--font);
        }
        .qa-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(79,140,255,.06); }
        .qa-btn span { margin-right: 4px; }

        /* STALE/HOT */
        .stale-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 11px; }
        .stale-row:last-child { border-bottom: none; }
        .stale-name { color: var(--text); font-weight: 500; }
        .stale-days { color: var(--accent4); font-family: var(--mono); font-size: 10px; }
        .hot-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 11px; }
        .hot-row:last-child { border-bottom: none; }
        .hot-name { color: var(--text); font-weight: 500; }
        .hot-val { color: var(--accent2); font-family: var(--mono); font-size: 10px; }

        /* STAGE BREAKDOWN */
        .stage-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 11px; }
        .stage-label { color: var(--text2); }
        .stage-count { font-family: var(--mono); color: var(--text); }
        .stage-value { font-family: var(--mono); color: var(--accent2); font-size: 10px; }

        /* QUICK ADD MODAL */
        .qa-modal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,.6); display: flex; align-items: center; justify-content: center; }
        .qa-modal.hidden { display: none; }
        .qa-box { background: var(--bg2); border: 1px solid var(--border2); border-radius: 16px; padding: 24px; width: 440px; max-width: 95%; }
        .qa-box h3 { font-size: 15px; font-weight: 700; margin-bottom: 14px; }
        .qa-field { margin-bottom: 10px; }
        .qa-field label { display: block; font-size: 10px; color: var(--text3); margin-bottom: 3px; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
        .qa-field input, .qa-field select, .qa-field textarea {
            width: 100%; padding: 8px 10px; border-radius: 8px;
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            font-family: var(--font); font-size: 12px; outline: none;
        }
        .qa-field textarea { min-height: 60px; resize: vertical; }
        .qa-field input:focus, .qa-field select:focus, .qa-field textarea:focus { border-color: var(--accent); }
        .qa-btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 14px; }

        /* HIGH-VALUE DEAL HIGHLIGHT */
        tr.deal-hot td:first-child { border-left: 3px solid var(--accent2); }

        /* KANBAN BOARD */
        .kanban-board {
            display: flex; gap: 8px; overflow-x: auto; padding: 16px 0; min-height: 420px;
            scrollbar-width: thin; scrollbar-color: var(--text3) transparent;
        }
        .kanban-board::-webkit-scrollbar { height: 6px; }
        .kanban-board::-webkit-scrollbar-thumb { background: var(--text3); border-radius: 3px; }
        .kanban-column {
            min-width: 210px; max-width: 240px; flex-shrink: 0;
            background: rgba(255,255,255,0.02); border-radius: 10px; padding: 0;
            display: flex; flex-direction: column;
        }
        .kanban-column-header {
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            padding: 10px 10px 8px; border-bottom: 2px solid var(--stage-color, var(--accent));
            display: flex; justify-content: space-between; align-items: center;
            color: var(--text2);
        }
        .kanban-column-header .col-total { font-family: var(--mono); font-size: 10px; color: var(--accent2); font-weight: 600; }
        .kanban-column-body { flex: 1; padding: 6px; min-height: 60px; }
        .deal-card {
            background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px 10px 8px;
            margin-bottom: 6px; cursor: grab; border-left: 3px solid var(--stage-color, var(--accent));
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .deal-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .deal-card.sortable-ghost { opacity: 0.4; }
        .deal-card.sortable-chosen { box-shadow: 0 6px 20px rgba(0,0,0,0.5); }
        .deal-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .deal-card-account { font-size: 12px; font-weight: 600; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .deal-card-health { font-size: 12px; flex-shrink: 0; margin-left: 4px; }
        .deal-card-value { font-size: 17px; font-weight: 700; color: var(--accent2); font-family: var(--mono); }
        .deal-card-meta { display: flex; gap: 6px; align-items: center; margin-top: 4px; }
        .deal-card-days { font-size: 10px; color: var(--text3); }
        .deal-card-meddpicc {
            font-size: 10px; font-weight: 700; padding: 1px 5px; border-radius: 4px;
            font-family: var(--mono);
        }
        .deal-card-meddpicc.mred { background: rgba(239,68,68,.2); color: #f87171; }
        .deal-card-meddpicc.myellow { background: rgba(245,158,11,.2); color: #fbbf24; }
        .deal-card-meddpicc.mgreen { background: rgba(52,211,153,.2); color: #34d399; }
        .deal-card-next { font-size: 10px; color: var(--text3); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .deal-card-age-warning { border-left-color: var(--accent3) !important; background: rgba(245,158,11,.06) !important; }
        .deal-card-age-warning .deal-card-days { color: var(--accent3); font-weight: 700; }
        .deal-card-age-critical { border-left-color: var(--accent4) !important; background: rgba(239,68,68,.08) !important; animation: pulse-critical 2s ease-in-out infinite; }
        .deal-card-age-critical .deal-card-days { color: var(--accent4); font-weight: 700; }
        @keyframes pulse-critical { 0%,100% { box-shadow: none; } 50% { box-shadow: 0 0 8px rgba(239,68,68,.25); } }
        .kanban-summary { display: flex; gap: 16px; margin-bottom: 8px; flex-wrap: wrap; }
        .kanban-stat { font-size: 12px; color: var(--text2); }
        .kanban-stat strong { color: var(--text); font-family: var(--mono); }

        /* TERRITORY MAP */
        .map-container { height: 520px; border-radius: 10px; border: 1px solid var(--border); overflow: hidden; }
        .map-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
        .map-controls select { padding: 6px 10px; border-radius: 8px; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-family: var(--font); font-size: 12px; outline: none; }
        .map-controls select:focus { border-color: var(--accent); }
        .map-legend { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 12px; }
        .map-legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text2); }
        .map-legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .map-stats { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 12px; }
        .map-stats .ws-stat { font-size: 12px; color: var(--text2); }
        .map-stats .ws-stat strong { color: var(--text); font-family: var(--mono); }
        .leaflet-popup-content-wrapper { background: var(--bg2) !important; color: var(--text) !important; border: 1px solid var(--border2) !important; border-radius: 10px !important; box-shadow: 0 8px 24px rgba(0,0,0,.4) !important; }
        .leaflet-popup-tip { background: var(--bg2) !important; border: 1px solid var(--border2) !important; }
        .leaflet-popup-content { font-family: var(--font) !important; font-size: 12px !important; margin: 10px 14px !important; }
        .map-popup-name { font-weight: 700; font-size: 13px; margin-bottom: 4px; }
        .map-popup-detail { color: var(--text2); font-size: 11px; line-height: 1.5; }

        /* WHITESPACE HEATMAP */
        .whitespace-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
        .whitespace-controls select, .whitespace-controls input {
            padding: 6px 10px; border-radius: 8px; background: var(--bg); border: 1px solid var(--border);
            color: var(--text); font-family: var(--font); font-size: 12px; outline: none;
        }
        .whitespace-controls select:focus, .whitespace-controls input:focus { border-color: var(--accent); }
        .whitespace-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .whitespace-table th { position: sticky; top: 0; background: var(--bg2); padding: 6px 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .03em; color: var(--text3); border-bottom: 1px solid var(--border); white-space: nowrap; }
        .whitespace-table th:first-child { text-align: left; min-width: 140px; }
        .whitespace-table td { padding: 5px 4px; text-align: center; border-bottom: 1px solid var(--border); }
        .whitespace-table td:first-child { text-align: left; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .whitespace-table tr:hover td { background: rgba(255,255,255,.03); }
        .ws-active { color: var(--accent2); font-size: 14px; }
        .ws-gap { color: var(--accent4); font-size: 14px; opacity: .4; }
        .ws-score { font-family: var(--mono); font-weight: 700; font-size: 10px; }
        .ws-score-high { color: var(--accent4); }
        .ws-score-med { color: var(--accent3); }
        .ws-score-low { color: var(--accent2); }
        .ws-summary { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
        .ws-stat { font-size: 12px; color: var(--text2); }
        .ws-stat strong { color: var(--text); font-family: var(--mono); }
        .whitespace-wrap { max-height: 600px; overflow-y: auto; border: 1px solid var(--border); border-radius: 10px; }
        .pillar-header { writing-mode: vertical-lr; transform: rotate(180deg); max-height: 80px; }

        /* COMPETITIVE INTEL */
        .competitor-chips { display: flex; flex-wrap: wrap; gap: 5px; }
        .comp-chip {
            font-size: 11px; padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border);
            color: var(--text2); cursor: pointer; user-select: none; transition: all .15s;
        }
        .comp-chip:hover { border-color: var(--border2); }
        .comp-chip.selected { border-color: var(--accent4); color: var(--accent4); background: rgba(239,68,68,.08); }
        .closed-lost-section { background: rgba(239,68,68,.04); border: 1px solid rgba(239,68,68,.12); border-radius: 10px; padding: 14px; margin-top: 10px; }
        .closed-lost-section .modal-section-title { color: var(--accent4); }
        .threat-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
        .threat-high { background: var(--accent4); }
        .threat-medium { background: var(--accent3); }
        .threat-low { background: var(--accent2); }

        /* MULTI-CONTACT */
        .contacts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .contact-add-btn { font-size: 11px; font-weight: 600; color: var(--accent); background: rgba(79,140,255,.1); border: 1px solid rgba(79,140,255,.2); border-radius: 6px; padding: 4px 10px; cursor: pointer; transition: all .15s; }
        .contact-add-btn:hover { background: rgba(79,140,255,.18); }
        .contact-list { display: flex; flex-direction: column; gap: 6px; max-height: 280px; overflow-y: auto; }
        .contact-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; display: flex; align-items: center; gap: 8px; transition: border-color .15s; }
        .contact-card:hover { border-color: var(--border2); }
        .contact-card-info { flex: 1; min-width: 0; }
        .contact-card-name { font-size: 12px; font-weight: 600; color: var(--text); }
        .contact-card-title { font-size: 10px; color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .contact-card-detail { font-size: 10px; color: var(--text3); margin-top: 2px; }
        .contact-role { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; white-space: nowrap; text-transform: uppercase; letter-spacing: .03em; }
        .contact-role.r-champion { background: rgba(52,211,153,.15); color: #34d399; }
        .contact-role.r-economic-buyer { background: rgba(79,140,255,.15); color: #4f8cff; }
        .contact-role.r-technical-buyer { background: rgba(167,139,250,.15); color: #a78bfa; }
        .contact-role.r-user-buyer { background: rgba(14,165,233,.15); color: #0ea5e9; }
        .contact-role.r-influencer { background: rgba(245,158,11,.15); color: #f59e0b; }
        .contact-role.r-gatekeeper { background: rgba(156,163,175,.15); color: #9ca3af; }
        .contact-role.r-blocker { background: rgba(239,68,68,.15); color: #f87171; }
        .contact-role.r-coach { background: rgba(34,197,94,.15); color: #22c55e; }
        .contact-influence { font-size: 9px; font-weight: 600; color: var(--text3); }
        .contact-influence.inf-high { color: var(--accent2); }
        .contact-influence.inf-medium { color: var(--accent3); }
        .contact-stance-dots { display: flex; gap: 2px; margin-top: 2px; }
        .contact-stance-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
        .contact-stance-dot.neg { background: var(--accent4); }
        .contact-stance-dot.pos { background: var(--accent2); }
        .contact-stance-dot.neutral { background: var(--text3); }
        .contact-card-actions { display: flex; gap: 4px; flex-shrink: 0; }
        .contact-card-actions button { width: 24px; height: 24px; border-radius: 6px; border: 1px solid var(--border); background: none; color: var(--text3); font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .contact-card-actions button:hover { color: var(--text); border-color: var(--border2); }
        .contact-form { background: var(--bg); border: 1px solid var(--accent); border-radius: 8px; padding: 10px; margin-top: 6px; }
        .contact-form .modal-row { margin-bottom: 6px; }
        .contact-form-actions { display: flex; gap: 6px; justify-content: flex-end; margin-top: 8px; }
        .contact-empty { text-align: center; padding: 16px 0; color: var(--text3); font-size: 11px; font-style: italic; }

        /* MEDDPICC PANEL */
        .meddpicc-panel { background: rgba(99,102,241,.04); border: 1px solid rgba(99,102,241,.12); border-radius: 10px; padding: 14px; }
        .meddpicc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; }
        .meddpicc-item { display: flex; align-items: center; gap: 8px; }
        .meddpicc-item label { font-size: 10px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: .03em; width: 70px; flex-shrink: 0; }
        .meddpicc-item input[type="range"] { flex: 1; accent-color: #6366f1; height: 4px; cursor: pointer; }
        .meddpicc-item .meddpicc-score { font-size: 11px; font-family: var(--mono); color: var(--accent5); font-weight: 700; width: 20px; text-align: right; }
        .meddpicc-total { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(99,102,241,.12); }
        .meddpicc-total-label { font-size: 11px; font-weight: 600; color: var(--text2); }
        .meddpicc-total-pct { font-size: 16px; font-weight: 700; font-family: var(--mono); }
        .meddpicc-total-pct.mred { color: #f87171; }
        .meddpicc-total-pct.myellow { color: #fbbf24; }
        .meddpicc-total-pct.mgreen { color: #34d399; }
        .meddpicc-bar { flex: 1; height: 6px; background: rgba(255,255,255,.06); border-radius: 3px; overflow: hidden; }
        .meddpicc-fill { height: 100%; border-radius: 3px; transition: width .3s, background .3s; }

        /* STAGE TAGS - UPDATED */
        .tag-prospecting { background: rgba(99,102,241,.12); color: #818cf8; }
        .tag-solution-design { background: rgba(14,165,233,.12); color: #38bdf8; }
        .tag-verbal-commit { background: rgba(34,197,94,.12); color: #4ade80; }

        /* FAB */
        .fab-container { position: fixed; bottom: 24px; right: 24px; z-index: 200; }
        .fab-main {
            width: 56px; height: 56px; border-radius: 50%;
            background: #6366f1; color: white; font-size: 28px; line-height: 56px; text-align: center;
            border: none; cursor: pointer; box-shadow: 0 4px 16px rgba(99,102,241,0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .fab-main:hover { box-shadow: 0 6px 24px rgba(99,102,241,0.5); transform: scale(1.05); }
        .fab-main.open { transform: rotate(45deg); }
        .fab-menu {
            display: none; flex-direction: column; gap: 8px;
            position: absolute; bottom: 66px; right: 0;
        }
        .fab-menu.show { display: flex; }
        .fab-item {
            padding: 10px 16px; border-radius: 24px;
            background: rgba(22,26,36,0.96); color: white;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; white-space: nowrap; font-size: 13px; font-family: var(--font);
            transition: all .15s; backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .fab-item:hover { border-color: var(--accent); background: rgba(22,26,36,1); }

        /* FAB LOG MODAL */
        .fab-log-modal { position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,.6); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .fab-log-modal.hidden { display: none; }
        .fab-log-box {
            background: var(--bg2); border: 1px solid var(--border2); border-radius: 16px;
            padding: 24px; width: 460px; max-width: 95%;
        }
        .fab-log-box h3 { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
        .fab-log-type { font-size: 12px; color: var(--accent5); margin-bottom: 14px; }
        .fab-log-templates { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .fab-log-tpl {
            padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 600;
            background: rgba(255,255,255,.04); border: 1px solid var(--border); color: var(--text2);
            cursor: pointer; font-family: var(--font); transition: all .15s;
        }
        .fab-log-tpl:hover { border-color: var(--accent); color: var(--accent); }

        /* HEALTH SCORE */
        .health-dot { font-size: 11px; cursor: help; }
        .at-risk-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 11px; }
        .at-risk-row:last-child { border-bottom: none; }
        .at-risk-name { color: var(--text); font-weight: 500; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .at-risk-score { font-family: var(--mono); font-size: 10px; font-weight: 700; margin: 0 6px; }
        .at-risk-val { color: var(--accent2); font-family: var(--mono); font-size: 10px; flex-shrink: 0; }

        /* KPI METRIC CARDS */
        .kpi-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px; }
        .kpi-metric {
            background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 16px; position: relative; overflow: hidden;
        }
        .kpi-metric-label { font-size: 10px; font-weight: 600; letter-spacing: .08em; text-transform: uppercase; color: var(--text3); margin-bottom: 6px; }
        .kpi-metric-value { font-size: 24px; font-weight: 700; font-family: var(--mono); margin-bottom: 2px; }
        .kpi-metric-sub { font-size: 11px; color: var(--text2); }
        .kpi-metric-bar { height: 4px; background: rgba(255,255,255,.06); border-radius: 2px; margin-top: 10px; overflow: hidden; }
        .kpi-metric-fill { height: 100%; border-radius: 2px; transition: width .6s ease; }
        .kpi-coverage-zone { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 6px; }
        .kpi-coverage-zone.zone-red { background: rgba(239,68,68,.15); color: #f87171; }
        .kpi-coverage-zone.zone-yellow { background: rgba(245,158,11,.15); color: #fbbf24; }
        .kpi-coverage-zone.zone-green { background: rgba(34,197,94,.15); color: #4ade80; }

        /* TOAST */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 500; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .toast {
            padding: 12px 18px; border-radius: 10px; font-size: 12px; font-weight: 500;
            color: #fff; pointer-events: auto; animation: toastIn .3s ease;
            max-width: 380px; box-shadow: 0 4px 16px rgba(0,0,0,.3);
        }
        .toast.info { background: rgba(99,102,241,.95); }
        .toast.success { background: rgba(34,197,94,.95); }
        .toast.warning { background: rgba(245,158,11,.95); }
        .toast.error { background: rgba(239,68,68,.95); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateX(40px); } }

        @media (max-width: 1000px) {
            .kpi-row, .pillar-grid, .kpi-metrics { grid-template-columns: repeat(2, 1fr); }
            .grid-2, .grid-3, .grid-4, .grid-insights, .calc-grid { grid-template-columns: 1fr; }
            .topbar-tabs { overflow-x: auto; flex-wrap: nowrap; }
            .topbar-inner { flex-direction: column; gap: 8px; }
        }
        @media (max-width: 600px) {
            .kpi-row, .pillar-grid, .kpi-metrics { grid-template-columns: 1fr; }
            .bar-label { width: 80px; font-size: 11px; }
            .topbar-brand { flex-direction: column; gap: 2px; }
            .topbar-name { display: none; }
            .topbar-sep { display: none; }
            .container { padding: 0 12px; }
            .kpi { padding: 12px 10px; }
            .kpi-value { font-size: 20px; }
            .modal { width: 100%; margin: 10px; }
            .modal-body { padding: 12px 14px; }
            .modal-row { flex-direction: column; gap: 8px; }
            .modal-field { min-width: 100%; }
            table { font-size: 11px; }
            th, td { padding: 6px 6px; }
            .quick-actions { gap: 6px; }
            .qa-btn { padding: 6px 10px; font-size: 10px; }
            .qa-box { width: 100%; margin: 10px; }
            .dash-header h1 { font-size: 18px; }
            .panel { padding: 12px; }
        }
    </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="auth-overlay" id="authOverlay">
    <div class="auth-box">
        <div class="auth-logo">Xerox <span>IT Solutions</span></div>
        <div class="auth-subtitle">SK Territory â€” Prospecting Command Center</div>
        <input type="password" class="auth-input" id="authPass" placeholder="Enter access code" autofocus>
        <button class="auth-btn" id="authBtn">Unlock</button>
        <div class="auth-error" id="authError">Incorrect code. Try again.</div>
    </div>
</div>

<!-- APP -->
<div class="app" id="app">

<nav class="topbar">
    <div class="container topbar-inner">
        <div class="topbar-left">
            <div class="topbar-brand">
                <span class="topbar-xerox">Xerox</span>
                <span class="topbar-its">IT Solutions</span>
                <span class="topbar-sep">|</span>
                <span class="topbar-name">Mike Bernhardt &middot; Sr Account Executive</span>
            </div>
            <div class="topbar-tabs">
                <button class="topbar-tab active" data-page="dashboard">Dashboard</button>
                <button class="topbar-tab" data-page="pipeline">Pipeline</button>
                <button class="topbar-tab" data-page="ent">ENT Accounts</button>
                <button class="topbar-tab" data-page="smb">SMB</button>
                <button class="topbar-tab" data-page="k12">K-12</button>
                <button class="topbar-tab" data-page="highered">Higher Ed</button>
                <button class="topbar-tab" data-page="creditunions">Credit Unions</button>
                <button class="topbar-tab" data-page="pillars">Pillars</button>
                <button class="topbar-tab" data-page="territory">Territory</button>
                <button class="topbar-tab" data-page="playbook">Playbook</button>
                <button class="topbar-tab" data-page="tools">Tools</button>
                <button class="topbar-tab" data-page="calendar">Calendar</button>
            </div>
        </div>
        <div class="topbar-right">
            <div class="topbar-target">FY2026: <strong>$3M</strong></div>
            <button class="topbar-restore" onclick="openRestoreModal()" title="Backup & Restore">&#9881;</button>
        </div>
    </div>
</nav>

<!-- ==================== DASHBOARD ==================== -->
<div id="dashboard" class="page active">
    <div class="container">
        <div class="dash-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
            <div>
                <h1>Pipeline Command Center</h1>
                <p>Saskatchewan Territory â€” FY2026</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <button class="mtg-add-btn" style="padding:7px 14px;font-size:11px;background:var(--border);color:var(--text2);" onclick="showCalSetup()" id="calSetupBtn" title="Connect Google Calendar">&#9881; Cal</button>
                <button class="mtg-add-btn" style="padding:7px 14px;font-size:11px;" onclick="generateDigest()">End of Day Digest</button>
            </div>
        </div>

        <div class="target-bar-wrap">
            <div class="target-bar-header">
                <span class="target-bar-title">$3M Annual Target</span>
                <span class="target-bar-pct" id="targetPct">0.8%</span>
            </div>
            <div class="target-bar-outer">
                <div class="target-bar-inner" id="targetBar" style="width: 0.8%;"></div>
            </div>
            <div class="target-bar-markers">
                <span>$0</span><span>$750K</span><span>$1.5M</span><span>$2.25M</span><span>$3M</span>
            </div>
        </div>

        <div class="quick-actions">
            <button class="qa-btn" onclick="openQuickLog()"><span>+</span> Log a Call</button>
            <button class="qa-btn" onclick="openQuickDeal()"><span>+</span> Quick Add Deal</button>
            <button class="qa-btn" onclick="openAddAccount()"><span>+</span> Add Account</button>
            <button class="qa-btn" onclick="showWeekPriorities()"><span>&#9776;</span> This Week</button>
        </div>

        <div class="kpi-metrics" id="kpiMetrics">
            <div class="kpi-metric" id="kpiQuota">
                <div class="kpi-metric-label">Quota Attainment</div>
                <div class="kpi-metric-value" id="kpiQuotaVal">0%</div>
                <div class="kpi-metric-sub" id="kpiQuotaSub">$0 / $3M</div>
                <div class="kpi-metric-bar"><div class="kpi-metric-fill" id="kpiQuotaBar" style="width:0%;background:var(--accent4);"></div></div>
            </div>
            <div class="kpi-metric" id="kpiWeighted">
                <div class="kpi-metric-label">Weighted Pipeline</div>
                <div class="kpi-metric-value" id="kpiWeightedVal" style="color:var(--accent);">$0</div>
                <div class="kpi-metric-sub" id="kpiWeightedSub">value Ã— stage probability</div>
            </div>
            <div class="kpi-metric" id="kpiClosing">
                <div class="kpi-metric-label">Closing This Month</div>
                <div class="kpi-metric-value" id="kpiClosingVal" style="color:var(--accent3);">0</div>
                <div class="kpi-metric-sub" id="kpiClosingSub">$0 in deals</div>
            </div>
            <div class="kpi-metric" id="kpiCoverage">
                <div class="kpi-metric-label">Pipeline Coverage</div>
                <div class="kpi-metric-value" id="kpiCoverageVal">0.0Ã—</div>
                <div class="kpi-metric-sub" id="kpiCoverageSub">weighted / remaining quota</div>
            </div>
        </div>

        <div class="kpi-row">
            <div class="kpi kpi-green">
                <div class="kpi-label">Closed Revenue</div>
                <div class="kpi-value">$24K</div>
                <div class="kpi-sub">FY2026 booked</div>
            </div>
            <div class="kpi kpi-accent">
                <div class="kpi-label">Gap to Target</div>
                <div class="kpi-value">$2.98M</div>
                <div class="kpi-sub">Remaining to close</div>
            </div>
            <div class="kpi">
                <div class="kpi-label">Prospect Accounts</div>
                <div class="kpi-value" id="totalProspects">111</div>
                <div class="kpi-sub">All sectors combined</div>
            </div>
            <div class="kpi kpi-red">
                <div class="kpi-label">Must Win (A)</div>
                <div class="kpi-value" id="aTierCount">21</div>
                <div class="kpi-sub">Priority accounts</div>
            </div>
            <div class="kpi kpi-accent" id="pipelineKpi">
                <div class="kpi-label">Pipeline</div>
                <div class="kpi-value">$0</div>
                <div class="kpi-sub">0 active opportunities</div>
            </div>
            <div class="kpi kpi-warn">
                <div class="kpi-label">Months Remaining</div>
                <div class="kpi-value" id="monthsLeft">11</div>
                <div class="kpi-sub" id="monthlyNeeded">$271K/mo needed</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-title">Prospect Accounts by Sector</div>
                <div class="bar-row"><div class="bar-label">ENT Accounts</div><div class="bar-track"><div class="bar-fill" style="width:62%;background:#ef4444;">35</div></div><div class="bar-count">35</div></div>
                <div class="bar-row"><div class="bar-label">SMB</div><div class="bar-track"><div class="bar-fill" style="width:54%;background:#60a5fa;">30</div></div><div class="bar-count">30</div></div>
                <div class="bar-row"><div class="bar-label">K-12 Education</div><div class="bar-track"><div class="bar-fill" style="width:48%;background:#818cf8;">27</div></div><div class="bar-count">27</div></div>
                <div class="bar-row"><div class="bar-label">Credit Unions</div><div class="bar-track"><div class="bar-fill" style="width:25%;background:#34d399;">14</div></div><div class="bar-count">14</div></div>
                <div class="bar-row"><div class="bar-label">Higher Ed</div><div class="bar-track"><div class="bar-fill" style="width:9%;background:#fbbf24;">5</div></div><div class="bar-count">5</div></div>
            </div>

            <div class="panel">
                <div class="panel-title">IT Competitor Footprint</div>
                <div id="competitorBars">
                    <div class="bar-row"><div class="bar-label">WBM</div><div class="bar-track"><div class="bar-fill" style="width:5%;background:var(--accent3);" id="cf-wbm-bar">â€”</div></div><div class="bar-count" id="cf-wbm-ct">â€”</div></div>
                    <div class="bar-row"><div class="bar-label">Horizon</div><div class="bar-track"><div class="bar-fill" style="width:5%;background:var(--accent4);" id="cf-horizon-bar">â€”</div></div><div class="bar-count" id="cf-horizon-ct">â€”</div></div>
                    <div class="bar-row"><div class="bar-label">PC Place</div><div class="bar-track"><div class="bar-fill" style="width:5%;background:var(--accent5);" id="cf-pcplace-bar">â€”</div></div><div class="bar-count" id="cf-pcplace-ct">â€”</div></div>
                    <div class="bar-row"><div class="bar-label">Wolf Strata</div><div class="bar-track"><div class="bar-fill" style="width:5%;background:var(--accent2);" id="cf-wolfstrata-bar">â€”</div></div><div class="bar-count" id="cf-wolfstrata-ct">â€”</div></div>
                    <div class="bar-row"><div class="bar-label">Compugen</div><div class="bar-track"><div class="bar-fill" style="width:5%;background:#a78bfa;" id="cf-compugen-bar">â€”</div></div><div class="bar-count" id="cf-compugen-ct">â€”</div></div>
                    <div class="bar-row"><div class="bar-label">Other / Unknown</div><div class="bar-track"><div class="bar-fill" style="width:5%;background:var(--text3);" id="cf-unknown-bar">â€”</div></div><div class="bar-count" id="cf-unknown-ct">â€”</div></div>
                </div>
                <p style="font-size:10px;color:var(--text3);margin-top:8px;">Auto-updated from account IT Incumbent data</p>
            </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:14px;margin-bottom:16px;" class="grid-insights">
            <div class="panel">
                <div class="panel-title">Pipeline by Stage</div>
                <div id="dashStageBreakdown">
                    <div style="color:var(--text3);font-style:italic;font-size:11px;">No active deals yet.</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title" style="display:flex;align-items:center;gap:6px;">Stale Accounts <span style="font-size:9px;color:var(--accent4);font-weight:400;">(14+ days)</span></div>
                <div id="dashStale">
                    <div style="color:var(--text3);font-style:italic;font-size:11px;">No stale accounts detected.</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title" style="display:flex;align-items:center;gap:6px;">Hot Deals <span style="font-size:9px;color:var(--accent2);font-weight:400;">(75%+ this Q)</span></div>
                <div id="dashHotDeals">
                    <div style="color:var(--text3);font-style:italic;font-size:11px;">No hot deals yet.</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title" style="display:flex;align-items:center;gap:6px;">At Risk <span style="font-size:9px;color:var(--accent4);font-weight:400;">(health &lt;40)</span></div>
                <div id="dashAtRisk">
                    <div style="color:var(--text3);font-style:italic;font-size:11px;">No at-risk accounts.</div>
                </div>
            </div>
        </div>

        <div class="grid-4">
            <div class="panel">
                <div class="panel-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span id="mtgPanelTitle">Next Meetings</span>
                    <span style="display:flex;gap:6px;align-items:center;">
                        <span id="mtgLiveIndicator" style="display:none;font-size:9px;padding:2px 6px;border-radius:3px;background:rgba(52,211,153,.15);color:#34d399;font-weight:600;">LIVE</span>
                        <span id="mtgRefreshBtn" style="display:none;font-size:13px;cursor:pointer;color:var(--text3);" title="Refresh" onclick="fetchCalendarEvents()">&#x21bb;</span>
                        <span id="mtgToggleAdd" style="font-size:16px;cursor:pointer;color:var(--accent);line-height:1;" title="Add meeting manually">+</span>
                    </span>
                </div>
                <div id="mtgAddForm" style="display:none;margin-bottom:10px;">
                    <div class="mtg-add-row">
                        <input type="datetime-local" id="mtg-dt" style="min-width:130px;">
                        <input type="text" id="mtg-title" placeholder="Meeting title">
                    </div>
                    <div class="mtg-add-row" style="margin-top:4px;">
                        <input type="text" id="mtg-acct" placeholder="Account (optional)">
                        <button class="mtg-add-btn" onclick="addMeeting()">Add</button>
                    </div>
                </div>
                <div id="dashMeetings">
                    <div class="action-item" style="color:var(--text3);font-style:italic;">Loading...</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title">Upcoming Follow-Ups</div>
                <div id="dashFollowUps">
                    <div class="action-item" style="color:var(--text3);font-style:italic;">No follow-ups scheduled yet. Set dates in account details.</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title">Flagged Accounts</div>
                <div id="dashFlags">
                    <div class="action-item" style="color:var(--text3);font-style:italic;">No flags set yet. Flag accounts with RFPs, expiring contracts, etc.</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>OpenClaw Inbox</span>
                    <span style="display:flex;gap:6px;align-items:center;">
                        <span id="ocInboxCount" style="display:none;font-size:9px;padding:2px 6px;border-radius:3px;background:rgba(251,191,36,.15);color:#fbbf24;font-weight:600;"></span>
                        <span style="font-size:13px;cursor:pointer;color:var(--text3);" title="Refresh" onclick="fetchOcNotes()">&#x21bb;</span>
                    </span>
                </div>
                <div id="dashOcInbox">
                    <div class="action-item" style="color:var(--text3);font-style:italic;">No notes yet. Message OpenClaw on Telegram to add notes here.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== PIPELINE KANBAN ==================== -->
<div id="pipeline" class="page">
    <div class="container">
        <div class="sec-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
            <div>
                <h2>Pipeline Board</h2>
                <p>Drag deals between stages. MEDDPICC gates enforce qualification.</p>
            </div>
            <div class="kanban-summary" id="kanbanSummary"></div>
        </div>
        <div class="kanban-board" id="kanbanBoard"></div>
    </div>
</div>

<!-- ==================== ENT ACCOUNTS ==================== -->
<div id="ent" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>Enterprise Accounts <span class="count-badge" id="entCount">35</span></h2>
            <p>Major SK organizations (500+ employees). All treated as fresh prospects.</p>
        </div>
        <div class="filter-bar">
            <input type="text" class="filter-input" id="entSearch" placeholder="Search enterprise accounts, sectors, contacts...">
            <select class="filter-select" id="entPriority">
                <option value="">All Priorities</option>
                <option value="A">A â€” Must Win</option>
                <option value="B">B â€” Strategic</option>
                <option value="C">C â€” Develop</option>
            </select>
            <select class="filter-select" id="entSector">
                <option value="">All Sectors</option>
                <option value="Government">Government</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Crown Corp">Crown Corp</option>
                <option value="Mining">Mining</option>
                <option value="Financial">Financial</option>
                <option value="Manufacturing">Manufacturing</option>
                <option value="Energy">Energy</option>
                <option value="Gaming">Gaming</option>
                <option value="Retail">Retail</option>
                <option value="Agriculture">Agriculture</option>
            </select>
        </div>
        <div class="panel" style="padding:0;">
            <div class="tbl-wrap tbl-scroll">
                <table id="entTable" class="tbl-clickable"><thead><tr>
                    <th>Account</th><th>Sector</th><th>Emp</th><th>City</th><th>Pri</th><th>Stage</th><th>Value</th><th style="text-align:center;">HP</th><th>Pillars</th><th>Flags</th>
                </tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>
</div>

<!-- ==================== SMB ==================== -->
<div id="smb" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>SMB Prospects <span class="count-badge" id="smbCount">30</span></h2>
            <p>Mid-market SK organizations (100â€“499 employees or $10M+ revenue). Sourced from SK Company Database.</p>
        </div>
        <div class="filter-bar">
            <input type="text" class="filter-input" id="smbSearch" placeholder="Search SMB prospects, industries, cities...">
            <select class="filter-select" id="smbIndustry">
                <option value="">All Industries</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Gaming">Gaming</option>
                <option value="Technology">Technology</option>
                <option value="Manufacturing">Manufacturing</option>
                <option value="Energy">Energy</option>
                <option value="Mining">Mining</option>
                <option value="Transportation">Transportation</option>
                <option value="Construction">Construction</option>
                <option value="Government">Government</option>
                <option value="Engineering">Engineering</option>
                <option value="Media">Media</option>
                <option value="Finance">Finance</option>
            </select>
        </div>
        <div class="panel" style="padding:0;">
            <div class="tbl-wrap tbl-scroll">
                <table id="smbTable" class="tbl-clickable"><thead><tr>
                    <th>Company</th><th>Industry</th><th>Emp</th><th>City</th><th>Stage</th><th>Value</th><th style="text-align:center;">HP</th><th>Pillars</th><th>Flags</th>
                </tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>
</div>

<!-- ==================== K-12 ==================== -->
<div id="k12" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>K-12 Education <span class="count-badge">27</span></h2>
            <p>27 school divisions. Contact info retained. All treated as fresh prospects.</p>
        </div>
        <div class="filter-bar">
            <input type="text" class="filter-input" id="k12Search" placeholder="Search divisions, contacts...">
            <select class="filter-select" id="k12Priority">
                <option value="">All Priorities</option>
                <option value="A">A â€” Must Win</option>
                <option value="B">B â€” Strategic</option>
                <option value="C">C â€” Develop</option>
            </select>
        </div>
        <div class="panel" style="padding:0;">
            <div class="tbl-wrap tbl-scroll">
                <table id="k12Table" class="tbl-clickable"><thead><tr>
                    <th>School Division</th><th>Type</th><th>Region</th><th>Students</th><th>Incumbent</th><th>CFO</th><th>IT Contact</th><th>Priority</th>
                </tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>
</div>

<!-- ==================== HIGHER ED ==================== -->
<div id="highered" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>Higher Education <span class="count-badge">5</span></h2>
            <p>Saskatchewan universities, polytechnic, and indigenous institutions.</p>
        </div>
        <div class="panel" style="padding:0;">
            <div class="tbl-wrap tbl-scroll">
                <table id="higheredTable" class="tbl-clickable"><thead><tr>
                    <th>Institution</th><th>Type</th><th>City</th><th>Priority</th><th>MPS Opp</th><th>M365/Cloud Opp</th><th>Managed IT Opp</th><th>Stage</th>
                </tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>
</div>

<!-- ==================== CREDIT UNIONS ==================== -->
<div id="creditunions" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>Saskatchewan Credit Unions <span class="count-badge">14</span></h2>
            <p>14 credit unions by assets. All treated as fresh prospects.</p>
        </div>
        <div class="filter-bar">
            <input type="text" class="filter-input" id="cuSearch" placeholder="Search credit unions...">
        </div>
        <div class="panel" style="padding:0;">
            <div class="tbl-wrap tbl-scroll">
                <table id="cuTable" class="tbl-clickable"><thead><tr>
                    <th>Credit Union</th><th>Rank</th><th>Assets</th><th>Members</th><th>Locations</th><th>City</th><th>Priority</th>
                </tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>
</div>

<!-- ==================== PILLARS ==================== -->
<div id="pillars" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>Xerox IT Solutions â€” Portfolio</h2>
            <p>Full solution stack via Powerland. On-premise, cloud, and managed services.</p>
        </div>

        <div class="pillar-grid">
            <div class="pillar-card">
                <div class="pillar-icon">&#9729;&#65039;</div>
                <div class="pillar-name">Cloud</div>
                <div class="pillar-vendors">Microsoft 365 &middot; Azure &middot; AWS</div>
                <div class="pillar-services">Licensing, migration, management</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#128187;</div>
                <div class="pillar-name">Virtualization</div>
                <div class="pillar-vendors">Azure Local &middot; VMware &middot; Nutanix</div>
                <div class="pillar-services">HCI, private cloud, VDI</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#128421;&#65039;</div>
                <div class="pillar-name">Infrastructure</div>
                <div class="pillar-vendors">Dell &middot; HPE &middot; Lenovo</div>
                <div class="pillar-services">Servers, storage, compute</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#128190;</div>
                <div class="pillar-name">Endpoint</div>
                <div class="pillar-vendors">Dell &middot; HP &middot; Lenovo</div>
                <div class="pillar-services">Laptops, desktops, thin clients</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#128274;</div>
                <div class="pillar-name">Security</div>
                <div class="pillar-vendors">Darktrace &middot; Netskope &middot; Fortinet &middot; Palo Alto &middot; Arctic Wolf</div>
                <div class="pillar-services">SASE, EDR/XDR, SOC, firewall</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#128737;&#65039;</div>
                <div class="pillar-name">Data Protection</div>
                <div class="pillar-vendors">Veeam &middot; Zerto &middot; Backupify</div>
                <div class="pillar-services">Backup, DR, replication</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#128424;</div>
                <div class="pillar-name">Print & Document Mgmt</div>
                <div class="pillar-vendors">Xerox &middot; M-Files</div>
                <div class="pillar-services">MPS, ECM, document workflows</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#127760;</div>
                <div class="pillar-name">Network</div>
                <div class="pillar-vendors">HPE Aruba &middot; Cisco &middot; Extreme &middot; Juniper</div>
                <div class="pillar-services">Switching, wireless, SD-WAN</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#129302;</div>
                <div class="pillar-name">AI</div>
                <div class="pillar-vendors">Microsoft Copilot &middot; Xerox AI</div>
                <div class="pillar-services">AI adoption, automation, workshops</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#128736;&#65039;</div>
                <div class="pillar-name">Managed IT Services</div>
                <div class="pillar-vendors">NOC/SOC &middot; MDR/EDR/XDR &middot; Helpdesk</div>
                <div class="pillar-services">Remote monitoring, MPS, service desk</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#128295;</div>
                <div class="pillar-name">IT Professional Services</div>
                <div class="pillar-vendors">Design &middot; Architecture &middot; Implementation</div>
                <div class="pillar-services">Cloud migration, data center, wireless</div>
            </div>
            <div class="pillar-card">
                <div class="pillar-icon">&#128230;</div>
                <div class="pillar-name">IT Support Services</div>
                <div class="pillar-vendors">Install &middot; Imaging &middot; Depot &middot; Warranty</div>
                <div class="pillar-services">Asset mgmt, disposal, Xerox CareGPS</div>
            </div>
        </div>

        <div class="sec-header"><h2>Powerland WebStore</h2><p>On-premise hardware procurement through Powerland's e-commerce platform.</p></div>
        <div class="panel">
            <div class="panel-title">Data Center & Co-Location</div>
            <p style="font-size:13px;color:var(--text2);">Full data center solutions including co-location services. Dell, HPE, and Lenovo infrastructure available through Powerland WebStore for on-premise deployments. Hewlett Packard Enterprise on-premise and co-location options.</p>
        </div>

        <div class="sec-header" style="margin-top:32px;">
            <h2>Whitespace Heatmap</h2>
            <p>Cross-account view: which pillars are active vs untapped? Higher whitespace % = more opportunity.</p>
        </div>
        <div class="whitespace-controls">
            <select id="wsFilter" onchange="renderWhitespaceHeatmap()">
                <option value="all">All Accounts</option>
                <option value="ent">Enterprise Only</option>
                <option value="smb">SMB Only</option>
                <option value="active">Active Deals Only</option>
            </select>
            <select id="wsSort" onchange="renderWhitespaceHeatmap()">
                <option value="whitespace">Sort: Most Whitespace</option>
                <option value="name">Sort: Name A-Z</option>
                <option value="value">Sort: Deal Value</option>
            </select>
            <input id="wsSearch" placeholder="Search accounts..." oninput="renderWhitespaceHeatmap()">
        </div>
        <div class="ws-summary" id="wsSummary"></div>
        <div class="whitespace-wrap">
            <div id="whitespaceTable"></div>
        </div>
    </div>
</div>

<!-- ==================== TERRITORY MAP ==================== -->
<div id="territory" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>Saskatchewan Territory Map</h2>
            <p>Geographic view of all accounts. Color = deal status. Size = deal value.</p>
        </div>
        <div class="map-controls">
            <select id="mapFilter" onchange="updateMapPins()">
                <option value="all">All Accounts</option>
                <option value="ent">Enterprise Only</option>
                <option value="smb">SMB Only</option>
                <option value="active">Active Deals Only</option>
                <option value="atrisk">At Risk Only</option>
            </select>
            <select id="mapSector" onchange="updateMapPins()">
                <option value="">All Sectors</option>
            </select>
            <select id="mapColor" onchange="updateMapPins()">
                <option value="status">Color: Deal Status</option>
                <option value="priority">Color: Priority</option>
                <option value="health">Color: Health Score</option>
            </select>
        </div>
        <div class="map-legend" id="mapLegend"></div>
        <div class="map-stats" id="mapStats"></div>
        <div class="map-container" id="territoryMap"></div>
    </div>
</div>

<!-- ==================== PLAYBOOK ==================== -->
<div id="playbook" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>Sales Playbook</h2>
            <p>Plays, discovery questions, competitive intel, and templates aligned to Powerland's 12 pillars.</p>
        </div>

        <div class="section-tabs" id="playbookTabs">
            <button class="section-tab active" data-sec="pb-plays">Sales Plays</button>
            <button class="section-tab" data-sec="pb-discovery">Discovery Questions</button>
            <button class="section-tab" data-sec="pb-battle">Battle Cards</button>
            <button class="section-tab" data-sec="pb-emails">Email Templates</button>
            <button class="section-tab" data-sec="pb-objections">Objection Handlers</button>
        </div>

        <!-- SALES PLAYS -->
        <div id="pb-plays" class="section-content active">
            <div class="play-grid">
                <div class="play-card">
                    <h3>Managed IT Services</h3>
                    <p>The anchor deal. NOC/SOC, helpdesk, remote monitoring, MDR/EDR/XDR. Recurring MRR that compounds. Target orgs with 50-500 seats who have a small internal IT team drowning in tickets.</p>
                    <div class="play-example"><strong>Open:</strong> "How many people are on your IT team vs how many endpoints you support? Most orgs we talk to are running at a 1:150+ ratio â€” that's where things fall through the cracks. We augment, not replace."</div>
                </div>
                <div class="play-card">
                    <h3>Microsoft CSP / Cloud Licensing</h3>
                    <p>Become their M365 partner of record. Free license audit finds savings, then you own the renewal. E3â†’E5 upsells, Copilot add-ons, Azure consumption. Sticky annual recurring revenue.</p>
                    <div class="play-example"><strong>Open:</strong> "Who manages your Microsoft licensing today? We're finding most SK orgs are either overpaying or under-licensed. 30-minute audit, no cost â€” we usually find 15-20% savings."</div>
                </div>
                <div class="play-card">
                    <h3>Hardware Refresh â€” Infrastructure</h3>
                    <p>Dell, HPE, Lenovo servers, storage, compute. 3-5 year refresh cycles are predictable revenue. Time outreach to budget cycles. Government = April, Schools = September, CUs = January.</p>
                    <div class="play-example"><strong>Open:</strong> "When was your last server refresh? If your infrastructure is 4+ years old, you're likely spending more on maintenance than a new solution would cost â€” and you're at higher risk of downtime."</div>
                </div>
                <div class="play-card">
                    <h3>Security Stack</h3>
                    <p>Darktrace, Netskope, Fortinet, Palo Alto, Arctic Wolf. Lead with a free security posture assessment. Every board and exec team is worried about ransomware. Fear sells. Insurance companies are mandating better security.</p>
                    <div class="play-example"><strong>Open:</strong> "Has your cyber insurance provider increased your premiums or added requirements this year? We do a free security posture review â€” most orgs we assess in SK have 3-5 critical gaps."</div>
                </div>
                <div class="play-card">
                    <h3>Backup & Disaster Recovery</h3>
                    <p>Veeam, Zerto, Backupify. Ask when they last tested a restore. Most haven't. DR plans that haven't been tested are just documents. Compliance requirements (especially health, finance, government) are your leverage.</p>
                    <div class="play-example"><strong>Open:</strong> "If ransomware hit tonight â€” and it's not if, it's when â€” what's your recovery time? We can get you to a 15-minute RPO and 1-hour RTO. Can I show you how?"</div>
                </div>
                <div class="play-card">
                    <h3>Network Infrastructure</h3>
                    <p>HPE Aruba, Cisco, Extreme, Juniper. Switching, wireless, SD-WAN. Schools and hospitals are big wireless buyers. Wi-Fi 6E/7 refresh cycles are happening now. Campus-wide deployments are $50K-$300K.</p>
                    <div class="play-example"><strong>Open:</strong> "How old is your wireless infrastructure? With remote work and BYOD, most orgs are running 3x the devices they had 5 years ago on the same network. We do free wireless assessments."</div>
                </div>
                <div class="play-card">
                    <h3>Endpoint / Hardware â€” Desktops & Laptops</h3>
                    <p>Dell, HP, Lenovo. Volume endpoint deals for school divisions (1:1 programs), government fleets, enterprise refreshes. Pair with Managed IT for deployment, imaging, and lifecycle management.</p>
                    <div class="play-example"><strong>Open:</strong> "How are you handling your next device refresh? We can bundle procurement, imaging, deployment, and lifecycle management into a single per-device cost â€” no surprises."</div>
                </div>
                <div class="play-card">
                    <h3>Print & Document Management (Bridge to IT)</h3>
                    <p>Your Xerox heritage opens the door. MPS, M-Files ECM, document workflows. But the real play is bridging to the full IT stack. Every print conversation should map the network and security posture.</p>
                    <div class="play-example"><strong>Bridge:</strong> "While we're looking at your print fleet, I noticed you're running some older switches and your firewall is end-of-life. Would it be helpful if our team did a quick network and security review while we're here?"</div>
                </div>
                <div class="play-card">
                    <h3>AI & Copilot Workshops</h3>
                    <p>Microsoft Copilot is the hottest conversation in every boardroom. Offer free 2-hour workshops. Requires E5 or Copilot add-on licenses â€” ties directly to CSP revenue. Low commitment, high perceived value.</p>
                    <div class="play-example"><strong>Open:</strong> "Every exec I talk to wants AI but nobody knows where to start. We run a 2-hour Copilot readiness workshop â€” your team walks away with a real adoption plan. No cost."</div>
                </div>
                <div class="play-card">
                    <h3>RFP Response Strategy</h3>
                    <p>Government and education buy through RFPs. Get on vendor lists early. Build relationships BEFORE the RFP drops â€” by the time it's public, the winner is usually already chosen. Use assessments to shape the spec.</p>
                    <div class="play-example"><strong>Strategy:</strong> Offer free assessments 6-12 months before expected RFP. Your findings become the basis for the spec. If you shape the requirements, you win the deal. Track contract expiry dates religiously.</div>
                </div>
                <div class="play-card">
                    <h3>Software Renewals & True-ups</h3>
                    <p>Every org has software renewals hitting every month. Microsoft EA/CSP, VMware, Veeam, Fortinet, etc. Become the single point of contact for all renewals. Once you own the renewal, you own the relationship.</p>
                    <div class="play-example"><strong>Open:</strong> "How many different vendors are you managing renewals with? We consolidate everything â€” licensing, support, renewals â€” into one relationship. One invoice, one throat to choke, better pricing."</div>
                </div>
                <div class="play-card">
                    <h3>Virtualization & Cloud Migration</h3>
                    <p>Azure Local, VMware, Nutanix. The VMwareâ†’Broadcom pricing change is driving migrations. Orgs on VMware are looking for alternatives NOW. Azure Local and Nutanix are hot alternatives.</p>
                    <div class="play-example"><strong>Open:</strong> "Have your VMware costs gone up since the Broadcom acquisition? We're helping a lot of SK orgs evaluate Azure Local and Nutanix â€” we can run a side-by-side cost analysis for free."</div>
                </div>
            </div>
        </div>

        <!-- DISCOVERY QUESTIONS -->
        <div id="pb-discovery" class="section-content">
            <p style="font-size:12px;color:var(--text3);margin-bottom:14px;">Click any category to expand. Use these during first meetings to uncover opportunities across all pillars.</p>

            <div class="q-group" onclick="this.classList.toggle('open')">
                <div class="q-group-header"><span class="q-icon">&#128736;</span><span class="q-title">General IT Landscape</span><span class="q-toggle">&#9654;</span></div>
                <div class="q-body">
                    <div class="q-item">How many total employees / endpoints are you supporting?</div>
                    <div class="q-item">What does your IT team look like? How many people?</div>
                    <div class="q-item">What's your biggest IT pain point right now?</div>
                    <div class="q-item">What does your IT budget cycle look like? When do you plan for next year?</div>
                    <div class="q-item">Are you working with any IT partners or VARs today? Who?</div>
                    <div class="q-item">Any major IT projects planned in the next 6-12 months?</div>
                    <div class="q-item">Who makes the final decision on IT purchases?</div>
                </div>
            </div>

            <div class="q-group" onclick="this.classList.toggle('open')">
                <div class="q-group-header"><span class="q-icon">&#9729;</span><span class="q-title">Cloud & Microsoft 365</span><span class="q-toggle">&#9654;</span></div>
                <div class="q-body">
                    <div class="q-item">What Microsoft licenses are you on today? E1/E3/E5/Business?</div>
                    <div class="q-item">Who is your Microsoft CSP partner (or are you buying direct)?</div>
                    <div class="q-item">When is your Microsoft agreement up for renewal?</div>
                    <div class="q-item">Are you using Teams, SharePoint, OneDrive fully â€” or just email?</div>
                    <div class="q-item">Have you looked at Copilot? Any interest in AI productivity tools?</div>
                    <div class="q-item">Any cloud workloads on Azure or AWS today?</div>
                    <div class="q-item">What's your current on-prem vs cloud split?</div>
                </div>
            </div>

            <div class="q-group" onclick="this.classList.toggle('open')">
                <div class="q-group-header"><span class="q-icon">&#128274;</span><span class="q-title">Security</span><span class="q-toggle">&#9654;</span></div>
                <div class="q-body">
                    <div class="q-item">What does your security stack look like today? Firewall? EDR? SIEM?</div>
                    <div class="q-item">Do you have a SOC or managed detection & response service?</div>
                    <div class="q-item">When was your last security assessment or pen test?</div>
                    <div class="q-item">Has your cyber insurance provider changed requirements recently?</div>
                    <div class="q-item">Have you had any security incidents in the past 12 months?</div>
                    <div class="q-item">How are you handling employee security awareness training?</div>
                    <div class="q-item">What's your patch management process look like?</div>
                </div>
            </div>

            <div class="q-group" onclick="this.classList.toggle('open')">
                <div class="q-group-header"><span class="q-icon">&#128737;</span><span class="q-title">Backup & Disaster Recovery</span><span class="q-toggle">&#9654;</span></div>
                <div class="q-body">
                    <div class="q-item">What's your current backup solution?</div>
                    <div class="q-item">When was the last time you tested a full restore?</div>
                    <div class="q-item">What's your RPO and RTO today? Is that documented?</div>
                    <div class="q-item">Do you have an offsite or cloud backup copy?</div>
                    <div class="q-item">Are you backing up M365 (Exchange, SharePoint, Teams)?</div>
                    <div class="q-item">Do you have a documented DR plan? Has it been tested?</div>
                </div>
            </div>

            <div class="q-group" onclick="this.classList.toggle('open')">
                <div class="q-group-header"><span class="q-icon">&#128421;</span><span class="q-title">Infrastructure & Hardware</span><span class="q-toggle">&#9654;</span></div>
                <div class="q-body">
                    <div class="q-item">How old is your server and storage infrastructure?</div>
                    <div class="q-item">Are you running Dell, HPE, Lenovo, or other?</div>
                    <div class="q-item">Any servers approaching end-of-support or warranty expiry?</div>
                    <div class="q-item">What does your desktop/laptop fleet look like? Age? OS?</div>
                    <div class="q-item">Are you running any HCI (hyper-converged) today?</div>
                    <div class="q-item">Do you have a hardware lifecycle / refresh plan?</div>
                </div>
            </div>

            <div class="q-group" onclick="this.classList.toggle('open')">
                <div class="q-group-header"><span class="q-icon">&#127760;</span><span class="q-title">Network</span><span class="q-toggle">&#9654;</span></div>
                <div class="q-body">
                    <div class="q-item">What switching and wireless vendors are you running?</div>
                    <div class="q-item">How old is your wireless infrastructure?</div>
                    <div class="q-item">Are you doing SD-WAN or traditional WAN?</div>
                    <div class="q-item">How many locations are you connecting?</div>
                    <div class="q-item">Any issues with Wi-Fi capacity or coverage?</div>
                    <div class="q-item">Who manages your network today â€” internal or outsourced?</div>
                </div>
            </div>

            <div class="q-group" onclick="this.classList.toggle('open')">
                <div class="q-group-header"><span class="q-icon">&#128424;</span><span class="q-title">Print & Document Management</span><span class="q-toggle">&#9654;</span></div>
                <div class="q-body">
                    <div class="q-item">How many printers/MFPs are in your fleet?</div>
                    <div class="q-item">Who's your current print vendor? When does the contract expire?</div>
                    <div class="q-item">Are you on a managed print services agreement or buying ad hoc?</div>
                    <div class="q-item">How are you managing document workflows â€” scanning, archiving, compliance?</div>
                    <div class="q-item">Have you looked at document management systems like M-Files?</div>
                </div>
            </div>

            <div class="q-group" onclick="this.classList.toggle('open')">
                <div class="q-group-header"><span class="q-icon">&#128176;</span><span class="q-title">Budget & Decision Making</span><span class="q-toggle">&#9654;</span></div>
                <div class="q-body">
                    <div class="q-item">What does your IT budget look like for this fiscal year?</div>
                    <div class="q-item">Is there a formal procurement process or RFP requirement?</div>
                    <div class="q-item">Who are the key stakeholders involved in IT decisions?</div>
                    <div class="q-item">Do you prefer CapEx purchases or OpEx/monthly billing?</div>
                    <div class="q-item">Are there any compliance or regulatory requirements driving IT spend?</div>
                    <div class="q-item">What would make this a "must do now" vs "nice to have next year"?</div>
                </div>
            </div>
        </div>

        <!-- BATTLE CARDS -->
        <div id="pb-battle" class="section-content">
            <p style="font-size:12px;color:var(--text3);margin-bottom:14px;">Competitive intelligence for the main SK competitors. Use to position against and counter.</p>

            <div class="battle-card">
                <h3 style="color:var(--accent3);">WBM Technologies</h3>
                <div class="battle-row">
                    <div class="battle-col strengths">
                        <h4>Their Strengths</h4>
                        <ul>
                            <li>Strong SK presence, offices in Regina & Saskatoon</li>
                            <li>Long-standing government relationships</li>
                            <li>Full IT services stack (managed, cloud, hardware)</li>
                            <li>Dell & HP partner</li>
                            <li>Good reputation in education</li>
                        </ul>
                    </div>
                    <div class="battle-col weaknesses">
                        <h4>Where We Win</h4>
                        <ul>
                            <li>We have Xerox print relationship as door opener they don't</li>
                            <li>Broader vendor portfolio (Darktrace, Arctic Wolf, Nutanix)</li>
                            <li>Powerland national scale = better pricing on Dell/HPE/Lenovo</li>
                            <li>Microsoft CSP competency â€” aggressive M365 pricing</li>
                            <li>AI/Copilot workshops â€” they lack this capability</li>
                        </ul>
                    </div>
                </div>
                <div class="battle-counter"><strong>Counter play:</strong><p>Don't compete head-to-head on what WBM does well. Anchor on security (Darktrace/Arctic Wolf), Copilot workshops, and M365 licensing savings. Be the "fresh perspective" â€” many accounts are fatigued with WBM.</p></div>
            </div>

            <div class="battle-card">
                <h3 style="color:var(--accent3);">Horizon Computer Solutions</h3>
                <div class="battle-row">
                    <div class="battle-col strengths">
                        <h4>Their Strengths</h4>
                        <ul>
                            <li>Established SK IT provider with strong local roots</li>
                            <li>Good relationships in mid-market and government</li>
                            <li>Managed IT and cloud services offering</li>
                            <li>Responsive local support team</li>
                        </ul>
                    </div>
                    <div class="battle-col weaknesses">
                        <h4>Where We Win</h4>
                        <ul>
                            <li>Powerland national scale = deeper vendor pricing (Dell/HPE/Lenovo)</li>
                            <li>Broader security portfolio (Darktrace, Arctic Wolf)</li>
                            <li>Microsoft CSP competency â€” aggressive M365 licensing</li>
                            <li>AI/Copilot workshops they can't match</li>
                            <li>Xerox print relationship as additional door opener</li>
                        </ul>
                    </div>
                </div>
                <div class="battle-counter"><strong>Counter play:</strong><p>Horizon is solid but lacks the vendor depth and national pricing we bring. Lead with security stack (Darktrace/Arctic Wolf) and M365 savings â€” two areas where our scale creates real dollar gaps. Position Copilot workshops as the forward-looking differentiator.</p></div>
            </div>

            <div class="battle-card">
                <h3 style="color:var(--accent3);">PC Place</h3>
                <div class="battle-row">
                    <div class="battle-col strengths">
                        <h4>Their Strengths</h4>
                        <ul>
                            <li>Well-known retail + business IT in Saskatchewan</li>
                            <li>Strong hardware resale and device deployment</li>
                            <li>Quick-turn local service for SMB</li>
                            <li>Trusted by smaller orgs for break/fix</li>
                        </ul>
                    </div>
                    <div class="battle-col weaknesses">
                        <h4>Where We Win</h4>
                        <ul>
                            <li>Limited managed services depth â€” mostly hardware-focused</li>
                            <li>No enterprise security stack (no SOC, no SIEM)</li>
                            <li>Can't match our cloud and GreenLake as-a-Service model</li>
                            <li>No M365 CSP competency at scale</li>
                            <li>We offer full lifecycle â€” they sell boxes</li>
                        </ul>
                    </div>
                </div>
                <div class="battle-counter"><strong>Counter play:</strong><p>PC Place wins on quick hardware sales to SMB. Position against them by leading with managed services and security â€” show the account they're buying hardware but have no monitoring, no backup strategy, no security layer. "Who's watching your network at 2 AM?"</p></div>
            </div>

            <div class="battle-card">
                <h3 style="color:var(--accent3);">Wolf Strata</h3>
                <div class="battle-row">
                    <div class="battle-col strengths">
                        <h4>Their Strengths</h4>
                        <ul>
                            <li>Focused managed IT and cloud consultancy</li>
                            <li>Good technical depth in Azure/M365 environments</li>
                            <li>Consultative approach resonates with mid-market</li>
                            <li>Growing reputation in SK IT community</li>
                        </ul>
                    </div>
                    <div class="battle-col weaknesses">
                        <h4>Where We Win</h4>
                        <ul>
                            <li>Smaller operation â€” can't match Powerland's bench depth</li>
                            <li>Limited hardware procurement scale</li>
                            <li>Narrower vendor portfolio â€” we bring Darktrace, Arctic Wolf, Nutanix, HPE</li>
                            <li>No print relationship to cross-sell from</li>
                            <li>We offer GreenLake as-a-Service â€” they can't</li>
                        </ul>
                    </div>
                </div>
                <div class="battle-counter"><strong>Counter play:</strong><p>Wolf Strata competes on consultative cloud/M365 â€” don't fight them there alone. Bundle hardware + security + managed services to show total value. Our edge is the full stack: "one partner for everything" vs their niche play.</p></div>
            </div>

            <div class="battle-card">
                <h3 style="color:var(--accent3);">Compugen</h3>
                <div class="battle-row">
                    <div class="battle-col strengths">
                        <h4>Their Strengths</h4>
                        <ul>
                            <li>National scale â€” large Canadian IT solutions provider</li>
                            <li>Strong enterprise and government contracts</li>
                            <li>Deep vendor partnerships (HP, Cisco, Microsoft)</li>
                            <li>Professional services and deployment capability</li>
                        </ul>
                    </div>
                    <div class="battle-col weaknesses">
                        <h4>Where We Win</h4>
                        <ul>
                            <li>Compugen is national â€” we have boots on the ground in SK</li>
                            <li>Local relationships and faster response times</li>
                            <li>More flexible and agile for mid-market deals</li>
                            <li>Xerox print footprint gives us a warm intro they don't have</li>
                            <li>AI/Copilot workshops â€” we're proactive, they're reactive</li>
                        </ul>
                    </div>
                </div>
                <div class="battle-counter"><strong>Counter play:</strong><p>Compugen wins big enterprise deals on scale. Beat them by being local and fast â€” "we're in Regina, not Toronto." Mid-market accounts want a partner who picks up the phone, not a ticket queue. Leverage existing Xerox relationships they can't touch.</p></div>
            </div>

            <div class="battle-card">
                <h3 style="color:var(--accent3);">Internal IT / "We Handle It Ourselves"</h3>
                <div class="battle-row">
                    <div class="battle-col strengths">
                        <h4>Their Argument</h4>
                        <ul>
                            <li>"We know our environment best"</li>
                            <li>"We don't want to lose control"</li>
                            <li>"We've always done it this way"</li>
                            <li>Cost perception â€” think outsourcing is more expensive</li>
                        </ul>
                    </div>
                    <div class="battle-col weaknesses">
                        <h4>Where We Win</h4>
                        <ul>
                            <li>Augment, don't replace â€” we make their team better</li>
                            <li>24/7 SOC they can't afford to staff</li>
                            <li>Better vendor pricing through Powerland volume</li>
                            <li>Skills gap â€” one IT person can't know security + cloud + networking</li>
                            <li>Risk reduction â€” what happens when their IT person quits?</li>
                        </ul>
                    </div>
                </div>
                <div class="battle-counter"><strong>Counter play:</strong><p>"We augment your team, not replace them. Your IT person becomes the hero who brought in enterprise-grade security and 24/7 monitoring. And if they ever leave, you're not dead in the water."</p></div>
            </div>
        </div>

        <!-- EMAIL TEMPLATES -->
        <div id="pb-emails" class="section-content">
            <div class="email-tpl">
                <h3>Cold Outreach â€” IT Assessment</h3>
                <div class="email-subject">Subject: Quick IT health check for [Company] â€” no cost</div>
                <div class="email-body">Hi [First Name],

I'm Mike Bernhardt with Xerox IT Solutions (Powerland) â€” we work with a number of organizations in Saskatchewan on their full IT stack: security, cloud, infrastructure, and managed services.

I noticed [Company] would be a great fit for our complimentary IT assessment. We typically uncover 3-5 areas where organizations are either overspending or carrying unnecessary risk.

Takes about 30 minutes and there's no obligation. Would you be open to a quick conversation this week or next?

Best,
Mike Bernhardt
Sr Account Executive | Xerox IT Solutions
[phone] | [email]</div>
                <button class="copy-btn" onclick="copyEmail(this)">Copy to clipboard</button>
            </div>

            <div class="email-tpl">
                <h3>Cold Outreach â€” M365 License Savings</h3>
                <div class="email-subject">Subject: Are you overpaying for Microsoft 365? (Most SK orgs are)</div>
                <div class="email-body">Hi [First Name],

Quick question â€” when was the last time someone audited your Microsoft 365 licensing?

We're finding that 8 out of 10 organizations in Saskatchewan are either on the wrong plan, have unused licenses, or are missing features they're already paying for.

We do a free 30-minute licensing audit. Most orgs save 15-20%. Worst case, you confirm you're in good shape.

Worth a quick call?

Mike Bernhardt
Sr Account Executive | Xerox IT Solutions
[phone] | [email]</div>
                <button class="copy-btn" onclick="copyEmail(this)">Copy to clipboard</button>
            </div>

            <div class="email-tpl">
                <h3>Cold Outreach â€” Security Assessment</h3>
                <div class="email-subject">Subject: Has [Company]'s cyber insurance gone up this year?</div>
                <div class="email-body">Hi [First Name],

Insurance providers across Canada are tightening cybersecurity requirements â€” and premiums are going up for orgs that can't demonstrate proper controls.

We're offering a complimentary security posture review for Saskatchewan organizations. It takes about an hour, and we assess your environment against the frameworks insurance companies are looking for (MFA, EDR, backup, network segmentation).

Most orgs we assess find 3-5 gaps. Would it be worth 20 minutes to discuss?

Mike Bernhardt
Sr Account Executive | Xerox IT Solutions
[phone] | [email]</div>
                <button class="copy-btn" onclick="copyEmail(this)">Copy to clipboard</button>
            </div>

            <div class="email-tpl">
                <h3>Follow-Up After Meeting</h3>
                <div class="email-subject">Subject: Great connecting â€” next steps for [Company]</div>
                <div class="email-body">Hi [First Name],

Thanks for taking the time today. I enjoyed learning about [Company]'s IT environment and the challenges you're facing with [specific pain point discussed].

As discussed, here's what I'm going to do next:
- [Action item 1]
- [Action item 2]
- [Action item 3]

I'll have [deliverable] to you by [date]. In the meantime, if anything comes up, don't hesitate to reach out.

Looking forward to working together.

Mike Bernhardt
Sr Account Executive | Xerox IT Solutions
[phone] | [email]</div>
                <button class="copy-btn" onclick="copyEmail(this)">Copy to clipboard</button>
            </div>

            <div class="email-tpl">
                <h3>Re-Engagement â€” Contract Expiry</h3>
                <div class="email-subject">Subject: Your [Vendor] contract is coming up â€” options?</div>
                <div class="email-body">Hi [First Name],

I understand your current [IT/print/security] agreement with [incumbent vendor] is coming up for renewal around [timeframe].

Before you auto-renew, it might be worth seeing what else is available. Technology moves fast, and pricing has changed significantly in the last few years.

We can put together a comparison in a couple of days â€” no pressure, just so you have options on the table. Would that be helpful?

Mike Bernhardt
Sr Account Executive | Xerox IT Solutions
[phone] | [email]</div>
                <button class="copy-btn" onclick="copyEmail(this)">Copy to clipboard</button>
            </div>
        </div>

        <!-- OBJECTION HANDLERS -->
        <div id="pb-objections" class="section-content">
            <div class="play-grid">
                <div class="play-card">
                    <h3>"We already have a vendor"</h3>
                    <p>"Totally understand. We're not here to replace what's working. We do a complimentary assessment that often finds savings your current vendor hasn't surfaced. Worst case you validate you're in good shape. Best case you save money. Either way you win."</p>
                </div>
                <div class="play-card">
                    <h3>"We're locked into a contract"</h3>
                    <p>"When does it come up? The best outcomes happen when we start the conversation 6-12 months before expiry. That way you're not rushed into a renewal. Can I put a reminder to reach out in [month]?"</p>
                </div>
                <div class="play-card">
                    <h3>"Our IT team handles everything"</h3>
                    <p>"That's actually our sweet spot. We don't replace IT teams â€” we give them leverage. A 24/7 SOC, vendor management, escalation support. Most IT directors tell us they got 30% of their week back to focus on strategic projects."</p>
                </div>
                <div class="play-card">
                    <h3>"Xerox? You guys just do printers"</h3>
                    <p>"I get that a lot â€” and honestly, that's the old Xerox. Through Powerland, we now deliver the full IT stack: security with Darktrace and Arctic Wolf, cloud with Microsoft, infrastructure with Dell and HPE, managed services. Same trusted relationship, 10x the capability."</p>
                </div>
                <div class="play-card">
                    <h3>"We don't have budget right now"</h3>
                    <p>"Totally fair. Two things though â€” the M365 audit and security assessment are free, so no budget needed. And if we do find savings, that often funds the next project. When does your next budget cycle start? Let's plan for that."</p>
                </div>
                <div class="play-card">
                    <h3>"Send me some info"</h3>
                    <p>"Happy to â€” but honestly, a generic brochure won't help. If I can ask just 2-3 questions, I can send you something actually relevant to [Company]. What's your biggest IT headache right now?"</p>
                </div>
                <div class="play-card">
                    <h3>"We went through an RFP recently"</h3>
                    <p>"Good to know â€” when does that agreement come up? I'd love to be on your radar for the next cycle. In the meantime, we could do a complementary assessment in an area your current vendor doesn't cover â€” like security or M365 optimization."</p>
                </div>
                <div class="play-card">
                    <h3>"We're too small for that"</h3>
                    <p>"Actually, that's exactly why managed services make sense. You can't afford a full IT team â€” but you can afford enterprise-grade IT at a per-seat cost. Our sweet spot is 50-500 seats."</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== TOOLS ==================== -->
<div id="tools" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>Revenue Calculator & Tools</h2>
            <p>Deal sizing, quota tracking, activity planning, and territory intelligence.</p>
        </div>

        <div class="section-tabs" id="toolsTabs">
            <button class="section-tab active" data-sec="t-quota">Quota Math</button>
            <button class="section-tab" data-sec="t-dealcalc">Deal Calculator</button>
            <button class="section-tab" data-sec="t-activity">Activity Targets</button>
            <button class="section-tab" data-sec="t-calendar">SK Calendar</button>
            <button class="section-tab" data-sec="t-notes">Quick Notes</button>
        </div>

        <!-- QUOTA MATH -->
        <div id="t-quota" class="section-content active">
            <div class="calc-grid">
                <div class="calc-panel">
                    <h3>Quota Math â€” $3M FY2026</h3>
                    <div class="calc-row"><span class="calc-label">Annual Target</span><span class="calc-val">$3,000,000</span></div>
                    <div class="calc-row"><span class="calc-label">Closed YTD</span><span class="calc-val" style="color:var(--accent2);">$24,000</span></div>
                    <div class="calc-row"><span class="calc-label">Remaining</span><span class="calc-val">$2,976,000</span></div>
                    <div class="calc-row"><span class="calc-label">Monthly Target (remaining)</span><span class="calc-val" id="calcMonthly">$271K</span></div>
                    <div class="calc-row"><span class="calc-label">Quarterly Target</span><span class="calc-val">$750,000</span></div>
                    <div class="calc-row"><span class="calc-label">Daily Revenue Target</span><span class="calc-val">$12,000</span></div>
                    <div class="calc-row"><span class="calc-label">3x Pipeline Needed</span><span class="calc-val" style="color:var(--accent3);">$9,000,000</span></div>
                </div>
                <div class="calc-panel">
                    <h3>Deal Sizing Guide</h3>
                    <div class="calc-row"><span class="calc-label">Hardware â€” Servers & Storage</span><span class="calc-val">$50Kâ€“$500K</span></div>
                    <div class="calc-row"><span class="calc-label">Endpoint Devices (100+ seats)</span><span class="calc-val">$80Kâ€“$250K</span></div>
                    <div class="calc-row"><span class="calc-label">Microsoft 365 CSP (100 users)</span><span class="calc-val">$40Kâ€“$80K/yr</span></div>
                    <div class="calc-row"><span class="calc-label">Managed IT Services (50 seats)</span><span class="calc-val">$60Kâ€“$120K/yr</span></div>
                    <div class="calc-row"><span class="calc-label">Managed IT Services (200+)</span><span class="calc-val">$200Kâ€“$500K/yr</span></div>
                    <div class="calc-row"><span class="calc-label">HPE GreenLake (as-a-Service)</span><span class="calc-val">$100Kâ€“$1M+/yr</span></div>
                    <div class="calc-row"><span class="calc-label">Security Stack</span><span class="calc-val">$30Kâ€“$150K/yr</span></div>
                    <div class="calc-row"><span class="calc-label">Software Renewals / Licensing</span><span class="calc-val">$20Kâ€“$200K/yr</span></div>
                    <div class="calc-row"><span class="calc-label">Full IT Stack â€” Enterprise</span><span class="calc-val">$300Kâ€“$1.5M+</span></div>
                </div>
            </div>
        </div>

        <!-- DEAL CALCULATOR -->
        <div id="t-dealcalc" class="section-content">
            <div class="calc-grid">
                <div class="calc-panel">
                    <h3>Build a Deal</h3>
                    <div class="deal-label">Account Name</div>
                    <input class="deal-input" id="dc-name" placeholder="e.g. Government of Saskatchewan">
                    <div class="deal-label">Managed IT (monthly per seat)</div>
                    <input class="deal-input" type="number" id="dc-mit-price" placeholder="$100" value="">
                    <div class="deal-label">Number of Seats</div>
                    <input class="deal-input" type="number" id="dc-seats" placeholder="200" value="">
                    <div class="deal-label">M365 CSP (monthly per user)</div>
                    <input class="deal-input" type="number" id="dc-csp" placeholder="$36" value="">
                    <div class="deal-label">Security Stack (annual)</div>
                    <input class="deal-input" type="number" id="dc-security" placeholder="$50000" value="">
                    <div class="deal-label">Hardware / Infrastructure (one-time)</div>
                    <input class="deal-input" type="number" id="dc-hw" placeholder="$100000" value="">
                    <div class="deal-label">GreenLake / as-a-Service (monthly)</div>
                    <input class="deal-input" type="number" id="dc-mps" placeholder="$5000" value="">
                    <div class="deal-label">Other Annual Revenue</div>
                    <input class="deal-input" type="number" id="dc-other" placeholder="$0" value="">
                    <button class="copy-btn" style="margin-top:12px;padding:10px 20px;font-size:13px;" onclick="calcDeal()">Calculate Deal</button>
                </div>
                <div class="calc-panel">
                    <h3>Deal Summary</h3>
                    <div id="dealResult">
                        <p style="color:var(--text3);font-size:12px;">Fill in the fields and click Calculate to see deal value breakdown.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACTIVITY TARGETS -->
        <div id="t-activity" class="section-content">
            <div class="calc-grid">
                <div class="calc-panel">
                    <h3>Weekly Activity Targets</h3>
                    <div class="calc-row"><span class="calc-label">Outbound Calls</span><span class="calc-val">30â€“40</span></div>
                    <div class="calc-row"><span class="calc-label">Emails Sent</span><span class="calc-val">15â€“20</span></div>
                    <div class="calc-row"><span class="calc-label">Discovery Meetings</span><span class="calc-val">4â€“6</span></div>
                    <div class="calc-row"><span class="calc-label">Proposals Sent</span><span class="calc-val">2â€“3</span></div>
                    <div class="calc-row"><span class="calc-label">LinkedIn Touches</span><span class="calc-val">10â€“15</span></div>
                    <div class="calc-row"><span class="calc-label">Account Plans / Week</span><span class="calc-val">1â€“2</span></div>
                    <div class="calc-row"><span class="calc-label">Follow-Up Touches</span><span class="calc-val">15â€“20</span></div>
                </div>
                <div class="calc-panel">
                    <h3>SK Territory Key Stats</h3>
                    <div class="calc-row"><span class="calc-label">Province Population</span><span class="calc-val">~1.2M</span></div>
                    <div class="calc-row"><span class="calc-label">Major Cities</span><span class="calc-val">Saskatoon, Regina, PA, MJ</span></div>
                    <div class="calc-row"><span class="calc-label">Top Industries</span><span class="calc-val">Ag, Mining, Govt, Energy</span></div>
                    <div class="calc-row"><span class="calc-label">Key Competitors</span><span class="calc-val">WBM, KM, Toshiba</span></div>
                    <div class="calc-row"><span class="calc-label">Govt Fiscal Year</span><span class="calc-val">April 1</span></div>
                    <div class="calc-row"><span class="calc-label">School Division FY</span><span class="calc-val">September 1</span></div>
                    <div class="calc-row"><span class="calc-label">Credit Union FY</span><span class="calc-val">January 1</span></div>
                </div>
            </div>
            <div class="calc-grid" style="margin-top:14px;">
                <div class="calc-panel">
                    <h3>Pipeline Conversion Math</h3>
                    <div class="calc-row"><span class="calc-label">Target: $3M closed</span><span class="calc-val">$3,000,000</span></div>
                    <div class="calc-row"><span class="calc-label">Assumed close rate</span><span class="calc-val">33%</span></div>
                    <div class="calc-row"><span class="calc-label">Pipeline needed (3x)</span><span class="calc-val" style="color:var(--accent3);">$9,000,000</span></div>
                    <div class="calc-row"><span class="calc-label">Avg deal size $75K â†’ deals needed</span><span class="calc-val">120 opps</span></div>
                    <div class="calc-row"><span class="calc-label">Opps per month</span><span class="calc-val">10/mo</span></div>
                    <div class="calc-row"><span class="calc-label">Meetings to opp (30%)</span><span class="calc-val">~33 meetings/mo</span></div>
                    <div class="calc-row"><span class="calc-label">Calls to meeting (10%)</span><span class="calc-val">~330 calls/mo</span></div>
                </div>
                <div class="calc-panel">
                    <h3>Revenue Mix Target</h3>
                    <div class="calc-row"><span class="calc-label">Recurring (MRR/ARR)</span><span class="calc-val" style="color:var(--accent2);">60% = $1.8M</span></div>
                    <div class="calc-row"><span class="calc-label">- Managed IT Services</span><span class="calc-val">$600K</span></div>
                    <div class="calc-row"><span class="calc-label">- M365 CSP Licensing</span><span class="calc-val">$400K</span></div>
                    <div class="calc-row"><span class="calc-label">- Security Stack (annual)</span><span class="calc-val">$400K</span></div>
                    <div class="calc-row"><span class="calc-label">- MPS / Print</span><span class="calc-val">$400K</span></div>
                    <div class="calc-row"><span class="calc-label">One-Time (hardware/projects)</span><span class="calc-val" style="color:var(--accent);">40% = $1.2M</span></div>
                </div>
            </div>
        </div>

        <!-- SK CALENDAR -->
        <div id="t-calendar" class="section-content">
            <div class="calc-grid">
                <div class="calc-panel" style="grid-column: span 2;">
                    <h3>Saskatchewan Territory Calendar â€” Key Dates & Budget Cycles</h3>
                    <div class="cal-month">
                        <div class="cal-month-name">January â€“ March (Q1)</div>
                        <div class="cal-event"><span class="cal-date">Jan 1</span><span class="cal-desc">Credit Union fiscal year starts â€” budget available</span><span class="cal-type cal-budget">Budget</span></div>
                        <div class="cal-event"><span class="cal-date">Jan-Feb</span><span class="cal-desc">Credit unions: Q1 budget allocation, best time to pitch new projects</span><span class="cal-type cal-outreach">Outreach</span></div>
                        <div class="cal-event"><span class="cal-date">Feb-Mar</span><span class="cal-desc">Government departments planning next fiscal year (Apr 1 start)</span><span class="cal-type cal-budget">Budget</span></div>
                        <div class="cal-event"><span class="cal-date">Mar</span><span class="cal-desc">Government "use it or lose it" â€” end of fiscal year spending</span><span class="cal-type cal-budget">Budget</span></div>
                        <div class="cal-event"><span class="cal-date">Q1</span><span class="cal-desc">Microsoft EA / CSP renewals â€” many orgs on Jan-Dec cycle</span><span class="cal-type cal-renewal">Renewal</span></div>
                    </div>
                    <div class="cal-month">
                        <div class="cal-month-name">April â€“ June (Q2)</div>
                        <div class="cal-event"><span class="cal-date">Apr 1</span><span class="cal-desc">Government of SK fiscal year starts â€” new budget available</span><span class="cal-type cal-budget">Budget</span></div>
                        <div class="cal-event"><span class="cal-date">Apr 1</span><span class="cal-desc">Crown Corps (SaskTel, SaskEnergy, SGI, SLGA) fiscal year start</span><span class="cal-type cal-budget">Budget</span></div>
                        <div class="cal-event"><span class="cal-date">Apr-May</span><span class="cal-desc">Government: Best window for new IT projects and assessments</span><span class="cal-type cal-outreach">Outreach</span></div>
                        <div class="cal-event"><span class="cal-date">May-Jun</span><span class="cal-desc">School divisions: IT planning for next school year</span><span class="cal-type cal-outreach">Outreach</span></div>
                        <div class="cal-event"><span class="cal-date">Jun</span><span class="cal-desc">School divisions: Year-end spending, summer project planning</span><span class="cal-type cal-budget">Budget</span></div>
                    </div>
                    <div class="cal-month">
                        <div class="cal-month-name">July â€“ September (Q3)</div>
                        <div class="cal-event"><span class="cal-date">Jul-Aug</span><span class="cal-desc">School divisions: Summer IT projects (network upgrades, endpoint refresh)</span><span class="cal-type cal-outreach">Outreach</span></div>
                        <div class="cal-event"><span class="cal-date">Sep 1</span><span class="cal-desc">School division fiscal year starts</span><span class="cal-type cal-budget">Budget</span></div>
                        <div class="cal-event"><span class="cal-date">Sep</span><span class="cal-desc">Government mid-year review â€” assess remaining budget</span><span class="cal-type cal-budget">Budget</span></div>
                        <div class="cal-event"><span class="cal-date">Q3</span><span class="cal-desc">Hardware refresh cycle â€” Dell/HPE/Lenovo new product launches</span><span class="cal-type cal-renewal">Renewal</span></div>
                    </div>
                    <div class="cal-month">
                        <div class="cal-month-name">October â€“ December (Q4)</div>
                        <div class="cal-event"><span class="cal-date">Oct-Nov</span><span class="cal-desc">Government & Crown Corp â€” year-end budget pushes</span><span class="cal-type cal-budget">Budget</span></div>
                        <div class="cal-event"><span class="cal-date">Oct-Nov</span><span class="cal-desc">School divisions: Mid-year IT projects, winter planning</span><span class="cal-type cal-outreach">Outreach</span></div>
                        <div class="cal-event"><span class="cal-date">Nov-Dec</span><span class="cal-desc">Credit unions: Budget planning for next year (Jan 1 start)</span><span class="cal-type cal-budget">Budget</span></div>
                        <div class="cal-event"><span class="cal-date">Dec</span><span class="cal-desc">Software renewal season â€” VMware, Veeam, security subscriptions</span><span class="cal-type cal-renewal">Renewal</span></div>
                        <div class="cal-event"><span class="cal-date">Q4</span><span class="cal-desc">Year-end hardware deals â€” vendor incentives and special pricing</span><span class="cal-type cal-outreach">Outreach</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUICK NOTES -->
        <div id="t-notes" class="section-content">
            <div class="calc-grid">
                <div class="calc-panel">
                    <h3>Weekly Focus / To-Do</h3>
                    <textarea class="notes-area" id="notesWeekly" placeholder="What are you focused on this week? Key meetings, follow-ups, priorities..."></textarea>
                    <div class="notes-saved" id="notesSavedWeekly">Saved</div>
                </div>
                <div class="calc-panel">
                    <h3>Hot Prospects / Pipeline Notes</h3>
                    <textarea class="notes-area" id="notesPipeline" placeholder="Deals in motion, proposals out, next steps..."></textarea>
                    <div class="notes-saved" id="notesSavedPipeline">Saved</div>
                </div>
            </div>
            <div class="calc-grid" style="margin-top:14px;">
                <div class="calc-panel" style="grid-column: span 2;">
                    <h3>General Notes & Ideas</h3>
                    <textarea class="notes-area" id="notesGeneral" placeholder="Account intel, competitor sightings, product updates, ideas..." style="min-height:180px;"></textarea>
                    <div class="notes-saved" id="notesSavedGeneral">Saved</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== CALENDAR ==================== -->
<div id="calendar" class="page">
    <div class="container">
        <div class="sec-header">
            <h2>Calendar</h2>
            <p>Your synced calendar from mike@mountainthirteen.ca. If the calendar doesn't load, ensure sharing settings allow embed access.</p>
        </div>
        <iframe class="cal-embed" src="https://calendar.google.com/calendar/embed?src=acg8pj4a64i43uqga1hnd0lhfc8ete3n%40import.calendar.google.com&ctz=America%2FRegina&mode=WEEK&showTitle=0&showNav=1&showDate=1&showPrint=0&showCalendars=0&showTz=0" style="border:0"></iframe>
    </div>
</div>

</div><!-- end app -->

<!-- ACCOUNT DETAIL MODAL -->
<div class="modal-overlay hidden" id="acctModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalAcctName">Account Name</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <div class="modal-section-title">Opportunity Tracking</div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Deal Stage</label>
                        <select id="m-stage">
                            <option value="Fresh">Fresh</option>
                            <option value="Prospecting">Prospecting</option>
                            <option value="Discovery">Discovery</option>
                            <option value="Solution Design">Solution Design</option>
                            <option value="Proposal">Proposal</option>
                            <option value="Negotiation">Negotiation</option>
                            <option value="Verbal Commit">Verbal Commit</option>
                            <option value="Closed Won">Closed Won</option>
                            <option value="Closed Lost">Closed Lost</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Est. Deal Value ($)</label>
                        <input type="number" id="m-value" placeholder="50000">
                    </div>
                    <div class="modal-field">
                        <label>Probability</label>
                        <select id="m-prob">
                            <option value="">â€”</option>
                            <option value="10">10%</option>
                            <option value="25">25%</option>
                            <option value="50">50%</option>
                            <option value="75">75%</option>
                            <option value="90">90%</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Expected Close</label>
                        <select id="m-close-q">
                            <option value="">â€”</option>
                            <option value="Q1 2026">Q1 2026</option>
                            <option value="Q2 2026">Q2 2026</option>
                            <option value="Q3 2026">Q3 2026</option>
                            <option value="Q4 2026">Q4 2026</option>
                            <option value="2027+">2027+</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>IT Incumbent</label>
                        <select id="m-incumbent">
                            <option value="">â€” None â€”</option>
                            <option value="WBM">WBM</option>
                            <option value="Horizon">Horizon</option>
                            <option value="PC Place">PC Place</option>
                            <option value="Wolf Strata">Wolf Strata</option>
                            <option value="Compugen">Compugen</option>
                            <option value="Internal IT">Internal IT</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">MEDDPICC Qualification</div>
                <div class="meddpicc-panel" id="meddpiccPanel">
                    <div class="meddpicc-grid">
                        <div class="meddpicc-item"><label>Metrics</label><input type="range" min="0" max="10" value="0" data-meddpicc="metrics" oninput="updateMEDDPICC()"><span class="meddpicc-score">0</span></div>
                        <div class="meddpicc-item"><label>Econ Buyer</label><input type="range" min="0" max="10" value="0" data-meddpicc="economicBuyer" oninput="updateMEDDPICC()"><span class="meddpicc-score">0</span></div>
                        <div class="meddpicc-item"><label>Dec Criteria</label><input type="range" min="0" max="10" value="0" data-meddpicc="decisionCriteria" oninput="updateMEDDPICC()"><span class="meddpicc-score">0</span></div>
                        <div class="meddpicc-item"><label>Dec Process</label><input type="range" min="0" max="10" value="0" data-meddpicc="decisionProcess" oninput="updateMEDDPICC()"><span class="meddpicc-score">0</span></div>
                        <div class="meddpicc-item"><label>Pain</label><input type="range" min="0" max="10" value="0" data-meddpicc="identifiedPain" oninput="updateMEDDPICC()"><span class="meddpicc-score">0</span></div>
                        <div class="meddpicc-item"><label>Champion</label><input type="range" min="0" max="10" value="0" data-meddpicc="champion" oninput="updateMEDDPICC()"><span class="meddpicc-score">0</span></div>
                        <div class="meddpicc-item"><label>Paper Proc</label><input type="range" min="0" max="10" value="0" data-meddpicc="paperProcess" oninput="updateMEDDPICC()"><span class="meddpicc-score">0</span></div>
                        <div class="meddpicc-item"><label>Competition</label><input type="range" min="0" max="10" value="0" data-meddpicc="competition" oninput="updateMEDDPICC()"><span class="meddpicc-score">0</span></div>
                    </div>
                    <div class="meddpicc-total">
                        <span class="meddpicc-total-label">Score:</span>
                        <span class="meddpicc-total-pct" id="meddpiccPct">0%</span>
                        <div class="meddpicc-bar"><div class="meddpicc-fill" id="meddpiccFill" style="width:0%;background:#ef4444;"></div></div>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Competitive Intelligence</div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Primary Competitor</label>
                        <select id="m-comp-primary">
                            <option value="">â€” None â€”</option>
                            <option value="Dell">Dell</option>
                            <option value="CDW">CDW</option>
                            <option value="Compugen">Compugen</option>
                            <option value="SHI">SHI</option>
                            <option value="Softchoice">Softchoice</option>
                            <option value="Local VAR">Local VAR</option>
                            <option value="Incumbent/Internal IT">Incumbent/Internal IT</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Threat Level</label>
                        <select id="m-comp-threat">
                            <option value="">â€”</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Price Position</label>
                        <select id="m-comp-price">
                            <option value="">â€”</option>
                            <option value="Higher">Higher (we're more)</option>
                            <option value="Equal">Equal</option>
                            <option value="Lower">Lower (we're less)</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:6px;">
                    <label style="display:block;font-size:10px;color:var(--text3);margin-bottom:4px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;">All Competitors Present</label>
                    <div class="competitor-chips" id="m-comp-all">
                        <span class="comp-chip" data-comp="Dell">Dell</span>
                        <span class="comp-chip" data-comp="CDW">CDW</span>
                        <span class="comp-chip" data-comp="Compugen">Compugen</span>
                        <span class="comp-chip" data-comp="SHI">SHI</span>
                        <span class="comp-chip" data-comp="Softchoice">Softchoice</span>
                        <span class="comp-chip" data-comp="Local VAR">Local VAR</span>
                        <span class="comp-chip" data-comp="Incumbent/Internal IT">Incumbent/Internal IT</span>
                        <span class="comp-chip" data-comp="Other">Other</span>
                    </div>
                </div>
            </div>

            <div class="modal-section closed-lost-section" id="closedLostSection" style="display:none;">
                <div class="modal-section-title">Closed Lost Details</div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Lost To</label>
                        <select id="m-lost-to">
                            <option value="">â€” Select â€”</option>
                            <option value="Dell">Dell</option>
                            <option value="CDW">CDW</option>
                            <option value="Compugen">Compugen</option>
                            <option value="SHI">SHI</option>
                            <option value="Softchoice">Softchoice</option>
                            <option value="Local VAR">Local VAR</option>
                            <option value="Incumbent/Internal IT">Incumbent/Internal IT</option>
                            <option value="No Decision">No Decision</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="modal-field" style="flex:2;">
                        <label>Loss Reason</label>
                        <select id="m-loss-reason">
                            <option value="">â€” Select â€”</option>
                            <option value="Price/Budget">Price/Budget</option>
                            <option value="Product Gap">Product Gap</option>
                            <option value="Incumbent Preference">Incumbent Preference</option>
                            <option value="Relationship/Trust">Relationship/Trust</option>
                            <option value="Procurement Process">Procurement Process</option>
                            <option value="No Decision">No Decision</option>
                            <option value="Internal IT Build">Internal IT Build</option>
                            <option value="Political Change">Political Change</option>
                            <option value="Contract Terms">Contract Terms</option>
                            <option value="Implementation Concerns">Implementation Concerns</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Activity & Next Steps</div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Last Contact Date</label>
                        <input id="m-lastcontact" type="date">
                    </div>
                    <div class="modal-field" style="flex:2;">
                        <label>Next Action</label>
                        <input id="m-nextaction" placeholder="Send SOW, Book demo, Meet CFO, Follow up...">
                    </div>
                    <div class="modal-field">
                        <label>Deal Source</label>
                        <select id="m-source">
                            <option value="">--</option>
                            <option value="Cold Outreach">Cold Outreach</option>
                            <option value="Referral">Referral</option>
                            <option value="RFP Response">RFP Response</option>
                            <option value="Existing Relationship">Existing Relationship</option>
                            <option value="Xerox Print Bridge">Xerox Print Bridge</option>
                            <option value="Inbound">Inbound</option>
                            <option value="Event / Conference">Event / Conference</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Pillar Opportunities</div>
                <div class="check-grid" id="m-pillars">
                    <label class="check-item" data-val="Cloud"><input type="checkbox">Cloud</label>
                    <label class="check-item" data-val="Virtualization"><input type="checkbox">Virtualization</label>
                    <label class="check-item" data-val="Infrastructure"><input type="checkbox">Infrastructure</label>
                    <label class="check-item" data-val="Endpoint"><input type="checkbox">Endpoint</label>
                    <label class="check-item" data-val="Security"><input type="checkbox">Security</label>
                    <label class="check-item" data-val="Data Protection"><input type="checkbox">Data Protection</label>
                    <label class="check-item" data-val="Print/Doc Mgmt"><input type="checkbox">Print/Doc Mgmt</label>
                    <label class="check-item" data-val="Network"><input type="checkbox">Network</label>
                    <label class="check-item" data-val="AI/Copilot"><input type="checkbox">AI/Copilot</label>
                    <label class="check-item" data-val="Managed IT"><input type="checkbox">Managed IT</label>
                    <label class="check-item" data-val="Prof Services"><input type="checkbox">Prof Services</label>
                    <label class="check-item" data-val="Support Svc"><input type="checkbox">Support Svc</label>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Flags</div>
                <div class="check-grid" id="m-flags">
                    <label class="check-item" data-val="rfp"><input type="checkbox">Active RFP</label>
                    <label class="check-item" data-val="expiring"><input type="checkbox">Contract Expiring</label>
                    <label class="check-item" data-val="budget"><input type="checkbox">Budget Approved</label>
                    <label class="check-item" data-val="dm"><input type="checkbox">Decision Maker ID'd</label>
                    <label class="check-item" data-val="proposal"><input type="checkbox">Proposal Sent</label>
                    <label class="check-item" data-val="competitor"><input type="checkbox">Competitor Incumbent</label>
                </div>
            </div>

            <div class="modal-section">
                <div class="contacts-header">
                    <div class="modal-section-title" style="margin-bottom:0;">Contacts</div>
                    <button class="contact-add-btn" onclick="showContactForm()">+ Add Contact</button>
                </div>
                <div id="contactList" class="contact-list"></div>
                <div id="contactFormWrap"></div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Key Dates</div>
                <div class="modal-row">
                    <div class="modal-field"><label>Next Follow-Up</label><input id="m-followup" type="date"></div>
                    <div class="modal-field"><label>Contract Expiry</label><input id="m-expiry" type="date"></div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Notes</div>
                <textarea class="modal-notes" id="m-notes" placeholder="Meeting notes, intel, next steps..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-ghost" onclick="closeModal()">Cancel</button>
            <button class="modal-btn modal-btn-primary" onclick="saveModal()">Save & Close</button>
        </div>
    </div>
</div>

<!-- CALENDAR SETUP MODAL -->
<div class="modal-overlay hidden" id="calSetupModal">
    <div class="modal-card" style="max-width:540px;">
        <div class="modal-header">
            <h2>Connect Google Calendar</h2>
            <button class="modal-close" onclick="document.getElementById('calSetupModal').classList.add('hidden')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <div class="modal-section-title">One-Time Setup</div>
                <div style="font-size:12px;color:var(--text2);line-height:1.6;">
                    <strong>1.</strong> <a href="https://console.cloud.google.com/projectcreate" target="_blank" style="color:var(--accent);">Create a Google Cloud project</a> (free)<br>
                    <strong>2.</strong> <a href="https://console.cloud.google.com/apis/library/calendar-json.googleapis.com" target="_blank" style="color:var(--accent);">Enable the Calendar API</a><br>
                    <strong>3.</strong> <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color:var(--accent);">Create an API key</a> (+ Create Credentials â†’ API key)<br>
                    <strong>4.</strong> In Google Calendar â†’ Settings â†’ your calendar â†’ <strong>Make available to public</strong><br>
                    <strong>5.</strong> Copy your <strong>Calendar ID</strong> from Settings â†’ Integrate calendar
                </div>
            </div>
            <div class="modal-section">
                <div class="modal-section-title">Your Credentials</div>
                <div class="modal-row">
                    <div class="modal-field" style="flex:1;">
                        <label>API Key</label>
                        <input type="text" id="calApiKey" placeholder="AIzaSyB..." style="width:100%;">
                    </div>
                </div>
                <div class="modal-row" style="margin-top:6px;">
                    <div class="modal-field" style="flex:1;">
                        <label>Calendar ID</label>
                        <input type="text" id="calCalId" placeholder="mike@mountainthirteen.ca or long-id@group.calendar.google.com" style="width:100%;">
                    </div>
                </div>
                <div style="display:flex;gap:8px;margin-top:10px;">
                    <button class="mtg-add-btn" onclick="saveCalApi()">Save & Connect</button>
                    <button class="mtg-add-btn" style="background:var(--border);color:var(--text3);" onclick="clearCalApi()">Disconnect</button>
                </div>
                <div id="calTestResult" style="font-size:11px;margin-top:8px;color:var(--text3);"></div>
            </div>
        </div>
    </div>
</div>

<!-- DIGEST MODAL -->
<div class="modal-overlay hidden" id="digestModal">
    <div class="modal-card" style="max-width:600px;">
        <div class="modal-header">
            <h2>End of Day Digest</h2>
            <button class="modal-close" onclick="document.getElementById('digestModal').classList.add('hidden')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="digestContent" style="font-family:var(--mono);font-size:11px;line-height:1.7;white-space:pre-wrap;max-height:400px;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:14px;"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-ghost" onclick="document.getElementById('digestModal').classList.add('hidden')">Close</button>
            <button class="modal-btn modal-btn-primary" onclick="copyDigest()">Copy to Clipboard</button>
        </div>
    </div>
</div>

<div style="height:60px;"></div>

<!-- QUICK LOG A CALL MODAL -->
<div class="qa-modal hidden" id="qaLogModal">
    <div class="qa-box">
        <h3>Log a Call</h3>
        <div class="qa-field">
            <label>Account</label>
            <input id="qa-log-acct" list="allAccountsList" placeholder="Start typing account name...">
        </div>
        <div class="qa-field">
            <label>Notes</label>
            <textarea id="qa-log-notes" placeholder="What was discussed? Key takeaways..."></textarea>
        </div>
        <div class="qa-field">
            <label>Next Action</label>
            <input id="qa-log-next" placeholder="Send SOW, Book demo, Follow up in 2 weeks...">
        </div>
        <div class="qa-btns">
            <button class="modal-btn modal-btn-ghost" onclick="document.getElementById('qaLogModal').classList.add('hidden')">Cancel</button>
            <button class="modal-btn modal-btn-primary" onclick="saveQuickLog()">Save</button>
        </div>
    </div>
</div>

<!-- QUICK ADD DEAL MODAL -->
<div class="qa-modal hidden" id="qaDealModal">
    <div class="qa-box">
        <h3>Quick Add Deal</h3>
        <div class="qa-field">
            <label>Account</label>
            <input id="qa-deal-acct" list="allAccountsList" placeholder="Start typing account name...">
        </div>
        <div style="display:flex;gap:10px;">
            <div class="qa-field" style="flex:1;">
                <label>Deal Value ($)</label>
                <input type="number" id="qa-deal-value" placeholder="50000">
            </div>
            <div class="qa-field" style="flex:1;">
                <label>Stage</label>
                <select id="qa-deal-stage">
                    <option value="Prospecting">Prospecting</option>
                    <option value="Discovery">Discovery</option>
                    <option value="Solution Design">Solution Design</option>
                    <option value="Proposal">Proposal</option>
                </select>
            </div>
        </div>
        <div class="qa-btns">
            <button class="modal-btn modal-btn-ghost" onclick="document.getElementById('qaDealModal').classList.add('hidden')">Cancel</button>
            <button class="modal-btn modal-btn-primary" onclick="saveQuickDeal()">Add Deal</button>
        </div>
    </div>
</div>

<!-- ADD ACCOUNT MODAL -->
<div class="qa-modal hidden" id="qaAddAcctModal">
    <div class="qa-box" style="width:520px;">
        <h3>Add New Account</h3>
        <div class="qa-field">
            <label>Account Name</label>
            <input id="qa-acct-name" placeholder="Company name...">
        </div>
        <div style="display:flex;gap:10px;">
            <div class="qa-field" style="flex:1;">
                <label>Type</label>
                <select id="qa-acct-type" onchange="updateAddAcctSectors()">
                    <option value="ent">Enterprise</option>
                    <option value="smb">SMB</option>
                </select>
            </div>
            <div class="qa-field" style="flex:1;">
                <label>Sector / Industry</label>
                <select id="qa-acct-sector">
                    <option value="">â€”</option>
                </select>
            </div>
        </div>
        <div style="display:flex;gap:10px;">
            <div class="qa-field" style="flex:1;">
                <label>City</label>
                <input id="qa-acct-city" placeholder="Saskatoon">
            </div>
            <div class="qa-field" style="flex:1;">
                <label>Priority</label>
                <select id="qa-acct-priority">
                    <option value="B">B â€” Target</option>
                    <option value="A">A â€” Strategic</option>
                    <option value="C">C â€” Opportunistic</option>
                </select>
            </div>
        </div>
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);margin:12px 0 6px;">First Contact</div>
        <div style="display:flex;gap:10px;">
            <div class="qa-field" style="flex:1;">
                <label>Name</label>
                <input id="qa-acct-cname" placeholder="Jane Smith">
            </div>
            <div class="qa-field" style="flex:1;">
                <label>Title</label>
                <input id="qa-acct-ctitle" placeholder="CIO">
            </div>
        </div>
        <div style="display:flex;gap:10px;">
            <div class="qa-field" style="flex:1;">
                <label>Email</label>
                <input id="qa-acct-cemail" type="email" placeholder="jane@company.com">
            </div>
            <div class="qa-field" style="flex:1;">
                <label>Phone</label>
                <input id="qa-acct-cphone" placeholder="306-555-1234">
            </div>
        </div>
        <div class="qa-field">
            <label>Buying Role</label>
            <select id="qa-acct-crole">
                <option value="">â€”</option>
                <option value="Champion">Champion</option>
                <option value="Economic Buyer">Economic Buyer</option>
                <option value="Technical Buyer">Technical Buyer</option>
                <option value="User Buyer">User Buyer</option>
                <option value="Influencer">Influencer</option>
                <option value="Gatekeeper">Gatekeeper</option>
                <option value="Coach">Coach</option>
            </select>
        </div>
        <div class="qa-btns">
            <button class="modal-btn modal-btn-ghost" onclick="document.getElementById('qaAddAcctModal').classList.add('hidden')">Cancel</button>
            <button class="modal-btn modal-btn-primary" onclick="saveNewAccount()">Add Account</button>
        </div>
    </div>
</div>

<!-- WEEK PRIORITIES MODAL -->
<div class="qa-modal hidden" id="qaWeekModal">
    <div class="qa-box" style="width:560px;">
        <h3>This Week's Priorities</h3>
        <div id="qaWeekContent" style="font-size:12px;color:var(--text2);line-height:1.7;max-height:400px;overflow-y:auto;"></div>
        <div class="qa-btns" style="margin-top:14px;">
            <button class="modal-btn modal-btn-ghost" onclick="document.getElementById('qaWeekModal').classList.add('hidden')">Close</button>
        </div>
    </div>
</div>

<!-- DATALIST for account autocomplete -->
<datalist id="allAccountsList"></datalist>

<!-- FAB (Floating Action Button) -->
<div class="fab-container" id="fabContainer">
    <button class="fab-main" id="fabMain" onclick="toggleFAB()">+</button>
    <div class="fab-menu" id="fabMenu">
        <button class="fab-item" onclick="logActivity('call')">&#128222; Log Call</button>
        <button class="fab-item" onclick="logActivity('email')">&#128231; Log Email</button>
        <button class="fab-item" onclick="logActivity('meeting')">&#129309; Meeting</button>
        <button class="fab-item" onclick="logActivity('note')">&#128221; Note</button>
    </div>
</div>

<!-- FAB QUICK LOG MODAL -->
<div class="fab-log-modal hidden" id="fabLogModal">
    <div class="fab-log-box">
        <h3 id="fabLogTitle">Log Activity</h3>
        <div class="fab-log-type" id="fabLogType"></div>
        <div class="qa-field">
            <label>Account</label>
            <input id="fab-log-acct" list="allAccountsList" placeholder="Start typing account name...">
        </div>
        <div class="fab-log-templates" id="fabLogTemplates">
            <button class="fab-log-tpl" onclick="setFabTemplate('discovery')">Discovery Call</button>
            <button class="fab-log-tpl" onclick="setFabTemplate('demo')">Demo Follow-up</button>
            <button class="fab-log-tpl" onclick="setFabTemplate('proposal')">Proposal Review</button>
            <button class="fab-log-tpl" onclick="setFabTemplate('site')">Site Visit</button>
        </div>
        <div class="qa-field">
            <label>Notes</label>
            <textarea id="fab-log-notes" placeholder="Quick note (optional)" maxlength="280" style="min-height:50px;"></textarea>
            <div style="text-align:right;font-size:10px;color:var(--text3);margin-top:2px;"><span id="fabCharCount">0</span>/280</div>
        </div>
        <div class="qa-btns">
            <button class="modal-btn modal-btn-ghost" onclick="closeFabLog()">Cancel</button>
            <button class="modal-btn modal-btn-primary" onclick="saveFabActivity()">Save</button>
        </div>
    </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- RESTORE FROM BACKUP MODAL -->
<div class="restore-modal hidden" id="restoreModal">
    <div class="restore-box">
        <h3>Backup & Restore</h3>
        <div id="restoreInfo" class="restore-info">Checking for backup...</div>
        <p id="restoreDesc"></p>
        <div class="restore-btns">
            <button class="btn-cancel" onclick="document.getElementById('restoreModal').classList.add('hidden')">Cancel</button>
            <button class="btn-restore" id="restoreBtn" onclick="restoreFromBackup()" style="display:none;">Restore Data</button>
        </div>
    </div>
</div>

<script>
// ===== AUTH =====
const ACCESS_CODE = 'xits2026';
const authOverlay = document.getElementById('authOverlay');
const app = document.getElementById('app');
const authPass = document.getElementById('authPass');
const authBtn = document.getElementById('authBtn');
const authError = document.getElementById('authError');

if (localStorage.getItem('xits_auth') === 'true') {
    authOverlay.classList.add('hidden');
    app.classList.add('visible');
}

function tryAuth() {
    if (authPass.value === ACCESS_CODE) {
        localStorage.setItem('xits_auth', 'true');
        authOverlay.classList.add('hidden');
        app.classList.add('visible');
    } else {
        authError.style.display = 'block';
        authPass.value = '';
        authPass.focus();
    }
}
authBtn.addEventListener('click', tryAuth);
authPass.addEventListener('keydown', e => { if (e.key === 'Enter') tryAuth(); });

// ===== ENT ACCOUNTS DATA =====
const entAccounts = [
    // Original 20 enterprise accounts
    {name:"Government of Saskatchewan",sector:"Government",emp:30000,city:"Regina/Province-wide",priority:"A",incumbent:"WBM",contact:"",source:"Tracker"},
    {name:"Nutrien Ltd",sector:"Mining",emp:3944,city:"Saskatoon",priority:"A",incumbent:"WBM",contact:"",source:"Tracker"},
    {name:"SaskTel",sector:"Crown Corp",emp:3136,city:"Regina",priority:"A",incumbent:"â€”",contact:"",source:"Tracker"},
    {name:"Federated Co-operatives (FCL)",sector:"Retail",emp:2309,city:"Saskatoon",priority:"B",incumbent:"â€”",contact:"",source:"Tracker"},
    {name:"SGI Canada",sector:"Crown Corp",emp:2012,city:"Regina",priority:"B",incumbent:"â€”",contact:"",source:"Tracker"},
    {name:"The Mosaic Company",sector:"Mining",emp:1984,city:"Saskatoon/Esterhazy",priority:"A",incumbent:"Konica Minolta",contact:"Geoff Cole",source:"Tracker"},
    {name:"SIGA",sector:"Gaming",emp:1882,city:"Saskatoon",priority:"B",incumbent:"Xerox Dealer AB",contact:"Ryan G",source:"Tracker"},
    {name:"Brandt Group",sector:"Manufacturing",emp:1413,city:"Regina",priority:"B",incumbent:"Calgary Agency",contact:"",source:"Tracker"},
    {name:"SaskEnergy",sector:"Crown Corp",emp:1169,city:"Regina",priority:"B",incumbent:"WBM",contact:"",source:"Tracker"},
    {name:"Cameco Corporation",sector:"Mining",emp:1089,city:"Saskatoon",priority:"A",incumbent:"WBM",contact:"Mark (VP Tech)",source:"Tracker"},
    {name:"Pharma Choice Canada",sector:"Healthcare",emp:1080,city:"Saskatoon",priority:"C",incumbent:"â€”",contact:"",source:"Tracker"},
    {name:"Conexus Credit Union",sector:"Financial",emp:891,city:"Regina",priority:"B",incumbent:"Unknown",contact:"CMO",source:"Tracker"},
    {name:"Affinity Credit Union",sector:"Financial",emp:802,city:"Saskatoon",priority:"B",incumbent:"Unknown",contact:"",source:"Tracker"},
    {name:"SARCAN Recycling",sector:"Government",emp:790,city:"Saskatoon",priority:"C",incumbent:"â€”",contact:"",source:"Tracker"},
    {name:"Viterra",sector:"Agriculture",emp:726,city:"Regina",priority:"C",incumbent:"â€”",contact:"",source:"Tracker"},
    {name:"SLGA",sector:"Crown Corp",emp:682,city:"Regina",priority:"C",incumbent:"â€”",contact:"",source:"Tracker"},
    {name:"Co-op Life Insurance",sector:"Financial",emp:598,city:"Regina",priority:"C",incumbent:"â€”",contact:"",source:"Tracker"},
    {name:"Saskatchewan WCB",sector:"Crown Corp",emp:505,city:"Regina",priority:"B",incumbent:"Unknown",contact:"",source:"Tracker"},
    {name:"City of Saskatoon",sector:"Government",emp:0,city:"Saskatoon",priority:"A",incumbent:"â€”",contact:"",source:"Tracker"},
    {name:"City of Regina",sector:"Government",emp:0,city:"Regina",priority:"A",incumbent:"â€”",contact:"",source:"Tracker"},
    // New from SK Company Database (500+ emp)
    {name:"Regina General Hospital",sector:"Healthcare",emp:8000,city:"Regina",priority:"A",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Sun Country Regional Health",sector:"Healthcare",emp:2400,city:"Weyburn",priority:"B",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Maple Leaf Consumer Foods",sector:"Manufacturing",emp:1500,city:"Saskatoon",priority:"B",incumbent:"â€”",contact:"Gord Macfarlane",source:"SK DB"},
    {name:"Five Hills Health Region",sector:"Healthcare",emp:1200,city:"Moose Jaw",priority:"B",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Saskatchewan Gaming Corporation",sector:"Gaming",emp:1001,city:"Regina",priority:"B",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"St Paul's Hospital",sector:"Healthcare",emp:1000,city:"Saskatoon",priority:"B",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Wascana Rehabilitation Centre",sector:"Healthcare",emp:1000,city:"Regina",priority:"B",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Trans Gas Ltd",sector:"Energy",emp:900,city:"Regina",priority:"C",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Potash Corp of SK (Lanigan)",sector:"Mining",emp:700,city:"Lanigan",priority:"B",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Commissionaires Saskatchewan",sector:"Security",emp:700,city:"Regina",priority:"C",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Dominion Pro-Vac Inc",sector:"Industrial",emp:687,city:"Regina",priority:"C",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Kelsey Trail Health Region",sector:"Healthcare",emp:600,city:"Nipawin",priority:"C",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Yorkton Regional Health Centre",sector:"Healthcare",emp:600,city:"Yorkton",priority:"C",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Consumers' Co-Op Refineries",sector:"Energy",emp:600,city:"Regina",priority:"B",incumbent:"â€”",contact:"",source:"SK DB"},
    {name:"Ranch Ehrlo Society",sector:"Social Services",emp:600,city:"Regina",priority:"C",incumbent:"â€”",contact:"",source:"SK DB"},
    // Key missing accounts
    {name:"Saskatchewan Health Authority",sector:"Healthcare",emp:44000,city:"Saskatoon/Regina",priority:"A",incumbent:"â€”",contact:"",source:"Territory"},
    {name:"eHealth Saskatchewan",sector:"Healthcare",emp:1200,city:"Regina",priority:"A",incumbent:"â€”",contact:"",source:"Territory"},
    {name:"SaskPower",sector:"Crown Corp",emp:3300,city:"Regina",priority:"A",incumbent:"â€”",contact:"",source:"Territory"},
    {name:"Bunge Canada",sector:"Agriculture",emp:900,city:"Saskatoon",priority:"B",incumbent:"â€”",contact:"",source:"Territory"},
    {name:"K+S Potash Canada",sector:"Mining",emp:600,city:"Bethune",priority:"B",incumbent:"â€”",contact:"",source:"Territory"},
    {name:"GSCS (Greater Saskatoon Catholic Schools)",sector:"Government",emp:2500,city:"Saskatoon",priority:"A",incumbent:"â€”",contact:"Laurier Langlois",source:"Tracker"},
];

// ===== SMB DATA =====
const smbAccounts = [
    {name:"Potash Corp of SK (Rocanville)",industry:"Mining",emp:480,sales:618200000,city:"Rocanville",contact:"",title:""},
    {name:"Farm Credit Canada",industry:"Finance",emp:463,sales:0,city:"Regina",contact:"Wes Anderson",title:"Regional VP"},
    {name:"Canadian Pacific Railway",industry:"Transportation",emp:460,sales:167400000,city:"Moose Jaw",contact:"",title:""},
    {name:"Northern Lights Casino",industry:"Gaming",emp:420,sales:51700000,city:"Prince Albert",contact:"",title:""},
    {name:"Bombardier Aerospace",industry:"Manufacturing",emp:413,sales:0,city:"Moose Jaw",contact:"",title:""},
    {name:"Vecima Networks Inc",industry:"Technology",emp:400,sales:134400000,city:"Saskatoon",contact:"Dr. Surinder Kumar",title:"CEO"},
    {name:"Westmoreland Coal",industry:"Mining",emp:400,sales:86400000,city:"Estevan",contact:"",title:""},
    {name:"Bourgault Industries",industry:"Manufacturing",emp:390,sales:236300000,city:"St Brieux",contact:"Gerry Bourgault",title:"President"},
    {name:"Gold Eagle Casino",industry:"Gaming",emp:380,sales:46700000,city:"North Battleford",contact:"",title:""},
    {name:"CGI",industry:"Technology",emp:375,sales:90400000,city:"Saskatoon",contact:"",title:""},
    {name:"Prince Albert Grand Council",industry:"Government",emp:350,sales:0,city:"Prince Albert",contact:"",title:""},
    {name:"Geoanalytical Laboratories",industry:"Technology",emp:350,sales:0,city:"Saskatoon",contact:"",title:""},
    {name:"Leader-Post / Postmedia",industry:"Media",emp:310,sales:67300000,city:"Regina",contact:"",title:""},
    {name:"Ray's Transport Ltd",industry:"Transportation",emp:301,sales:56000000,city:"Saskatoon",contact:"",title:""},
    {name:"Boundary Dam Power Station",industry:"Energy",emp:300,sales:315000000,city:"Estevan",contact:"",title:""},
    {name:"Battleford's Union Hospital",industry:"Healthcare",emp:300,sales:46500000,city:"North Battleford",contact:"",title:""},
    {name:"Cypress Regional Hospital",industry:"Healthcare",emp:300,sales:46500000,city:"Swift Current",contact:"",title:""},
    {name:"Prairie North Health (Meadow Lake)",industry:"Healthcare",emp:300,sales:45600000,city:"Meadow Lake",contact:"",title:""},
    {name:"Painted Hand Casino",industry:"Gaming",emp:300,sales:36900000,city:"Yorkton",contact:"",title:""},
    {name:"Transwest Air",industry:"Transportation",emp:300,sales:132900000,city:"Saskatoon",contact:"",title:""},
    {name:"Dream Development",industry:"Construction",emp:300,sales:150300000,city:"Saskatoon",contact:"",title:""},
    {name:"Broda Construction Group",industry:"Construction",emp:300,sales:0,city:"Prince Albert",contact:"",title:""},
    {name:"ISM Canada",industry:"Technology",emp:300,sales:72300000,city:"Regina",contact:"",title:""},
    {name:"Husky Lloydminster Upgrader",industry:"Energy",emp:300,sales:69000000,city:"Lloydminster",contact:"",title:""},
    {name:"Saskatoon Star Phoenix",industry:"Media",emp:300,sales:65100000,city:"Saskatoon",contact:"",title:""},
    {name:"WorleyParsons Canada",industry:"Engineering",emp:280,sales:64700000,city:"Saskatoon",contact:"",title:""},
    {name:"Claude Resources Inc",industry:"Mining",emp:260,sales:75100000,city:"La Ronge",contact:"",title:""},
    {name:"Agrium Inc (Vanscoy)",industry:"Manufacturing",emp:500,sales:561000000,city:"Vanscoy",contact:"",title:""},
    {name:"Dakota Dunes Community Dev",industry:"Government",emp:250,sales:0,city:"Whitecap",contact:"",title:""},
    {name:"Loraas Disposal Services",industry:"Industrial",emp:200,sales:30000000,city:"Saskatoon",contact:"",title:""},
];

// ===== K-12 DATA =====
const k12 = [
    {name:"Saskatoon Public SD 13",type:"Public",region:"Saskatoon",students:28924,incumbent:"KM (2023, 5yr)",cfo:"Daniel Burke (CFO)",it:"Jason Dunk (CTO)",priority:"A"},
    {name:"Regina Public SD 4",type:"Public",region:"Regina",students:26000,incumbent:"KM (5yr, 2025?)",cfo:"Ashley Kuntz",it:"Aaron Baumgartner",priority:"A"},
    {name:"Greater Saskatoon Catholic 20",type:"Catholic",region:"Saskatoon",students:20000,incumbent:"KM (lost fleet 2025)",cfo:"Joel Lloyd (CFO)",it:"Kalyn Kist (CIO)",priority:"A"},
    {name:"Regina Catholic SD 81",type:"Catholic",region:"Regina",students:14000,incumbent:"Toshiba",cfo:"Josh Kramer (CFO)",it:"S. Fossenier (CIO)",priority:"A"},
    {name:"Saskatchewan Rivers SD 119",type:"Public",region:"",students:9500,incumbent:"â€”",cfo:"Jerrold Pidborochynski",it:"IT under CFO",priority:"C"},
    {name:"Prairie Valley SD 208",type:"Public",region:"Regina Beach",students:8858,incumbent:"Konica Minolta",cfo:"Brent Nadon (CFO)",it:"Ashton Calder",priority:"B"},
    {name:"South East Cornerstone SD 209",type:"Public",region:"Weyburn",students:8305,incumbent:"Konica Minolta",cfo:"Shelley Toth (CFO)",it:"Michael Graham",priority:"C"},
    {name:"Prairie Spirit SD 206",type:"Public",region:"",students:7231,incumbent:"Toshiba (2024, 3-5yr)",cfo:"Ron Purdy (CFO)",it:"Dustin Swanson",priority:"C"},
    {name:"Horizon SD 205",type:"Public",region:"Humboldt",students:6701,incumbent:"Konica Minolta",cfo:"Sarah Reding",it:"Ken Sogge",priority:"C"},
    {name:"Chinook SD 211",type:"Public",region:"Swift Current",students:6000,incumbent:"â€”",cfo:"Sherie Sloman (CFO)",it:"",priority:"C"},
    {name:"Living Sky SD 202",type:"Public",region:"NW Central SK",students:5300,incumbent:"Konica Minolta",cfo:"Lonny Darroch (CFO)",it:"Ryan Kobelsky",priority:"C"},
    {name:"Sun West SD 207",type:"Public",region:"West Central SK",students:4700,incumbent:"Konica Minolta",cfo:"Ryan Smith (CFO)",it:"Michael Zummack",priority:"C"},
    {name:"Northwest SD 203",type:"Public",region:"Meadow Lake",students:4530,incumbent:"â€”",cfo:"Michelle Pickett (CFO)",it:"Al Maier",priority:"C"},
    {name:"Northern Lights SD 113",type:"Public",region:"La Ronge",students:4129,incumbent:"â€”",cfo:"Tom Harrington (CFO)",it:"",priority:"C"},
    {name:"Prince Albert RCSSD 6",type:"Catholic",region:"Prince Albert",students:3198,incumbent:"â€”",cfo:"Greg McEwen (CFO)",it:"",priority:"C"},
    {name:"Lloydminster RCSSD 89",type:"Catholic",region:"Lloydminster",students:2827,incumbent:"Konica Minolta",cfo:"Melanie Stelmaschuk (CFO)",it:"Armand Brockhoff",priority:"C"},
    {name:"Holy Trinity RCSSD 22",type:"Catholic",region:"Moose Jaw",students:2467,incumbent:"Konica Minolta",cfo:"Curt Van Parys (CFO)",it:"Ryan MacLachlan",priority:"C"},
    {name:"Conseil des Ã©coles fransaskoises",type:"Francophone",region:"Regina/Saskatoon",students:2000,incumbent:"Xerox",cfo:"Vacant",it:"SÃ©bastien Fillion",priority:"B"},
    {name:"Christ the Teacher RCSSD 212",type:"Catholic",region:"Melville/Yorkton",students:1750,incumbent:"â€”",cfo:"Delmar Zwirsky (CFO)",it:"Trent Davenport",priority:"C"},
    {name:"Holy Family RCSSD 140",type:"Catholic",region:"Weyburn",students:1321,incumbent:"â€”",cfo:"Georgia Hanwell (CFO)",it:"Kyle Hambly",priority:"C"},
    {name:"Prairie South SD 210",type:"Public",region:"Around Regina",students:0,incumbent:"Toshiba",cfo:"",it:"",priority:"B"},
    {name:"Good Spirit SD 204",type:"Public",region:"Yorkton",students:0,incumbent:"Konica Minolta",cfo:"Keith Gervais (CFO)",it:"Jonas Prysliak",priority:"C"},
    {name:"North East SD 200",type:"Public",region:"",students:0,incumbent:"â€”",cfo:"Donna Eberle",it:"Keith Chapman",priority:"C"},
    {name:"Light of Christ RCSSD 16",type:"Catholic",region:"North Battleford",students:0,incumbent:"â€”",cfo:"Jordan Kist (CFO)",it:"Joanne Lloyd",priority:"C"},
    {name:"Lloydminster SD 99",type:"Public",region:"Lloydminster",students:0,incumbent:"Konica Minolta",cfo:"Matthew Read (CFO)",it:"Randy Finlay",priority:"C"},
    {name:"Creighton SD 111",type:"Public",region:"Creighton",students:579,incumbent:"â€”",cfo:"Sheola Jansen",it:"Kevin Mackay",priority:"C"},
    {name:"Ile a la Crosse SD 112",type:"Public",region:"Ile a la Crosse",students:380,incumbent:"â€”",cfo:"",it:"",priority:"C"},
];

// ===== HIGHER ED DATA =====
const higherEd = [
    {name:"University of Saskatchewan",type:"University",city:"Saskatoon",priority:"A",mps:"TBD",cloud:"TBD",mit:"TBD",stage:"Prospecting"},
    {name:"University of Regina",type:"University",city:"Regina",priority:"A",mps:"TBD",cloud:"TBD",mit:"TBD",stage:"New Lead"},
    {name:"Saskatchewan Polytechnic",type:"Polytechnic",city:"Saskatoon/Regina/PA/MJ",priority:"A",mps:"TBD",cloud:"TBD",mit:"TBD",stage:"New Lead"},
    {name:"Saskatchewan Indian Institute of Technologies",type:"Indigenous",city:"Saskatoon",priority:"B",mps:"TBD",cloud:"TBD",mit:"TBD",stage:"New Lead"},
    {name:"First Nations University of Canada",type:"Indigenous",city:"Regina",priority:"B",mps:"TBD",cloud:"TBD",mit:"TBD",stage:"New Lead"},
];

// ===== CREDIT UNIONS DATA =====
const creditUnions = [
    {name:"Affinity Credit Union",rank:10,assets:7724897316,members:132506,locations:50,city:"Saskatoon",priority:"A"},
    {name:"Conexus Credit Union",rank:14,assets:6893630239,members:141028,locations:30,city:"Regina",priority:"A"},
    {name:"Innovation Credit Union",rank:23,assets:3788005213,members:62297,locations:25,city:"Swift Current",priority:"B"},
    {name:"Cornerstone Credit Union",rank:32,assets:2011765000,members:29056,locations:15,city:"Yorkton",priority:"B"},
    {name:"Synergy Credit Union",rank:33,assets:1925545000,members:27086,locations:12,city:"Lloydminster",priority:"B"},
    {name:"Prairie Centre Credit Union",rank:43,assets:1180579340,members:17132,locations:16,city:"",priority:"C"},
    {name:"TCU Financial Group",rank:59,assets:710454487,members:14527,locations:5,city:"Saskatoon",priority:"C"},
    {name:"Weyburn Credit Union",rank:60,assets:709732972,members:7987,locations:3,city:"Weyburn",priority:"C"},
    {name:"Diamond North Credit Union",rank:64,assets:683472000,members:12093,locations:8,city:"Nipawin",priority:"C"},
    {name:"Radius Credit Union",rank:66,assets:583417023,members:5758,locations:8,city:"",priority:"C"},
    {name:"Crossroads Credit Union",rank:87,assets:348681101,members:6529,locations:4,city:"",priority:"C"},
    {name:"Unity Credit Union",rank:88,assets:348643237,members:4423,locations:1,city:"Unity",priority:"C"},
    {name:"Accent Credit Union",rank:94,assets:310131516,members:4602,locations:3,city:"",priority:"C"},
    {name:"Biggar & District CU",rank:96,assets:306097670,members:3902,locations:3,city:"Biggar",priority:"C"},
];

// ===== HELPERS =====
function ptag(p) {
    if (p==='A') return '<span class="tag tag-a">A</span>';
    if (p==='B') return '<span class="tag tag-b">B</span>';
    return '<span class="tag tag-c">C</span>';
}
function fmt(n) { return n ? n.toLocaleString() : 'â€”'; }
function fmtSales(n) { return n >= 1e9 ? '$'+(n/1e9).toFixed(1)+'B' : n >= 1e6 ? '$'+(n/1e6).toFixed(0)+'M' : n >= 1e3 ? '$'+(n/1e3).toFixed(0)+'K' : n > 0 ? '$'+n : 'â€”'; }

// ===== ACCOUNT DATA (localStorage) =====
function acctKey(name) { return 'xits_acct_' + name.replace(/[^a-zA-Z0-9]/g,'_').toLowerCase(); }
function getAcctData(name) {
    try { return JSON.parse(localStorage.getItem(acctKey(name))) || {}; } catch { return {}; }
}
function setAcctData(name, data) { localStorage.setItem(acctKey(name), JSON.stringify(data)); }

// ===== STAGE CONFIG (7-stage pipeline) =====
const STAGE_CONFIG = {
    'Prospecting':     { prob: 5,   minDays: 14, maxDays: 42,  color: '#6366f1', order: 0 },
    'Discovery':       { prob: 20,  minDays: 21, maxDays: 70,  color: '#3b82f6', order: 1 },
    'Solution Design': { prob: 35,  minDays: 28, maxDays: 98,  color: '#0ea5e9', order: 2 },
    'Proposal':        { prob: 50,  minDays: 21, maxDays: 70,  color: '#14b8a6', order: 3 },
    'Negotiation':     { prob: 75,  minDays: 28, maxDays: 98,  color: '#f59e0b', order: 4 },
    'Verbal Commit':   { prob: 90,  minDays: 7,  maxDays: 42,  color: '#22c55e', order: 5 },
    'Closed Won':      { prob: 100, minDays: 0,  maxDays: 0,   color: '#10b981', order: 6 }
};
const KANBAN_STAGES = Object.keys(STAGE_CONFIG);

function stageTag(stage) {
    const cls = {
        'Fresh':'tag-fresh','Prospecting':'tag-prospecting','Discovery':'tag-discovery',
        'Solution Design':'tag-solution-design','Needs Analysis':'tag-needs-analysis',
        'Qualifying':'tag-qualifying','Proposal':'tag-proposal','Negotiation':'tag-negotiation',
        'Verbal Commit':'tag-verbal-commit','Closed Won':'tag-won','Closed Lost':'tag-lost'
    };
    return `<span class="tag ${cls[stage]||'tag-fresh'}">${stage||'Fresh'}</span>`;
}

function pillarDots(pillars) {
    if (!pillars || !pillars.length) return '<span style="color:var(--text3);font-size:10px;">â€”</span>';
    const abbrev = {'Cloud':'CLD','Virtualization':'VRT','Infrastructure':'INF','Endpoint':'END','Security':'SEC',
        'Data Protection':'BKP','Print/Doc Mgmt':'PRT','Network':'NET','AI/Copilot':'AI','Managed IT':'MIT',
        'Prof Services':'PRO','Support Svc':'SUP'};
    return '<div class="pillar-dots">' + pillars.map(p => `<span class="pdot">${abbrev[p]||p.slice(0,3)}</span>`).join('') + '</div>';
}

function flagIcons(flags) {
    if (!flags || !flags.length) return '';
    const icons = {rfp:'&#128196;',expiring:'&#9200;',budget:'&#128176;',dm:'&#128100;',proposal:'&#128233;',competitor:'&#9876;'};
    return '<div class="flag-icons">' + flags.map(f => `<span class="flag-icon" title="${f}">${icons[f]||''}</span>`).join('') + '</div>';
}

// ===== RENDER: ENT =====
function renderEnt(f='',p='',s='') {
    const fl = f.toLowerCase();
    const filtered = entAccounts.filter(a => {
        if (fl && !JSON.stringify(a).toLowerCase().includes(fl)) return false;
        if (p && a.priority !== p) return false;
        if (s && a.sector !== s) return false;
        return true;
    });
    document.getElementById('entCount').textContent = filtered.length;
    document.querySelector('#entTable tbody').innerHTML = filtered.map(a => {
        const d = getAcctData(a.name);
        return `<tr onclick="openModal('${a.name.replace(/'/g,"\\'")}','ent')">
        <td><strong style="color:var(--text)">${a.name}</strong></td>
        <td style="font-size:11px;">${a.sector}</td>
        <td style="font-family:var(--mono);font-size:11px;">${a.emp ? fmt(a.emp) : 'â€”'}</td>
        <td style="font-size:11px;">${a.city}</td>
        <td>${ptag(a.priority)}</td>
        <td>${stageTag(d.stage)}</td>
        <td style="font-family:var(--mono);font-size:11px;color:var(--accent2);">${d.value ? '$'+Number(d.value).toLocaleString() : 'â€”'}</td>
        <td style="text-align:center;">${healthDot(d)}</td>
        <td>${pillarDots(d.pillars)}</td>
        <td>${flagIcons(d.flags)}</td>
    </tr>`;}).join('');
}

// ===== RENDER: SMB =====
function renderSmb(f='',ind='') {
    const fl = f.toLowerCase();
    const filtered = smbAccounts.filter(a => {
        if (fl && !JSON.stringify(a).toLowerCase().includes(fl)) return false;
        if (ind && a.industry !== ind) return false;
        return true;
    });
    document.getElementById('smbCount').textContent = filtered.length;
    document.querySelector('#smbTable tbody').innerHTML = filtered.map(a => {
        const d = getAcctData(a.name);
        return `<tr onclick="openModal('${a.name.replace(/'/g,"\\'")}','smb')">
        <td><strong style="color:var(--text)">${a.name}</strong></td>
        <td style="font-size:11px;">${a.industry}</td>
        <td style="font-family:var(--mono);font-size:11px;">${a.emp ? fmt(a.emp) : 'â€”'}</td>
        <td style="font-size:11px;">${a.city}</td>
        <td>${stageTag(d.stage)}</td>
        <td style="font-family:var(--mono);font-size:11px;color:var(--accent2);">${d.value ? '$'+Number(d.value).toLocaleString() : 'â€”'}</td>
        <td style="text-align:center;">${healthDot(d)}</td>
        <td>${pillarDots(d.pillars)}</td>
        <td>${flagIcons(d.flags)}</td>
    </tr>`;}).join('');
}

// ===== RENDER: K-12 =====
function renderK12(f='',p='') {
    const fl = f.toLowerCase();
    document.querySelector('#k12Table tbody').innerHTML = k12.filter(a => {
        if (fl && !JSON.stringify(a).toLowerCase().includes(fl)) return false;
        if (p && a.priority !== p) return false;
        return true;
    }).map(a => {
        const d = getAcctData(a.name);
        return `<tr onclick="openModal('${a.name.replace(/'/g,"\\'")}','k12')">
        <td><strong style="color:var(--text)">${a.name}</strong></td>
        <td>${a.type}</td>
        <td>${a.region || 'â€”'}</td>
        <td style="font-family:var(--mono);font-size:11px;">${a.students ? fmt(a.students) : 'â€”'}</td>
        <td style="font-size:11px;">${a.incumbent}</td>
        <td style="font-size:11px;">${a.cfo || 'â€”'}</td>
        <td style="font-size:11px;">${a.it || 'â€”'}</td>
        <td>${ptag(a.priority)}</td>
    </tr>`;}).join('');
}

// ===== RENDER: HIGHER ED =====
function renderHigherEd() {
    document.querySelector('#higheredTable tbody').innerHTML = higherEd.map(a => {
        const d = getAcctData(a.name);
        return `<tr onclick="openModal('${a.name.replace(/'/g,"\\'")}','highered')">
        <td><strong style="color:var(--text)">${a.name}</strong></td>
        <td>${a.type}</td>
        <td>${a.city}</td>
        <td>${ptag(a.priority)}</td>
        <td style="font-size:11px;">${a.mps}</td>
        <td style="font-size:11px;">${a.cloud}</td>
        <td style="font-size:11px;">${a.mit}</td>
        <td>${stageTag(d.stage)}</td>
    </tr>`;}).join('');
}

// ===== RENDER: CREDIT UNIONS =====
function renderCU(f='') {
    const fl = f.toLowerCase();
    document.querySelector('#cuTable tbody').innerHTML = creditUnions.filter(a => {
        if (fl && !JSON.stringify(a).toLowerCase().includes(fl)) return false;
        return true;
    }).map(a => {
        const d = getAcctData(a.name);
        return `<tr onclick="openModal('${a.name.replace(/'/g,"\\'")}','cu')">
        <td><strong style="color:var(--text)">${a.name}</strong></td>
        <td style="font-family:var(--mono);font-size:11px;">#${a.rank}</td>
        <td style="font-family:var(--mono);font-size:11px;">$${(a.assets/1e9).toFixed(1)}B</td>
        <td style="font-family:var(--mono);font-size:11px;">${fmt(a.members)}</td>
        <td style="font-family:var(--mono);font-size:11px;">${a.locations}</td>
        <td>${a.city || 'â€”'}</td>
        <td>${ptag(a.priority)}</td>
    </tr>`;}).join('');
}

// ===== NAV =====
document.querySelectorAll('.topbar-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.topbar-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.page).classList.add('active');
        if (tab.dataset.page === 'pillars') renderWhitespaceHeatmap();
        if (tab.dataset.page === 'territory') { initTerritoryMap(); setTimeout(() => { if (territoryMap) territoryMap.invalidateSize(); }, 100); }
        window.scrollTo(0, 0);
    });
});

// ===== FILTERS =====
document.getElementById('entSearch').addEventListener('input', e => renderEnt(e.target.value, document.getElementById('entPriority').value, document.getElementById('entSector').value));
document.getElementById('entPriority').addEventListener('change', e => renderEnt(document.getElementById('entSearch').value, e.target.value, document.getElementById('entSector').value));
document.getElementById('entSector').addEventListener('change', e => renderEnt(document.getElementById('entSearch').value, document.getElementById('entPriority').value, e.target.value));
document.getElementById('smbSearch').addEventListener('input', e => renderSmb(e.target.value, document.getElementById('smbIndustry').value));
document.getElementById('smbIndustry').addEventListener('change', e => renderSmb(document.getElementById('smbSearch').value, e.target.value));
document.getElementById('k12Search').addEventListener('input', e => renderK12(e.target.value, document.getElementById('k12Priority').value));
document.getElementById('k12Priority').addEventListener('change', e => renderK12(document.getElementById('k12Search').value, e.target.value));
document.getElementById('cuSearch').addEventListener('input', e => renderCU(e.target.value));

// ===== INIT =====
renderEnt(); renderSmb(); renderK12(); renderHigherEd(); renderCU();

// Monthly calc
const now = new Date();
const monthsLeft = 12 - now.getMonth();
const remaining = 2976000;
document.getElementById('monthsLeft').textContent = monthsLeft;
document.getElementById('monthlyNeeded').textContent = '$' + Math.round(remaining / monthsLeft / 1000) + 'K/mo needed';
document.getElementById('calcMonthly').textContent = '$' + Math.round(remaining / monthsLeft / 1000) + 'K';
const pct = (24000 / 3000000 * 100).toFixed(1);
document.getElementById('targetPct').textContent = pct + '%';
document.getElementById('targetBar').style.width = pct + '%';

// ===== SECTION TABS (Playbook & Tools sub-navigation) =====
document.querySelectorAll('.section-tabs').forEach(tabGroup => {
    tabGroup.querySelectorAll('.section-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const parent = tab.closest('.page');
            parent.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
            parent.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.sec).classList.add('active');
        });
    });
});

// ===== COPY EMAIL =====
function copyEmail(btn) {
    const body = btn.previousElementSibling.textContent || btn.parentElement.querySelector('.email-body').textContent;
    navigator.clipboard.writeText(body.trim()).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy to clipboard', 2000);
    });
}

// ===== DEAL CALCULATOR =====
function calcDeal() {
    const name = document.getElementById('dc-name').value || 'Unnamed Deal';
    const mitPrice = parseFloat(document.getElementById('dc-mit-price').value) || 0;
    const seats = parseFloat(document.getElementById('dc-seats').value) || 0;
    const csp = parseFloat(document.getElementById('dc-csp').value) || 0;
    const security = parseFloat(document.getElementById('dc-security').value) || 0;
    const hw = parseFloat(document.getElementById('dc-hw').value) || 0;
    const mps = parseFloat(document.getElementById('dc-mps').value) || 0;
    const other = parseFloat(document.getElementById('dc-other').value) || 0;

    const mitMonthly = mitPrice * seats;
    const cspMonthly = csp * seats;
    const mpsMonthly = mps;
    const totalMRR = mitMonthly + cspMonthly + mpsMonthly;
    const totalARR = (totalMRR * 12) + security + other;
    const totalYear1 = totalARR + hw;
    const total3yr = (totalARR * 3) + hw;
    const pctOfTarget = ((totalYear1 / 3000000) * 100).toFixed(1);

    document.getElementById('dealResult').innerHTML = `
        <h3 style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px;">${name}</h3>
        <div class="deal-result">
            <div class="dr-row"><span class="dr-label">Managed IT (${seats} seats Ã— $${mitPrice}/mo)</span><span class="dr-val">$${mitMonthly.toLocaleString()}/mo</span></div>
            <div class="dr-row"><span class="dr-label">M365 CSP (${seats} users Ã— $${csp}/mo)</span><span class="dr-val">$${cspMonthly.toLocaleString()}/mo</span></div>
            <div class="dr-row"><span class="dr-label">GreenLake / as-a-Service</span><span class="dr-val">$${mpsMonthly.toLocaleString()}/mo</span></div>
            <div class="dr-row" style="border-top:1px solid var(--border);padding-top:8px;margin-top:4px;">
                <span class="dr-label" style="font-weight:700;">Total MRR</span>
                <span class="dr-val" style="font-size:16px;">$${totalMRR.toLocaleString()}/mo</span>
            </div>
        </div>
        <div class="deal-result" style="margin-top:8px;background:rgba(79,140,255,.06);border-color:rgba(79,140,255,.15);">
            <div class="dr-row"><span class="dr-label">Recurring ARR (MRR Ã— 12 + Security + Other)</span><span class="dr-val" style="color:var(--accent);">$${totalARR.toLocaleString()}</span></div>
            <div class="dr-row"><span class="dr-label">Hardware / One-Time</span><span class="dr-val" style="color:var(--accent);">$${hw.toLocaleString()}</span></div>
            <div class="dr-row" style="border-top:1px solid var(--border);padding-top:8px;margin-top:4px;">
                <span class="dr-label" style="font-weight:700;">Year 1 Total Value</span>
                <span class="dr-val" style="font-size:18px;color:var(--accent2);">$${totalYear1.toLocaleString()}</span>
            </div>
            <div class="dr-row"><span class="dr-label">3-Year Contract Value</span><span class="dr-val" style="color:var(--accent3);">$${total3yr.toLocaleString()}</span></div>
            <div class="dr-row"><span class="dr-label">% of $3M Target</span><span class="dr-val" style="color:var(--accent2);">${pctOfTarget}%</span></div>
        </div>
    `;
}

// ===== NOTES (localStorage) =====
['notesWeekly','notesPipeline','notesGeneral'].forEach(id => {
    const el = document.getElementById(id);
    const saved = localStorage.getItem('xits_' + id);
    if (saved) el.value = saved;
    let timer;
    el.addEventListener('input', () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
            localStorage.setItem('xits_' + id, el.value);
            const indicator = document.getElementById(id.replace('notes','notesSaved'));
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1500);
        }, 500);
    });
});

// ===== ACCOUNT DETAIL MODAL =====
let currentModalAcct = '';
let currentModalType = '';

// Checkbox toggle â€” use preventDefault to stop label's native double-toggle
document.querySelectorAll('.check-item').forEach(item => {
    item.addEventListener('click', (e) => {
        e.preventDefault();
        const cb = item.querySelector('input');
        cb.checked = !cb.checked;
        item.classList.toggle('checked', cb.checked);
    });
});

// Competitor chip toggles
document.querySelectorAll('#m-comp-all .comp-chip').forEach(chip => {
    chip.addEventListener('click', () => chip.classList.toggle('selected'));
});

// Show/hide Closed Lost section based on stage
document.getElementById('m-stage').addEventListener('change', function() {
    document.getElementById('closedLostSection').style.display = this.value === 'Closed Lost' ? '' : 'none';
});

function openModal(name, type) {
    currentModalAcct = name;
    currentModalType = type;
    const d = getAcctData(name);
    document.getElementById('modalAcctName').textContent = name;

    // Populate fields
    document.getElementById('m-stage').value = d.stage || 'Fresh';
    document.getElementById('m-value').value = d.value || '';
    document.getElementById('m-prob').value = d.prob || '';
    document.getElementById('m-close-q').value = d.closeQ || '';
    document.getElementById('m-incumbent').value = d.incumbent || '';
    renderModalContacts(d.contacts || []);
    document.getElementById('m-followup').value = d.followUp || '';
    document.getElementById('m-expiry').value = d.expiry || '';
    document.getElementById('m-lastcontact').value = d.lastContact || '';
    document.getElementById('m-nextaction').value = d.nextAction || '';
    document.getElementById('m-source').value = d.dealSource || '';
    document.getElementById('m-notes').value = d.notes || '';

    // Competitors
    const comp = d.competitors || {};
    document.getElementById('m-comp-primary').value = comp.primary || '';
    document.getElementById('m-comp-threat').value = comp.threatLevel || '';
    document.getElementById('m-comp-price').value = comp.pricePosition || '';
    const allPresent = comp.allPresent || [];
    document.querySelectorAll('#m-comp-all .comp-chip').forEach(chip => {
        chip.classList.toggle('selected', allPresent.includes(chip.dataset.comp));
    });

    // Closed Lost fields
    document.getElementById('m-lost-to').value = comp.lostTo || '';
    document.getElementById('m-loss-reason').value = d.lossReason || '';
    document.getElementById('closedLostSection').style.display = (d.stage === 'Closed Lost') ? '' : 'none';

    // MEDDPICC
    const meddpicc = d.meddpicc || {};
    document.querySelectorAll('#meddpiccPanel input[type="range"]').forEach(slider => {
        const val = meddpicc[slider.dataset.meddpicc] || 0;
        slider.value = val;
        slider.nextElementSibling.textContent = val;
    });
    updateMEDDPICC();

    // Pillars
    document.querySelectorAll('#m-pillars .check-item').forEach(item => {
        const val = item.dataset.val;
        const checked = d.pillars && d.pillars.includes(val);
        item.querySelector('input').checked = checked;
        item.classList.toggle('checked', checked);
    });

    // Flags
    document.querySelectorAll('#m-flags .check-item').forEach(item => {
        const val = item.dataset.val;
        const checked = d.flags && d.flags.includes(val);
        item.querySelector('input').checked = checked;
        item.classList.toggle('checked', checked);
    });

    document.getElementById('acctModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('acctModal').classList.add('hidden');
    currentModalAcct = '';
}

function saveModal() {
    const pillars = [];
    document.querySelectorAll('#m-pillars .check-item input:checked').forEach(cb => {
        pillars.push(cb.closest('.check-item').dataset.val);
    });
    const flags = [];
    document.querySelectorAll('#m-flags .check-item input:checked').forEach(cb => {
        flags.push(cb.closest('.check-item').dataset.val);
    });

    // Collect MEDDPICC scores
    const meddpicc = {};
    document.querySelectorAll('#meddpiccPanel input[type="range"]').forEach(slider => {
        meddpicc[slider.dataset.meddpicc] = parseInt(slider.value) || 0;
    });

    const newStage = document.getElementById('m-stage').value;
    const oldData = getAcctData(currentModalAcct);

    // Collect competitor data
    const allPresent = [];
    document.querySelectorAll('#m-comp-all .comp-chip.selected').forEach(chip => {
        allPresent.push(chip.dataset.comp);
    });
    const competitors = {
        primary: document.getElementById('m-comp-primary').value,
        allPresent: allPresent,
        threatLevel: document.getElementById('m-comp-threat').value,
        pricePosition: document.getElementById('m-comp-price').value,
        lostTo: document.getElementById('m-lost-to').value
    };
    const lossReason = document.getElementById('m-loss-reason').value;

    // Enforce Closed Lost requirements
    if (newStage === 'Closed Lost') {
        if (!competitors.lostTo) { showToast('error', 'Please select who you lost to before marking Closed Lost.'); return; }
        if (!lossReason) { showToast('error', 'Please select a loss reason before marking Closed Lost.'); return; }
    }

    // Track stage changes
    const stageChanged = oldData.stage !== newStage;
    const stageEnteredDate = stageChanged ? new Date().toISOString().slice(0, 10) : (oldData.stageEnteredDate || new Date().toISOString().slice(0, 10));

    const data = {
        stage: newStage,
        value: document.getElementById('m-value').value,
        prob: document.getElementById('m-prob').value,
        closeQ: document.getElementById('m-close-q').value,
        incumbent: document.getElementById('m-incumbent').value,
        pillars: pillars,
        flags: flags,
        contacts: oldData.contacts || [],
        competitors: competitors,
        lossReason: lossReason,
        followUp: document.getElementById('m-followup').value,
        expiry: document.getElementById('m-expiry').value,
        lastContact: document.getElementById('m-lastcontact').value,
        nextAction: document.getElementById('m-nextaction').value,
        dealSource: document.getElementById('m-source').value,
        notes: document.getElementById('m-notes').value,
        meddpicc: meddpicc,
        stageEnteredDate: stageEnteredDate,
        activities: oldData.activities || [],
    };

    // Auto-set probability from stage config if user didn't manually set it
    if (STAGE_CONFIG[newStage] && (!data.prob || stageChanged)) {
        data.prob = String(STAGE_CONFIG[newStage].prob);
    }

    setAcctData(currentModalAcct, data);
    closeModal();

    // Re-render the table that was open
    if (currentModalType === 'ent' || !currentModalType) {
        renderEnt(document.getElementById('entSearch').value, document.getElementById('entPriority').value, document.getElementById('entSector').value);
    }
    if (currentModalType === 'smb' || !currentModalType) {
        renderSmb(document.getElementById('smbSearch').value, document.getElementById('smbIndustry').value);
    }
    renderK12(document.getElementById('k12Search') ? document.getElementById('k12Search').value : '', document.getElementById('k12Priority') ? document.getElementById('k12Priority').value : '');
    renderHigherEd();
    renderCU(document.getElementById('cuSearch') ? document.getElementById('cuSearch').value : '');
    updateDashPipeline();
    updateCompetitorFootprint();
    updateDashFollowUps();
    updateDashFlags();
    updateStageBreakdown();
    updateStaleAccounts();
    updateHotDeals();
    updateKPICards();
    updateAtRiskPanel();
    renderWhitespaceHeatmap();
    renderKanban();
    syncPipelineToProxy();
}

// Close modal on overlay click
document.getElementById('acctModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('acctModal')) closeModal();
});
// Close on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeModal();
        document.getElementById('calSetupModal').classList.add('hidden');
        document.getElementById('digestModal').classList.add('hidden');
    }
});
document.getElementById('calSetupModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('calSetupModal')) document.getElementById('calSetupModal').classList.add('hidden');
});
document.getElementById('digestModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('digestModal')) document.getElementById('digestModal').classList.add('hidden');
});

// ===== MEETINGS WIDGET (Live Calendar + Manual Fallback) =====
document.getElementById('mtgToggleAdd').addEventListener('click', function() {
    const form = document.getElementById('mtgAddForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
    if (form.style.display === 'block') {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 60 - now.getMinutes() % 15);
        document.getElementById('mtg-dt').value = now.toISOString().slice(0, 16);
        document.getElementById('mtg-title').value = '';
        document.getElementById('mtg-acct').value = '';
        document.getElementById('mtg-title').focus();
    }
});

function getMeetings() {
    try { return JSON.parse(localStorage.getItem('xits_meetings')) || []; } catch { return []; }
}
function saveMeetings(m) { localStorage.setItem('xits_meetings', JSON.stringify(m)); }

function addMeeting() {
    const dt = document.getElementById('mtg-dt').value;
    const title = document.getElementById('mtg-title').value.trim();
    if (!dt || !title) return;
    const meetings = getMeetings();
    meetings.push({ id: Date.now(), dt, title, acct: document.getElementById('mtg-acct').value.trim(), source: 'manual' });
    saveMeetings(meetings);
    document.getElementById('mtgAddForm').style.display = 'none';
    renderMeetings();
}

function deleteMeeting(id) {
    const meetings = getMeetings().filter(m => m.id !== id);
    saveMeetings(meetings);
    renderMeetings();
}

function formatMtgItem(d, title, subtitle, extra) {
    const today = new Date(); today.setHours(0,0,0,0);
    const tmrw = new Date(today); tmrw.setDate(tmrw.getDate() + 1);
    const mDate = new Date(d); mDate.setHours(0,0,0,0);
    let dayLabel = d.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
    if (mDate.getTime() === today.getTime()) dayLabel = 'Today';
    else if (mDate.getTime() === tmrw.getTime()) dayLabel = 'Tomorrow';
    const timeStr = d.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit', hour12: true });
    const isToday = mDate.getTime() === today.getTime();
    const timeColor = isToday ? 'var(--accent2)' : 'var(--accent)';
    return `<div class="mtg-item">
        <div class="mtg-time" style="color:${timeColor};">${timeStr}<div class="mtg-date">${dayLabel}</div></div>
        <div class="mtg-info"><div class="mtg-title">${title}</div>${subtitle ? `<div class="mtg-acct">${subtitle}</div>` : ''}</div>
        ${extra || ''}
    </div>`;
}

// --- Live Calendar Fetch (Google API + Xerox ICS) ---
let calApiKey = localStorage.getItem('xits_cal_apikey') || '';
let calCalId = localStorage.getItem('xits_cal_id') || '';
const xeroxProxyUrl = 'http://127.0.0.1:18790/';
let calEvents = [];

function calConnected() { return true; }

function fetchCalendarEvents() {
    const el = document.getElementById('dashMeetings');
    el.innerHTML = '<div class="action-item" style="color:var(--text3);font-style:italic;">Fetching calendars...</div>';
    const promises = [];

    // Fetch Xerox calendar via local proxy (CORS-safe)
    promises.push(
        fetch(xeroxProxyUrl).then(r => {
            if (!r.ok) throw new Error('Proxy ' + r.status);
            return r.json();
        }).then(data => data.map(ev => ({
            dt: ev.dt,
            title: ev.title || 'No title',
            acct: ev.location || '',
            source: 'xerox'
        }))).catch(err => {
            console.warn('Xerox calendar fetch failed:', err);
            return [];
        })
    );

    // Fetch Google Calendar API (if configured)
    if (calApiKey && calCalId) {
        const now = new Date().toISOString();
        const end = new Date(Date.now() + 7*24*60*60*1000).toISOString();
        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calCalId)}/events?key=${calApiKey}&timeMin=${now}&timeMax=${end}&maxResults=10&singleEvents=true&orderBy=startTime`;
        promises.push(
            fetch(url).then(r => {
                if (!r.ok) throw new Error('GCal ' + r.status);
                return r.json();
            }).then(data => (data.items || []).map(ev => ({
                dt: (ev.start && (ev.start.dateTime || ev.start.date)) || '',
                title: ev.summary || 'No title',
                acct: ev.location || '',
                source: 'gcal'
            }))).catch(err => {
                console.warn('Google Calendar fetch failed:', err);
                return [];
            })
        );
    }

    Promise.all(promises).then(results => {
        // Merge & deduplicate (same title within 5 min = duplicate)
        const all = results.flat();
        const seen = new Set();
        calEvents = [];
        all.sort((a,b) => new Date(a.dt) - new Date(b.dt));
        all.forEach(ev => {
            const key = ev.title.toLowerCase().trim() + '|' + new Date(ev.dt).toISOString().slice(0, 15);
            if (!seen.has(key)) {
                seen.add(key);
                calEvents.push(ev);
            }
        });
        localStorage.setItem('xits_cal_cache', JSON.stringify({ ts: Date.now(), events: calEvents }));
        document.getElementById('mtgLiveIndicator').style.display = 'inline';
        document.getElementById('mtgLiveIndicator').textContent = 'LIVE';
        document.getElementById('mtgLiveIndicator').style.color = '#34d399';
        document.getElementById('mtgLiveIndicator').style.background = 'rgba(52,211,153,.15)';
        document.getElementById('mtgRefreshBtn').style.display = 'inline';
        document.getElementById('calSetupBtn').style.background = 'rgba(52,211,153,.15)';
        document.getElementById('calSetupBtn').style.color = '#34d399';
        renderMeetings();
    });
}

function renderMeetings() {
    const el = document.getElementById('dashMeetings');
    if (!el) return;
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    // Combine live calendar events + manual meetings
    let combined = [];

    // Add calendar events
    calEvents.forEach(ev => {
        const d = new Date(ev.dt);
        if (d >= todayStart) combined.push({ dt: d, title: ev.title, acct: ev.acct, source: 'gcal' });
    });

    // Add manual meetings
    getMeetings().forEach(m => {
        const d = new Date(m.dt);
        if (d >= todayStart) combined.push({ dt: d, title: m.title, acct: m.acct, source: 'manual', id: m.id });
    });

    combined.sort((a, b) => a.dt - b.dt);

    if (combined.length === 0) {
        const msg = calConnected() ? 'No upcoming meetings on your calendar.' : 'No meetings yet. Hit + to add, or connect Google Calendar via the gear icon.';
        el.innerHTML = `<div class="action-item" style="color:var(--text3);font-style:italic;">${msg}</div>`;
        return;
    }

    el.innerHTML = combined.slice(0, 5).map(m => {
        const delBtn = m.source === 'manual' ? `<span class="mtg-del" onclick="deleteMeeting(${m.id})" title="Remove">&times;</span>` : '';
        return formatMtgItem(m.dt, m.title, m.acct, delBtn);
    }).join('');
    if (combined.length > 5) {
        el.innerHTML += `<div style="font-size:10px;color:var(--text3);margin-top:6px;text-align:center;">+${combined.length - 5} more</div>`;
    }
}

// --- Calendar Setup ---
function showCalSetup() {
    document.getElementById('calApiKey').value = calApiKey;
    document.getElementById('calCalId').value = calCalId;
    document.getElementById('calTestResult').textContent = '';
    document.getElementById('calSetupModal').classList.remove('hidden');
}
function saveCalApi() {
    const key = document.getElementById('calApiKey').value.trim();
    const cid = document.getElementById('calCalId').value.trim();
    if (!key || !cid) { document.getElementById('calTestResult').textContent = 'Both fields are required.'; return; }
    localStorage.setItem('xits_cal_apikey', key);
    localStorage.setItem('xits_cal_id', cid);
    calApiKey = key;
    calCalId = cid;
    document.getElementById('calTestResult').innerHTML = '<span style="color:var(--accent);">Saved! Testing connection...</span>';
    fetchCalendarEvents();
    setTimeout(() => {
        if (calEvents.length > 0) {
            document.getElementById('calTestResult').innerHTML = '<span style="color:var(--accent2);">Connected! Found ' + calEvents.length + ' upcoming events.</span>';
        } else {
            document.getElementById('calTestResult').innerHTML = '<span style="color:var(--accent3);">Connected but 0 events in next 7 days. If this is wrong, check Calendar ID and that the calendar is public.</span>';
        }
    }, 3000);
}
function clearCalApi() {
    localStorage.removeItem('xits_cal_apikey');
    localStorage.removeItem('xits_cal_id');
    localStorage.removeItem('xits_cal_cache');
    calApiKey = '';
    calCalId = '';
    calEvents = [];
    document.getElementById('calApiKey').value = '';
    document.getElementById('calCalId').value = '';
    document.getElementById('calTestResult').innerHTML = '<span style="color:var(--text3);">Disconnected.</span>';
    document.getElementById('mtgLiveIndicator').style.display = 'none';
    document.getElementById('mtgRefreshBtn').style.display = 'none';
    document.getElementById('calSetupBtn').style.background = 'var(--border)';
    document.getElementById('calSetupBtn').style.color = 'var(--text2)';
    renderMeetings();
}

// --- End of Day Digest ---
function generateDigest() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-CA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];

    let totalPipeline = 0; let dealCount = 0;
    let activeDeals = []; let flaggedAccts = []; let followUps = [];
    const incumbentCounts = {};

    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (d.stage && d.stage !== 'Fresh') {
            if (d.value && d.stage !== 'Closed Lost') {
                totalPipeline += Number(d.value) || 0;
                dealCount++;
                activeDeals.push({ name, stage: d.stage, value: Number(d.value) || 0, prob: d.prob || 'â€”' });
            }
        }
        if (d.flags && d.flags.length > 0) flaggedAccts.push({ name, flags: d.flags });
        if (d.followUp) {
            const diff = Math.round((new Date(d.followUp + 'T00:00:00') - new Date(now.getFullYear(), now.getMonth(), now.getDate())) / 86400000);
            if (diff <= 7) followUps.push({ name, date: d.followUp, diff });
        }
        if (d.incumbent) {
            incumbentCounts[d.incumbent] = (incumbentCounts[d.incumbent] || 0) + 1;
        }
    });

    activeDeals.sort((a, b) => b.value - a.value);
    followUps.sort((a, b) => a.diff - b.diff);

    let digest = `POWERLAND / XEROX IT SOLUTIONS â€” DAILY DIGEST\n${dateStr}\n${'='.repeat(50)}\n\n`;
    digest += `PIPELINE SNAPSHOT\n`;
    digest += `  Total Pipeline:  $${totalPipeline.toLocaleString()}\n`;
    digest += `  Active Deals:    ${dealCount}\n`;
    digest += `  Target:          $3,000,000\n`;
    digest += `  Gap:             $${(3000000 - totalPipeline).toLocaleString()}\n\n`;

    if (activeDeals.length > 0) {
        digest += `TOP OPPORTUNITIES\n`;
        activeDeals.slice(0, 8).forEach(d => {
            digest += `  ${d.name.padEnd(35)} ${d.stage.padEnd(14)} $${d.value.toLocaleString().padStart(10)}  (${d.prob}%)\n`;
        });
        digest += '\n';
    }

    if (followUps.length > 0) {
        digest += `FOLLOW-UPS THIS WEEK\n`;
        followUps.forEach(f => {
            const label = f.diff < 0 ? 'OVERDUE' : f.diff === 0 ? 'TODAY' : f.date;
            digest += `  ${f.name.padEnd(35)} ${label}\n`;
        });
        digest += '\n';
    }

    if (flaggedAccts.length > 0) {
        const flagLabels = { rfp:'RFP', expiring:'Expiring', budget:'Budget', dm:'Decision Maker', proposal:'Proposal', competitor:'Competitor' };
        digest += `FLAGGED ACCOUNTS\n`;
        flaggedAccts.forEach(f => {
            digest += `  ${f.name.padEnd(35)} ${f.flags.map(fl => flagLabels[fl] || fl).join(', ')}\n`;
        });
        digest += '\n';
    }

    if (Object.keys(incumbentCounts).length > 0) {
        digest += `IT INCUMBENT MAP\n`;
        Object.entries(incumbentCounts).sort((a,b) => b[1] - a[1]).forEach(([k, v]) => {
            digest += `  ${k.padEnd(20)} ${v} accounts\n`;
        });
        digest += '\n';
    }

    // Manual meetings
    const manualMtgs = getMeetings().filter(m => {
        const d = new Date(m.dt);
        return d >= new Date(now.getFullYear(), now.getMonth(), now.getDate()) && d < new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2);
    });
    if (manualMtgs.length > 0 || calEvents.length > 0) {
        digest += `TODAY'S MEETINGS\n`;
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const todayEnd = new Date(todayStart); todayEnd.setDate(todayEnd.getDate() + 1);
        [...calEvents, ...manualMtgs].filter(m => {
            const d = new Date(m.dt);
            return d >= todayStart && d < todayEnd;
        }).forEach(m => {
            const d = new Date(m.dt);
            const t = d.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit', hour12: true });
            digest += `  ${t.padEnd(10)} ${m.title}${m.acct ? ' â€” ' + m.acct : ''}\n`;
        });
        digest += '\n';
    }

    // Quick Notes
    const notes = {};
    ['notesWeekly','notesPipeline','notesGeneral'].forEach(id => {
        const v = localStorage.getItem('xits_' + id);
        if (v && v.trim()) {
            const label = id === 'notesWeekly' ? 'Weekly Focus' : id === 'notesPipeline' ? 'Pipeline Notes' : 'General Notes';
            notes[label] = v.trim();
        }
    });
    if (Object.keys(notes).length > 0) {
        digest += `NOTES\n`;
        Object.entries(notes).forEach(([label, text]) => {
            digest += `  [${label}]\n  ${text.split('\n').join('\n  ')}\n\n`;
        });
    }

    digest += `${'='.repeat(50)}\nGenerated ${now.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit', hour12: true })} â€” Powerland Prospecting Hub`;

    document.getElementById('digestContent').textContent = digest;
    document.getElementById('digestModal').classList.remove('hidden');
}

function copyDigest() {
    const text = document.getElementById('digestContent').textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('#digestModal .modal-btn-primary');
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy to Clipboard', 1500);
    });
}

// Init: Load cache for instant render, then fetch live
const _calCache = localStorage.getItem('xits_cal_cache');
if (_calCache) {
    try {
        const c = JSON.parse(_calCache);
        calEvents = c.events || [];
        document.getElementById('mtgLiveIndicator').style.display = 'inline';
        document.getElementById('mtgRefreshBtn').style.display = 'inline';
        document.getElementById('calSetupBtn').style.background = 'rgba(52,211,153,.15)';
        document.getElementById('calSetupBtn').style.color = '#34d399';
        renderMeetings();
    } catch(e) {}
}
fetchCalendarEvents();

// ===== DASHBOARD PIPELINE SUMMARY =====
function updateDashPipeline() {
    let totalPipeline = 0;
    let dealCount = 0;
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];
    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (d.value && d.stage && d.stage !== 'Fresh' && d.stage !== 'Closed Lost') {
            totalPipeline += Number(d.value) || 0;
            dealCount++;
        }
    });
    const el = document.getElementById('pipelineKpi');
    if (el) {
        el.querySelector('.kpi-value').textContent = totalPipeline >= 1e6 ? '$'+(totalPipeline/1e6).toFixed(1)+'M' : totalPipeline >= 1e3 ? '$'+(totalPipeline/1e3).toFixed(0)+'K' : '$'+totalPipeline;
        el.querySelector('.kpi-sub').textContent = dealCount + ' active opportunities';
    }
}

function updateCompetitorFootprint() {
    const counts = { 'WBM':0, 'Horizon':0, 'PC Place':0, 'Wolf Strata':0, 'Compugen':0, 'Internal IT':0, 'Other':0, '':0 };
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];
    let total = allAccts.length;
    allAccts.forEach(name => {
        const d = getAcctData(name);
        const inc = d.incumbent || '';
        if (inc in counts) counts[inc]++;
        else counts['Other']++;
    });
    const unknown = counts[''] + counts['Other'] + counts['Internal IT'];
    const mapping = [
        { key:'WBM', bar:'cf-wbm-bar', ct:'cf-wbm-ct' },
        { key:'Horizon', bar:'cf-horizon-bar', ct:'cf-horizon-ct' },
        { key:'PC Place', bar:'cf-pcplace-bar', ct:'cf-pcplace-ct' },
        { key:'Wolf Strata', bar:'cf-wolfstrata-bar', ct:'cf-wolfstrata-ct' },
        { key:'Compugen', bar:'cf-compugen-bar', ct:'cf-compugen-ct' },
    ];
    mapping.forEach(m => {
        const c = counts[m.key];
        const pct = total > 0 ? Math.max(5, Math.round((c / total) * 100)) : 5;
        const barEl = document.getElementById(m.bar);
        const ctEl = document.getElementById(m.ct);
        if (barEl) { barEl.style.width = (c > 0 ? pct : 5) + '%'; barEl.textContent = c > 0 ? c : 'â€”'; }
        if (ctEl) ctEl.textContent = c > 0 ? c : 'â€”';
    });
    const unkBar = document.getElementById('cf-unknown-bar');
    const unkCt = document.getElementById('cf-unknown-ct');
    const unkPct = total > 0 ? Math.max(5, Math.round((unknown / total) * 100)) : 5;
    if (unkBar) { unkBar.style.width = unkPct + '%'; unkBar.textContent = unknown > 0 ? unknown : 'â€”'; }
    if (unkCt) unkCt.textContent = unknown > 0 ? unknown : 'â€”';
}

function updateDashFollowUps() {
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];
    const today = new Date(); today.setHours(0,0,0,0);
    const upcoming = [];
    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (d.followUp) {
            const dt = new Date(d.followUp + 'T00:00:00');
            const diff = Math.round((dt - today) / 86400000);
            upcoming.push({ name, date: dt, diff, stage: d.stage || 'Fresh' });
        }
    });
    upcoming.sort((a, b) => a.date - b.date);
    const el = document.getElementById('dashFollowUps');
    if (!el) return;
    if (upcoming.length === 0) {
        el.innerHTML = '<div class="action-item" style="color:var(--text3);font-style:italic;">No follow-ups scheduled yet. Set dates in account details.</div>';
        return;
    }
    el.innerHTML = upcoming.slice(0, 7).map(f => {
        let color = 'var(--text)';
        let icon = '';
        if (f.diff < 0) { color = 'var(--accent4)'; icon = '&#x26A0; '; }
        else if (f.diff === 0) { color = 'var(--accent2)'; icon = '&#x25CF; '; }
        else if (f.diff <= 3) { color = 'var(--accent3)'; icon = ''; }
        const dateStr = f.date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
        const label = f.diff < 0 ? 'OVERDUE' : f.diff === 0 ? 'TODAY' : f.diff <= 3 ? 'Soon' : dateStr;
        return `<div class="action-item" style="display:flex;justify-content:space-between;align-items:center;">
            <span>${icon}<strong style="color:${color};">${f.name}</strong> <span style="color:var(--text3);font-size:11px;">${f.stage}</span></span>
            <span style="font-size:11px;font-family:var(--mono);color:${color};white-space:nowrap;margin-left:8px;">${label}</span>
        </div>`;
    }).join('');
}

function updateDashFlags() {
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];
    const flagLabels = { rfp: 'Active RFP', expiring: 'Contract Expiring', budget: 'Budget Approved', dm: 'Decision Maker', proposal: 'Proposal Sent', competitor: 'Competitor Incumbent' };
    const flagColors = { rfp: 'var(--accent4)', expiring: 'var(--accent3)', budget: 'var(--accent2)', dm: 'var(--accent)', proposal: '#a78bfa', competitor: 'var(--accent5)' };
    const flagged = [];
    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (d.flags && d.flags.length > 0) {
            d.flags.forEach(f => {
                flagged.push({ name, flag: f, label: flagLabels[f] || f, color: flagColors[f] || 'var(--text)', stage: d.stage || 'Fresh' });
            });
        }
    });
    const el = document.getElementById('dashFlags');
    if (!el) return;
    if (flagged.length === 0) {
        el.innerHTML = '<div class="action-item" style="color:var(--text3);font-style:italic;">No flags set yet. Flag accounts with RFPs, expiring contracts, etc.</div>';
        return;
    }
    // Group by flag type, show most important first (rfp, expiring, budget, proposal, dm, competitor)
    const order = ['rfp','expiring','budget','proposal','dm','competitor'];
    flagged.sort((a, b) => order.indexOf(a.flag) - order.indexOf(b.flag));
    el.innerHTML = flagged.slice(0, 8).map(f =>
        `<div class="action-item" style="display:flex;justify-content:space-between;align-items:center;">
            <span><strong style="color:var(--text);">${f.name}</strong></span>
            <span style="font-size:10px;padding:2px 7px;border-radius:4px;background:${f.color}22;color:${f.color};font-weight:600;white-space:nowrap;margin-left:8px;">${f.label}</span>
        </div>`
    ).join('');
}

// --- OpenClaw Inbox ---
let ocNotes = [];
function fetchOcNotes() {
    fetch('http://127.0.0.1:18790/notes')
        .then(r => r.json())
        .then(notes => { ocNotes = notes; renderOcInbox(); })
        .catch(() => {});
}
function renderOcInbox() {
    const el = document.getElementById('dashOcInbox');
    const badge = document.getElementById('ocInboxCount');
    if (!el) return;
    if (ocNotes.length === 0) {
        el.innerHTML = '<div class="action-item" style="color:var(--text3);font-style:italic;">No notes yet. Message OpenClaw on Telegram to add notes here.</div>';
        if (badge) badge.style.display = 'none';
        return;
    }
    if (badge) { badge.textContent = ocNotes.length; badge.style.display = 'inline'; }
    el.innerHTML = ocNotes.slice(0, 6).map(n => {
        const d = new Date(n.dt);
        const ago = timeAgo(d);
        const acctStr = n.account ? `<strong>${n.account}</strong> â€” ` : '';
        return `<div class="oc-note">
            <span class="oc-note-type ${n.type || 'note'}">${n.type || 'note'}</span>
            <div class="oc-note-body">
                <div class="oc-note-text">${acctStr}${escHtml(n.text)}</div>
                <div class="oc-note-meta">${ago}</div>
            </div>
            <span class="oc-note-dismiss" onclick="dismissOcNote(${n.id})" title="Dismiss">&times;</span>
        </div>`;
    }).join('');
    if (ocNotes.length > 6) {
        el.innerHTML += `<div style="font-size:10px;color:var(--text3);margin-top:6px;text-align:center;">+${ocNotes.length - 6} more</div>`;
    }
}
function dismissOcNote(id) {
    fetch('http://127.0.0.1:18790/notes/' + id, { method: 'DELETE' })
        .then(() => { ocNotes = ocNotes.filter(n => n.id !== id); renderOcInbox(); })
        .catch(() => {});
}
function timeAgo(d) {
    const s = Math.floor((Date.now() - d.getTime()) / 1000);
    if (s < 60) return 'just now';
    if (s < 3600) return Math.floor(s / 60) + 'm ago';
    if (s < 86400) return Math.floor(s / 3600) + 'h ago';
    return Math.floor(s / 86400) + 'd ago';
}
function escHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

// --- Pipeline Sync to Proxy (for Thursday email export) ---
function buildLocalPipeline() {
    const allAccts = [...entAccounts.map(a=>({...a, tier:'ENT'})), ...smbAccounts.map(a=>({...a, tier:'SMB'}))];
    const deals = [];
    allAccts.forEach(a => {
        const d = getAcctData(a.name);
        if (d.stage && d.stage !== 'Fresh') {
            deals.push({
                account: a.name,
                tier: a.tier,
                sector: a.sector || a.industry || '',
                stage: d.stage,
                value: Number(d.value) || 0,
                prob: d.prob || '',
                closeQ: d.closeQ || '',
                incumbent: d.incumbent || '',
                contactName: d.contactName || '',
                contactEmail: d.contactEmail || '',
                followUp: d.followUp || '',
                notes: d.notes || ''
            });
        }
    });
    deals.sort((a, b) => b.value - a.value);
    const total = deals.reduce((s, d) => s + d.value, 0);
    return { deals, totalPipeline: total, dealCount: deals.length, target: 3000000 };
}

function syncPipelineToProxy() {
    const pipeline = buildLocalPipeline();
    if (pipeline.dealCount === 0) return; // Never overwrite cal-proxy with empty data
    fetch('http://127.0.0.1:18790/pipeline', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pipeline)
    }).catch(() => {});
}

function safePipelineSync() {
    // Safe sync on page load: fetch cal-proxy first, merge intelligently
    const localPipeline = buildLocalPipeline();
    fetch('http://127.0.0.1:18790/pipeline').then(r => r.json()).then(remote => {
        const remoteHasData = remote && remote.deals && remote.deals.length > 0;
        const localHasData = localPipeline.dealCount > 0;
        if (!localHasData && remoteHasData) {
            // localStorage is empty, cal-proxy has data â€” restore from cal-proxy
            remote.deals.forEach(deal => {
                const existing = getAcctData(deal.account);
                if (!existing.stage || existing.stage === 'Fresh') {
                    setAcctData(deal.account, {
                        ...existing,
                        stage: deal.stage,
                        value: deal.value,
                        prob: deal.prob || '',
                        closeQ: deal.closeQ || '',
                        incumbent: deal.incumbent || '',
                        contactName: deal.contactName || '',
                        contactEmail: deal.contactEmail || '',
                        followUp: deal.followUp || '',
                        notes: deal.notes || ''
                    });
                }
            });
            updateDashPipeline();
            console.log('[Hub] Restored ' + remote.deals.length + ' deals from cal-proxy into localStorage');
        } else if (localHasData) {
            // localStorage has data â€” push to cal-proxy (current behavior)
            syncPipelineToProxy();
        }
        // If both are empty, do nothing
    }).catch(() => {
        // cal-proxy unreachable â€” use localStorage, don't push empty data
        if (localPipeline.dealCount > 0) syncPipelineToProxy();
    });
}

// --- Pipeline by Stage Breakdown ---
function updateStageBreakdown() {
    const stages = {};
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];
    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (d.stage && d.stage !== 'Fresh' && d.stage !== 'Closed Won' && d.stage !== 'Closed Lost') {
            if (!stages[d.stage]) stages[d.stage] = { count: 0, value: 0 };
            stages[d.stage].count++;
            stages[d.stage].value += Number(d.value) || 0;
        }
    });
    const el = document.getElementById('dashStageBreakdown');
    const order = ['Prospecting','Discovery','Solution Design','Proposal','Negotiation','Verbal Commit'];
    const rows = order.filter(s => stages[s]).map(s =>
        `<div class="stage-row">
            <span class="stage-label">${stageTag(s)}</span>
            <span class="stage-count">${stages[s].count}</span>
            <span class="stage-value">$${stages[s].value.toLocaleString()}</span>
        </div>`
    );
    el.innerHTML = rows.length ? rows.join('') : '<div style="color:var(--text3);font-style:italic;font-size:11px;">No active deals yet.</div>';
}

// --- Stale Accounts (14+ days since last contact) ---
function updateStaleAccounts() {
    const stale = [];
    const now = new Date();
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];
    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (d.stage && d.stage !== 'Fresh' && d.stage !== 'Closed Won' && d.stage !== 'Closed Lost' && d.lastContact) {
            const last = new Date(d.lastContact + 'T00:00:00');
            const days = Math.floor((now - last) / 86400000);
            if (days >= 14) stale.push({ name, days, stage: d.stage });
        }
    });
    stale.sort((a, b) => b.days - a.days);
    const el = document.getElementById('dashStale');
    el.innerHTML = stale.length ? stale.slice(0, 6).map(s =>
        `<div class="stale-row">
            <span class="stale-name">${s.name}</span>
            <span>${stageTag(s.stage)}</span>
            <span class="stale-days">${s.days}d ago</span>
        </div>`
    ).join('') : '<div style="color:var(--text3);font-style:italic;font-size:11px;">No stale accounts. (Set Last Contact dates in account details)</div>';
}

// --- Hot Deals (75%+ probability, close this quarter) ---
function updateHotDeals() {
    const hot = [];
    const now = new Date();
    const currentQ = 'Q' + (Math.floor(now.getMonth() / 3) + 1) + ' ' + now.getFullYear();
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];
    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (d.stage && d.stage !== 'Fresh' && d.stage !== 'Closed Won' && d.stage !== 'Closed Lost') {
            const prob = parseInt(d.prob) || 0;
            if (prob >= 75 || (d.closeQ && d.closeQ === currentQ && prob >= 50)) {
                hot.push({ name, value: Number(d.value) || 0, prob, stage: d.stage, closeQ: d.closeQ || '' });
            }
        }
    });
    hot.sort((a, b) => b.value - a.value);
    const el = document.getElementById('dashHotDeals');
    el.innerHTML = hot.length ? hot.slice(0, 6).map(h =>
        `<div class="hot-row">
            <span class="hot-name">${h.name}</span>
            <span>${stageTag(h.stage)}</span>
            <span class="hot-val">$${h.value.toLocaleString()} (${h.prob}%)</span>
        </div>`
    ).join('') : '<div style="color:var(--text3);font-style:italic;font-size:11px;">No hot deals yet. Set probability + close quarter in account details.</div>';
}

// --- Quick Actions ---
function populateAccountsList() {
    const dl = document.getElementById('allAccountsList');
    const all = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];
    dl.innerHTML = all.map(n => `<option value="${n}">`).join('');
}
populateAccountsList();

function openQuickLog() {
    document.getElementById('qa-log-acct').value = '';
    document.getElementById('qa-log-notes').value = '';
    document.getElementById('qa-log-next').value = '';
    document.getElementById('qaLogModal').classList.remove('hidden');
    document.getElementById('qa-log-acct').focus();
}

function saveQuickLog() {
    const acct = document.getElementById('qa-log-acct').value.trim();
    const notes = document.getElementById('qa-log-notes').value.trim();
    const next = document.getElementById('qa-log-next').value.trim();
    if (!acct) return;
    const d = getAcctData(acct);
    const today = new Date().toISOString().slice(0, 10);
    d.lastContact = today;
    if (next) d.nextAction = next;
    if (notes) d.notes = (d.notes ? d.notes + '\n\n' : '') + '[' + today + '] ' + notes;
    setAcctData(acct, d);
    document.getElementById('qaLogModal').classList.add('hidden');
    updateStaleAccounts();
    updateDashFollowUps();
}

function openQuickDeal() {
    document.getElementById('qa-deal-acct').value = '';
    document.getElementById('qa-deal-value').value = '';
    document.getElementById('qa-deal-stage').value = 'Discovery';
    document.getElementById('qaDealModal').classList.remove('hidden');
    document.getElementById('qa-deal-acct').focus();
}

function saveQuickDeal() {
    const acct = document.getElementById('qa-deal-acct').value.trim();
    const value = document.getElementById('qa-deal-value').value;
    const stage = document.getElementById('qa-deal-stage').value;
    if (!acct) return;
    const d = getAcctData(acct);
    d.stage = stage;
    if (value) d.value = value;
    d.lastContact = new Date().toISOString().slice(0, 10);
    setAcctData(acct, d);
    document.getElementById('qaDealModal').classList.add('hidden');
    updateDashPipeline();
    updateStageBreakdown();
    updateHotDeals();
    renderEnt(document.getElementById('entSearch').value, document.getElementById('entPriority').value, document.getElementById('entSector').value);
    renderSmb(document.getElementById('smbSearch').value, document.getElementById('smbIndustry').value);
    syncPipelineToProxy();
}

// --- Add Account ---
const ENT_SECTORS = ['Agriculture','Crown Corp','Energy','Financial','Gaming','Government','Healthcare','Industrial','Manufacturing','Mining','Retail','Security','Social Services'];
const SMB_INDUSTRIES = ['Agriculture','Education','Finance','Gaming','Government','Healthcare','Industrial','Manufacturing','Mining','Technology'];

function openAddAccount() {
    document.getElementById('qaAddAcctModal').classList.remove('hidden');
    document.getElementById('qa-acct-name').value = '';
    document.getElementById('qa-acct-city').value = '';
    document.getElementById('qa-acct-priority').value = 'B';
    document.getElementById('qa-acct-cname').value = '';
    document.getElementById('qa-acct-ctitle').value = '';
    document.getElementById('qa-acct-cemail').value = '';
    document.getElementById('qa-acct-cphone').value = '';
    document.getElementById('qa-acct-crole').value = '';
    updateAddAcctSectors();
    document.getElementById('qa-acct-name').focus();
}

function updateAddAcctSectors() {
    const type = document.getElementById('qa-acct-type').value;
    const sel = document.getElementById('qa-acct-sector');
    const options = type === 'ent' ? ENT_SECTORS : SMB_INDUSTRIES;
    sel.innerHTML = '<option value="">â€”</option>' + options.map(s => `<option value="${s}">${s}</option>`).join('');
}

function saveNewAccount() {
    const name = document.getElementById('qa-acct-name').value.trim();
    if (!name) { showToast('error', 'Account name is required.'); return; }
    // Check for duplicates
    const allNames = [...entAccounts.map(a=>a.name.toLowerCase()), ...smbAccounts.map(a=>a.name.toLowerCase())];
    if (allNames.includes(name.toLowerCase())) { showToast('error', 'Account "' + name + '" already exists.'); return; }

    const type = document.getElementById('qa-acct-type').value;
    const sector = document.getElementById('qa-acct-sector').value;
    const city = document.getElementById('qa-acct-city').value.trim();
    const priority = document.getElementById('qa-acct-priority').value;
    const cName = document.getElementById('qa-acct-cname').value.trim();
    const cTitle = document.getElementById('qa-acct-ctitle').value.trim();
    const cEmail = document.getElementById('qa-acct-cemail').value.trim();
    const cPhone = document.getElementById('qa-acct-cphone').value.trim();
    const cRole = document.getElementById('qa-acct-crole').value;

    // Build account object and push to the appropriate array
    if (type === 'ent') {
        entAccounts.push({ name, sector: sector || 'Other', emp: 0, city: city || '', priority: priority || 'B', incumbent: 'â€”', contact: cName, source: 'Manual' });
    } else {
        smbAccounts.push({ name, industry: sector || 'Other', emp: 0, sales: 0, city: city || '', contact: cName, title: cTitle });
    }

    // Save contact + initial data to localStorage
    const contacts = [];
    if (cName) {
        contacts.push({
            id: 'c_' + Date.now(),
            name: cName, title: cTitle, email: cEmail, phone: cPhone,
            buyingRole: cRole, influenceLevel: '', relationshipStance: 0,
            lastActivity: new Date().toISOString().slice(0, 10), notes: ''
        });
    }
    setAcctData(name, {
        stage: 'Fresh',
        contacts: contacts,
        contactName: cName, contactTitle: cTitle, contactEmail: cEmail, contactPhone: cPhone,
        activities: [],
        meddpicc: {}
    });

    document.getElementById('qaAddAcctModal').classList.add('hidden');

    // Re-render the tables and update the datalist
    populateAccountsList();
    renderEnt(document.getElementById('entSearch').value, document.getElementById('entPriority').value, document.getElementById('entSector').value);
    renderSmb(document.getElementById('smbSearch').value, document.getElementById('smbIndustry').value);
    updateDashPipeline();
    updateKPICards();
    renderKanban();
    showToast('success', name + ' added to ' + (type === 'ent' ? 'Enterprise' : 'SMB') + ' accounts.');
}

function showWeekPriorities() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate() + 7);
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name)];
    let followUps = [], overdueFollowUps = [], nextActions = [], staleDeals = [];

    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (d.followUp) {
            const fDate = new Date(d.followUp + 'T00:00:00');
            if (fDate < today) overdueFollowUps.push({ name, date: d.followUp, stage: d.stage || 'Fresh' });
            else if (fDate <= weekEnd) followUps.push({ name, date: d.followUp, stage: d.stage || 'Fresh' });
        }
        if (d.nextAction && d.stage && d.stage !== 'Fresh' && d.stage !== 'Closed Won' && d.stage !== 'Closed Lost') {
            nextActions.push({ name, action: d.nextAction, stage: d.stage });
        }
        if (d.stage && d.stage !== 'Fresh' && d.stage !== 'Closed Won' && d.stage !== 'Closed Lost' && d.lastContact) {
            const days = Math.floor((now - new Date(d.lastContact + 'T00:00:00')) / 86400000);
            if (days >= 14) staleDeals.push({ name, days, stage: d.stage });
        }
    });

    let html = '';
    if (overdueFollowUps.length) {
        html += '<div style="margin-bottom:12px;"><strong style="color:var(--accent4);font-size:11px;text-transform:uppercase;">OVERDUE</strong>';
        overdueFollowUps.forEach(f => { html += `<div style="padding:3px 0;border-bottom:1px solid var(--border);">${f.name} <span style="color:var(--accent4);font-size:10px;">â€” was ${f.date}</span></div>`; });
        html += '</div>';
    }
    if (followUps.length) {
        html += '<div style="margin-bottom:12px;"><strong style="color:var(--accent);font-size:11px;text-transform:uppercase;">Follow-ups This Week</strong>';
        followUps.forEach(f => { html += `<div style="padding:3px 0;border-bottom:1px solid var(--border);">${f.name} <span style="color:var(--text3);font-size:10px;">â€” ${f.date}</span></div>`; });
        html += '</div>';
    }
    if (nextActions.length) {
        html += '<div style="margin-bottom:12px;"><strong style="color:var(--accent2);font-size:11px;text-transform:uppercase;">Pending Next Actions</strong>';
        nextActions.slice(0, 10).forEach(a => { html += `<div style="padding:3px 0;border-bottom:1px solid var(--border);">${a.name} <span style="color:var(--text3);font-size:10px;">â€” ${a.action}</span></div>`; });
        html += '</div>';
    }
    if (staleDeals.length) {
        html += '<div style="margin-bottom:12px;"><strong style="color:var(--accent3);font-size:11px;text-transform:uppercase;">Stale Deals (14+ days)</strong>';
        staleDeals.forEach(s => { html += `<div style="padding:3px 0;border-bottom:1px solid var(--border);">${s.name} <span style="color:var(--accent4);font-size:10px;">â€” ${s.days}d since last contact</span></div>`; });
        html += '</div>';
    }
    if (!html) html = '<div style="color:var(--text3);font-style:italic;">No follow-ups, overdue items, or next actions found. Set dates and next actions in account details.</div>';

    document.getElementById('qaWeekContent').innerHTML = html;
    document.getElementById('qaWeekModal').classList.remove('hidden');
}

// Close quick modals on overlay click + escape
['qaLogModal','qaDealModal','qaWeekModal'].forEach(id => {
    document.getElementById(id).addEventListener('click', e => {
        if (e.target.id === id) document.getElementById(id).classList.add('hidden');
    });
});
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') ['qaLogModal','qaDealModal','qaWeekModal'].forEach(id => document.getElementById(id).classList.add('hidden'));
});

// ===== TERRITORY MAP =====
const SK_GEOCODE = {
    'Regina': [50.4452, -104.6189], 'Saskatoon': [52.1332, -106.6700],
    'Prince Albert': [53.2034, -105.7531], 'Moose Jaw': [50.3934, -105.5519],
    'Swift Current': [50.2881, -107.7937], 'Yorkton': [51.2139, -102.4628],
    'North Battleford': [52.7575, -108.2861], 'Estevan': [49.1392, -102.9861],
    'Weyburn': [49.6612, -103.8519], 'Lloydminster': [53.2781, -110.0005],
    'Meadow Lake': [54.1242, -108.4347], 'Nipawin': [53.3617, -104.0087],
    'Humboldt': [52.2010, -105.1226], 'Melville': [50.9299, -102.8078],
    'La Ronge': [55.1001, -105.2842], 'Lanigan': [51.8500, -105.0333],
    'Rocanville': [50.4500, -101.8500], 'Vanscoy': [52.0333, -107.0333],
    'St Brieux': [52.5667, -104.8167], 'Bethune': [50.7333, -105.0833],
    'Whitecap': [51.9833, -106.4167], 'Esterhazy': [50.6500, -102.0833],
    'Unity': [52.4500, -109.1667], 'Biggar': [52.0600, -108.0000],
    'Creighton': [54.7633, -101.9256], 'Ile a la Crosse': [55.4500, -107.8833],
    'Regina Beach': [50.7833, -105.0167],
    // Compound cities â€” map to primary
    'Regina/Province-wide': [50.4452, -104.6189], 'Saskatoon/Esterhazy': [52.1332, -106.6700],
    'Saskatoon/Regina': [51.3000, -105.6500], 'Saskatoon/Regina/PA/MJ': [51.3000, -105.6500],
    'Regina/Saskatoon': [51.3000, -105.6500], 'NW Central SK': [52.7575, -108.2861],
    'West Central SK': [51.6500, -108.0000], 'Around Regina': [50.5000, -104.8000],
    'Melville/Yorkton': [51.0700, -102.6300],
};

const MAP_STATUS_COLORS = {
    customer: '#22c55e', pipeline: '#3b82f6', target: '#f59e0b', cold: '#6b7280', closedlost: '#ef4444'
};
const MAP_PRIORITY_COLORS = { A: '#ef4444', B: '#f59e0b', C: '#6b7280' };
const MAP_HEALTH_COLORS = { green: '#22c55e', yellow: '#f59e0b', red: '#ef4444', none: '#6b7280' };

let territoryMap = null;
let mapMarkers = [];

function getAccountStatus(d) {
    if (!d.stage || d.stage === 'Fresh') return 'cold';
    if (d.stage === 'Closed Won') return 'customer';
    if (d.stage === 'Closed Lost') return 'closedlost';
    return 'pipeline';
}

function getAccountColor(acct, d, mode) {
    if (mode === 'priority') return MAP_PRIORITY_COLORS[acct.priority] || '#6b7280';
    if (mode === 'health') {
        const score = calculateHealthScore(d);
        if (score.total >= 80) return MAP_HEALTH_COLORS.green;
        if (score.total >= 40) return MAP_HEALTH_COLORS.yellow;
        if (score.total > 0) return MAP_HEALTH_COLORS.red;
        return MAP_HEALTH_COLORS.none;
    }
    return MAP_STATUS_COLORS[getAccountStatus(d)] || '#6b7280';
}

function getMarkerRadius(value) {
    if (value >= 500000) return 12;
    if (value >= 100000) return 9;
    if (value >= 25000) return 7;
    return 5;
}

function resolveCity(acct) {
    // Try city, then region (K-12)
    return acct.city || acct.region || '';
}

function initTerritoryMap() {
    if (territoryMap) return;
    const el = document.getElementById('territoryMap');
    if (!el) return;
    territoryMap = L.map('territoryMap', { zoomControl: true }).setView([52.9399, -106.4509], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
        subdomains: 'abcd', maxZoom: 13
    }).addTo(territoryMap);

    // Populate sector filter
    const sectors = new Set();
    entAccounts.forEach(a => sectors.add(a.sector));
    smbAccounts.forEach(a => sectors.add(a.industry));
    const sel = document.getElementById('mapSector');
    [...sectors].sort().forEach(s => { if (s) sel.innerHTML += `<option value="${s}">${s}</option>`; });

    updateMapPins();
}

function updateMapPins() {
    if (!territoryMap) return;
    mapMarkers.forEach(m => territoryMap.removeLayer(m));
    mapMarkers = [];

    const filter = document.getElementById('mapFilter').value;
    const sector = document.getElementById('mapSector').value;
    const colorMode = document.getElementById('mapColor').value;

    // Collect accounts
    let accounts = [];
    if (filter !== 'smb') {
        entAccounts.forEach(a => accounts.push({ ...a, _type: 'ent', _sector: a.sector }));
    }
    if (filter !== 'ent') {
        smbAccounts.forEach(a => accounts.push({ ...a, _type: 'smb', _sector: a.industry }));
    }

    // Enrich with data
    accounts = accounts.map(a => {
        const d = getAcctData(a.name);
        return { ...a, _data: d, _city: resolveCity(a) };
    });

    // Filters
    if (filter === 'active') accounts = accounts.filter(a => a._data.stage && a._data.stage !== 'Fresh' && a._data.stage !== 'Closed Won' && a._data.stage !== 'Closed Lost');
    if (filter === 'atrisk') accounts = accounts.filter(a => { const s = calculateHealthScore(a._data); return s.total < 40 && a._data.stage && a._data.stage !== 'Fresh'; });
    if (sector) accounts = accounts.filter(a => a._sector === sector);

    // Place markers â€” jitter accounts sharing same city
    const cityCount = {};
    let pinned = 0, noloc = 0;
    const statusCounts = { customer: 0, pipeline: 0, target: 0, cold: 0, closedlost: 0 };

    accounts.forEach(a => {
        const cityKey = a._city.split('/')[0].trim();
        const coords = SK_GEOCODE[a._city] || SK_GEOCODE[cityKey];
        if (!coords) { noloc++; return; }

        // Jitter to avoid overlap
        if (!cityCount[cityKey]) cityCount[cityKey] = 0;
        const jitter = cityCount[cityKey] * 0.012;
        const angle = cityCount[cityKey] * 2.4; // golden angle
        const lat = coords[0] + jitter * Math.cos(angle);
        const lng = coords[1] + jitter * Math.sin(angle);
        cityCount[cityKey]++;

        const d = a._data;
        const color = getAccountColor(a, d, colorMode);
        const value = Number(d.value) || 0;
        const radius = getMarkerRadius(value);
        const status = getAccountStatus(d);
        statusCounts[status]++;

        const marker = L.circleMarker([lat, lng], {
            radius: radius, fillColor: color, color: '#000', weight: 1, opacity: 0.8, fillOpacity: 0.85
        }).addTo(territoryMap);

        const stage = d.stage || 'Fresh';
        const healthScore = calculateHealthScore(d).total;
        marker.bindPopup(`
            <div class="map-popup-name">${a.name}</div>
            <div class="map-popup-detail">
                ${a._sector ? a._sector + ' &middot; ' : ''}${a._city}<br>
                Stage: <strong>${stage}</strong>${value ? ' &middot; $' + value.toLocaleString() : ''}<br>
                Priority: <strong>${a.priority || 'â€”'}</strong> &middot; Health: <strong>${healthScore}</strong>/100
                ${d.competitors && d.competitors.primary ? '<br>vs <strong>' + d.competitors.primary + '</strong>' : ''}
            </div>
        `, { maxWidth: 250 });

        mapMarkers.push(marker);
        pinned++;
    });

    // Update legend
    const legendEl = document.getElementById('mapLegend');
    if (colorMode === 'status') {
        legendEl.innerHTML = [
            ['#22c55e','Customer'],['#3b82f6','Pipeline'],['#f59e0b','Target'],['#6b7280','Cold'],['#ef4444','Closed Lost']
        ].map(([c,l]) => `<span class="map-legend-item"><span class="map-legend-dot" style="background:${c}"></span>${l}</span>`).join('');
    } else if (colorMode === 'priority') {
        legendEl.innerHTML = [
            ['#ef4444','A â€” Strategic'],['#f59e0b','B â€” Target'],['#6b7280','C â€” Opportunistic']
        ].map(([c,l]) => `<span class="map-legend-item"><span class="map-legend-dot" style="background:${c}"></span>${l}</span>`).join('');
    } else {
        legendEl.innerHTML = [
            ['#22c55e','Healthy (80+)'],['#f59e0b','Attention (40-79)'],['#ef4444','At Risk (<40)'],['#6b7280','No data']
        ].map(([c,l]) => `<span class="map-legend-item"><span class="map-legend-dot" style="background:${c}"></span>${l}</span>`).join('');
    }

    // Stats
    document.getElementById('mapStats').innerHTML = `
        <span class="ws-stat"><strong>${pinned}</strong> mapped</span>
        ${noloc > 0 ? `<span class="ws-stat" style="color:var(--text3);">${noloc} no location</span>` : ''}
        <span class="ws-stat">Pipeline: <strong>${statusCounts.pipeline}</strong></span>
        <span class="ws-stat">Customers: <strong>${statusCounts.customer}</strong></span>
    `;
}

// ===== WHITESPACE HEATMAP =====
const WS_PILLARS = ['Cloud','Virtualization','Infrastructure','Endpoint','Security','Data Protection','Print/Doc Mgmt','Network','AI/Copilot','Managed IT','Prof Services','Support Svc'];

function renderWhitespaceHeatmap() {
    const filter = document.getElementById('wsFilter') ? document.getElementById('wsFilter').value : 'all';
    const sort = document.getElementById('wsSort') ? document.getElementById('wsSort').value : 'whitespace';
    const search = document.getElementById('wsSearch') ? document.getElementById('wsSearch').value.toLowerCase() : '';

    // Collect accounts based on filter
    let accounts = [];
    if (filter === 'ent' || filter === 'all' || filter === 'active') {
        entAccounts.forEach(a => accounts.push({ name: a.name, type: 'ent', sector: a.sector }));
    }
    if (filter === 'smb' || filter === 'all' || filter === 'active') {
        smbAccounts.forEach(a => accounts.push({ name: a.name, type: 'smb', sector: a.industry }));
    }

    // Enrich with data
    accounts = accounts.map(a => {
        const d = getAcctData(a.name);
        return { ...a, pillars: d.pillars || [], stage: d.stage || 'Fresh', value: Number(d.value) || 0 };
    });

    // Filter: active deals only
    if (filter === 'active') {
        accounts = accounts.filter(a => a.stage && a.stage !== 'Fresh' && a.stage !== 'Closed Won' && a.stage !== 'Closed Lost');
    }

    // Filter: search
    if (search) {
        accounts = accounts.filter(a => a.name.toLowerCase().includes(search));
    }

    // Calculate whitespace score
    accounts.forEach(a => {
        a.wsScore = Math.round(((WS_PILLARS.length - a.pillars.length) / WS_PILLARS.length) * 100);
    });

    // Sort
    if (sort === 'whitespace') accounts.sort((a, b) => b.wsScore - a.wsScore || b.value - a.value);
    else if (sort === 'name') accounts.sort((a, b) => a.name.localeCompare(b.name));
    else if (sort === 'value') accounts.sort((a, b) => b.value - a.value);

    // Summary stats
    const totalAccts = accounts.length;
    const avgWs = totalAccts > 0 ? Math.round(accounts.reduce((s, a) => s + a.wsScore, 0) / totalAccts) : 0;
    const pillarCounts = {};
    WS_PILLARS.forEach(p => pillarCounts[p] = 0);
    accounts.forEach(a => a.pillars.forEach(p => { if (pillarCounts[p] !== undefined) pillarCounts[p]++; }));
    const topGap = WS_PILLARS.slice().sort((a, b) => pillarCounts[a] - pillarCounts[b]);

    const summaryEl = document.getElementById('wsSummary');
    if (summaryEl) {
        summaryEl.innerHTML = `
            <span class="ws-stat"><strong>${totalAccts}</strong> accounts</span>
            <span class="ws-stat">Avg whitespace: <strong>${avgWs}%</strong></span>
            <span class="ws-stat">Biggest gap: <strong>${topGap[0] || 'â€”'}</strong> (${pillarCounts[topGap[0]] || 0}/${totalAccts})</span>
        `;
    }

    // Build table
    let html = '<table class="whitespace-table"><thead><tr><th>Account</th>';
    WS_PILLARS.forEach(p => {
        const shortName = p.replace('Virtualization','Virt').replace('Infrastructure','Infra').replace('Data Protection','Data Prot').replace('Print/Doc Mgmt','Print').replace('AI/Copilot','AI').replace('Managed IT','Mgd IT').replace('Prof Services','Prof Svc').replace('Support Svc','Sup Svc');
        html += `<th><span class="pillar-header">${shortName}</span></th>`;
    });
    html += '<th>Gap</th><th>Value</th></tr></thead><tbody>';

    accounts.forEach(a => {
        html += `<tr onclick="openModal('${a.name.replace(/'/g,"\\'")}','${a.type}')" style="cursor:pointer;">`;
        html += `<td title="${a.name}">${a.name}</td>`;
        WS_PILLARS.forEach(p => {
            const active = a.pillars.includes(p);
            html += `<td class="${active ? 'ws-active' : 'ws-gap'}" title="${p}: ${active ? 'Active' : 'Whitespace'}">&#9679;</td>`;
        });
        const scoreClass = a.wsScore >= 70 ? 'ws-score-high' : a.wsScore >= 40 ? 'ws-score-med' : 'ws-score-low';
        html += `<td class="ws-score ${scoreClass}">${a.wsScore}%</td>`;
        html += `<td style="font-family:var(--mono);font-size:10px;color:var(--accent2);">${a.value ? '$' + a.value.toLocaleString() : 'â€”'}</td>`;
        html += '</tr>';
    });

    html += '</tbody></table>';
    const tableEl = document.getElementById('whitespaceTable');
    if (tableEl) tableEl.innerHTML = html;
}

// ===== DATA MIGRATION =====
function migrateAllAccounts() {
    const stageMap = { 'Needs Analysis': 'Solution Design', 'Qualifying': 'Solution Design' };
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key || !key.startsWith('xits_acct_')) continue;
        try {
            const acct = JSON.parse(localStorage.getItem(key));
            if (!acct) continue;
            let changed = false;
            // Migrate old stage names
            if (acct.stage && stageMap[acct.stage]) {
                acct.stage = stageMap[acct.stage];
                changed = true;
            }
            // Ensure new fields exist
            if (!acct.meddpicc) { acct.meddpicc = {}; changed = true; }
            if (!acct.activities) { acct.activities = []; changed = true; }
            if (!acct.stageEnteredDate && acct.stage && acct.stage !== 'Fresh') {
                acct.stageEnteredDate = new Date().toISOString().slice(0, 10);
                changed = true;
            }
            // Migrate single contact to contacts array
            if (!acct.contacts && acct.contactName) {
                acct.contacts = [{
                    id: 'c_migrated_' + i,
                    name: acct.contactName,
                    title: acct.contactTitle || '',
                    email: acct.contactEmail || '',
                    phone: acct.contactPhone || '',
                    buyingRole: '', influenceLevel: '', relationshipStance: 0,
                    lastActivity: acct.lastContact || '', notes: ''
                }];
                changed = true;
            }
            if (changed) localStorage.setItem(key, JSON.stringify(acct));
        } catch(e) {}
    }
}
migrateAllAccounts();

// ===== MEDDPICC FUNCTIONS =====
function getMEDDPICCScore(meddpicc) {
    if (!meddpicc) return 0;
    const fields = ['metrics','economicBuyer','decisionCriteria','decisionProcess','identifiedPain','champion','paperProcess','competition'];
    const total = fields.reduce((sum, f) => sum + (parseInt(meddpicc[f]) || 0), 0);
    return Math.round(total / 80 * 100);
}

function updateMEDDPICC() {
    let total = 0;
    document.querySelectorAll('#meddpiccPanel input[type="range"]').forEach(slider => {
        const val = parseInt(slider.value) || 0;
        slider.nextElementSibling.textContent = val;
        total += val;
    });
    const pct = Math.round(total / 80 * 100);
    const pctEl = document.getElementById('meddpiccPct');
    const fillEl = document.getElementById('meddpiccFill');
    pctEl.textContent = pct + '%';
    pctEl.className = 'meddpicc-total-pct ' + (pct >= 60 ? 'mgreen' : pct >= 30 ? 'myellow' : 'mred');
    fillEl.style.width = pct + '%';
    fillEl.style.background = pct >= 60 ? '#22c55e' : pct >= 30 ? '#f59e0b' : '#ef4444';
}

function meddpiccBadge(meddpicc) {
    const pct = getMEDDPICCScore(meddpicc);
    const cls = pct >= 60 ? 'mgreen' : pct >= 30 ? 'myellow' : 'mred';
    return `<span class="deal-card-meddpicc ${cls}">M${pct}</span>`;
}

// ===== KPI METRIC CARDS =====
function updateKPICards() {
    const quota = 3000000;
    const allAccts = [...entAccounts.map(a=>a.name), ...smbAccounts.map(a=>a.name),
        ...k12.map(a=>a.name), ...higherEd.map(a=>a.name), ...creditUnions.map(a=>a.name)];
    let closedWon = 0, weightedPipeline = 0;
    const closingThisMonth = [];
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    // Map quarter strings to month ranges
    const quarterMonths = { 'Q1 2026': [0,1,2], 'Q2 2026': [3,4,5], 'Q3 2026': [6,7,8], 'Q4 2026': [9,10,11] };
    const currentQ = 'Q' + (Math.floor(currentMonth / 3) + 1) + ' ' + currentYear;

    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (!d.stage || d.stage === 'Fresh') return;
        const val = Number(d.value) || 0;
        if (d.stage === 'Closed Won') {
            closedWon += val;
            return;
        }
        if (d.stage === 'Closed Lost') return;
        // Weighted pipeline
        const prob = STAGE_CONFIG[d.stage] ? STAGE_CONFIG[d.stage].prob : (parseInt(d.prob) || 0);
        weightedPipeline += val * prob / 100;
        // Closing this month: check if expectedClose (closeQ) matches current quarter + month check
        if (d.closeQ === currentQ) {
            closingThisMonth.push({ name, value: val, stage: d.stage });
        }
    });

    const remainingQuota = Math.max(quota - closedWon, 1);
    const attainment = Math.round(closedWon / quota * 100);
    const coverage = weightedPipeline / remainingQuota;
    const closingCount = closingThisMonth.length;
    const closingValue = closingThisMonth.reduce((s, d) => s + d.value, 0);

    // 1. Quota Attainment
    document.getElementById('kpiQuotaVal').textContent = attainment + '%';
    document.getElementById('kpiQuotaSub').textContent = '$' + closedWon.toLocaleString() + ' / $' + (quota/1e6) + 'M';
    const quotaBar = document.getElementById('kpiQuotaBar');
    quotaBar.style.width = Math.min(attainment, 100) + '%';
    quotaBar.style.background = attainment >= 100 ? '#22c55e' : attainment >= 50 ? 'linear-gradient(90deg, #f59e0b, #22c55e)' : 'var(--accent4)';
    document.getElementById('kpiQuotaVal').style.color = attainment >= 100 ? '#22c55e' : attainment >= 50 ? '#fbbf24' : '#f87171';

    // 2. Weighted Pipeline
    const wpFormatted = weightedPipeline >= 1e6 ? '$'+(weightedPipeline/1e6).toFixed(1)+'M' : weightedPipeline >= 1e3 ? '$'+Math.round(weightedPipeline/1e3)+'K' : '$'+Math.round(weightedPipeline);
    document.getElementById('kpiWeightedVal').textContent = wpFormatted;
    const openCount = allAccts.reduce((c, name) => { const d = getAcctData(name); return c + (d.stage && d.stage !== 'Fresh' && d.stage !== 'Closed Won' && d.stage !== 'Closed Lost' ? 1 : 0); }, 0);
    document.getElementById('kpiWeightedSub').textContent = openCount + ' open deals Ã— stage probability';

    // 3. Closing This Month (current quarter)
    document.getElementById('kpiClosingVal').textContent = closingCount;
    document.getElementById('kpiClosingSub').textContent = closingCount > 0 ? '$' + closingValue.toLocaleString() + ' this quarter (' + currentQ + ')' : 'No deals set for ' + currentQ;

    // 4. Pipeline Coverage
    const covFormatted = coverage.toFixed(1) + '\u00D7';
    document.getElementById('kpiCoverageVal').textContent = covFormatted;
    const coverageEl = document.getElementById('kpiCoverage');
    // Remove old zone badge
    const oldZone = coverageEl.querySelector('.kpi-coverage-zone');
    if (oldZone) oldZone.remove();
    let zoneClass, zoneLabel;
    if (coverage >= 3.5) { zoneClass = 'zone-green'; zoneLabel = 'Healthy'; document.getElementById('kpiCoverageVal').style.color = '#4ade80'; }
    else if (coverage >= 2) { zoneClass = 'zone-yellow'; zoneLabel = 'Thin'; document.getElementById('kpiCoverageVal').style.color = '#fbbf24'; }
    else { zoneClass = 'zone-red'; zoneLabel = 'At Risk'; document.getElementById('kpiCoverageVal').style.color = '#f87171'; }
    const zone = document.createElement('span');
    zone.className = 'kpi-coverage-zone ' + zoneClass;
    zone.textContent = zoneLabel + ' (target: 3.5\u20135\u00D7)';
    coverageEl.appendChild(zone);
    document.getElementById('kpiCoverageSub').textContent = wpFormatted + ' / $' + Math.round(remainingQuota/1e3) + 'K remaining';

    // Also update the target bar
    const pct = Math.min(Math.round(closedWon / quota * 1000) / 10, 100);
    document.getElementById('targetPct').textContent = pct + '%';
    document.getElementById('targetBar').style.width = pct + '%';
}

// ===== KANBAN BOARD =====
function getAllPipelineDeals() {
    const allAccts = [...entAccounts.map(a=>({name:a.name,type:'ent'})), ...smbAccounts.map(a=>({name:a.name,type:'smb'})),
        ...k12.map(a=>({name:a.name,type:'k12'})), ...higherEd.map(a=>({name:a.name,type:'highered'})),
        ...creditUnions.map(a=>({name:a.name,type:'cu'}))];
    const deals = [];
    allAccts.forEach(a => {
        const d = getAcctData(a.name);
        if (d.stage && d.stage !== 'Fresh' && d.stage !== 'Closed Lost') {
            const daysInStage = d.stageEnteredDate ? Math.floor((Date.now() - new Date(d.stageEnteredDate + 'T00:00:00').getTime()) / 86400000) : 0;
            deals.push({
                account: a.name, type: a.type, stage: d.stage,
                value: Number(d.value) || 0, prob: d.prob || '',
                nextAction: d.nextAction || '', meddpicc: d.meddpicc || {},
                daysInStage, stageEnteredDate: d.stageEnteredDate || '',
                lastContact: d.lastContact || ''
            });
        }
    });
    return deals;
}

function getDealAgeStatus(deal) {
    const config = STAGE_CONFIG[deal.stage];
    if (!config || !deal.daysInStage) return 'normal';
    if (deal.daysInStage > config.maxDays) return 'critical';
    if (deal.daysInStage > config.minDays * 1.5) return 'warning';
    return 'normal';
}

function dealHealthDot(deal) {
    const mScore = getMEDDPICCScore(deal.meddpicc);
    const age = getDealAgeStatus(deal);
    if (age === 'critical' || mScore < 20) return '<span title="At Risk">&#128308;</span>';
    if (age === 'warning' || mScore < 40) return '<span title="Needs Attention">&#128993;</span>';
    return '<span title="Healthy">&#128994;</span>';
}

// ===== MULTI-CONTACT MANAGEMENT =====
const BUYING_ROLES = ['Champion','Economic Buyer','Technical Buyer','User Buyer','Influencer','Gatekeeper','Blocker','Coach'];
const INFLUENCE_LEVELS = ['High','Medium','Low'];

function migrateContactsToArray(acctData) {
    if (acctData.contacts && acctData.contacts.length > 0) return acctData;
    if (acctData.contactName) {
        acctData.contacts = [{
            id: 'c_' + Date.now(),
            name: acctData.contactName,
            title: acctData.contactTitle || '',
            email: acctData.contactEmail || '',
            phone: acctData.contactPhone || '',
            buyingRole: '',
            influenceLevel: '',
            relationshipStance: 0,
            lastActivity: acctData.lastContact || '',
            notes: ''
        }];
    } else {
        acctData.contacts = [];
    }
    return acctData;
}

function roleClass(role) {
    return 'r-' + (role || '').toLowerCase().replace(/\s+/g, '-');
}

function stanceDots(stance) {
    const s = parseInt(stance) || 0;
    let dots = '';
    for (let i = -2; i <= 2; i++) {
        if (i === 0) dots += `<span class="contact-stance-dot ${s === 0 ? 'neutral' : ''}"></span>`;
        else if (i < 0) dots += `<span class="contact-stance-dot ${s <= i ? 'neg' : ''}"></span>`;
        else dots += `<span class="contact-stance-dot ${s >= i ? 'pos' : ''}"></span>`;
    }
    return dots;
}

function renderModalContacts(contacts) {
    const el = document.getElementById('contactList');
    document.getElementById('contactFormWrap').innerHTML = '';
    if (!contacts || contacts.length === 0) {
        el.innerHTML = '<div class="contact-empty">No contacts yet. Add your first contact above.</div>';
        return;
    }
    el.innerHTML = contacts.map(c => `
        <div class="contact-card">
            <div class="contact-card-info">
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                    <span class="contact-card-name">${c.name}</span>
                    ${c.buyingRole ? `<span class="contact-role ${roleClass(c.buyingRole)}">${c.buyingRole}</span>` : ''}
                    ${c.influenceLevel ? `<span class="contact-influence inf-${c.influenceLevel.toLowerCase()}">${c.influenceLevel}</span>` : ''}
                </div>
                ${c.title ? `<div class="contact-card-title">${c.title}</div>` : ''}
                <div class="contact-card-detail">
                    ${c.email ? c.email : ''}${c.email && c.phone ? ' &middot; ' : ''}${c.phone ? c.phone : ''}
                </div>
                ${c.notes ? `<div class="contact-card-detail" style="color:var(--text2);margin-top:1px;">${c.notes}</div>` : ''}
                <div class="contact-stance-dots" title="Stance: ${c.relationshipStance || 0} (-2 Blocker to +2 Champion)">${stanceDots(c.relationshipStance)}</div>
            </div>
            <div class="contact-card-actions">
                <button onclick="editContact('${c.id}')" title="Edit">&#9998;</button>
                <button onclick="deleteContact('${c.id}')" title="Delete" style="color:var(--accent4);">&times;</button>
            </div>
        </div>
    `).join('');
}

function getContactFormHTML(contact) {
    const c = contact || { id: '', name: '', title: '', email: '', phone: '', buyingRole: '', influenceLevel: '', relationshipStance: 0, notes: '' };
    const isEdit = !!c.id;
    return `<div class="contact-form">
        <div class="modal-row">
            <div class="modal-field"><label>Name</label><input id="cf-name" value="${(c.name||'').replace(/"/g,'&quot;')}" placeholder="Jane Smith"></div>
            <div class="modal-field"><label>Title</label><input id="cf-title" value="${(c.title||'').replace(/"/g,'&quot;')}" placeholder="CIO"></div>
        </div>
        <div class="modal-row">
            <div class="modal-field"><label>Email</label><input id="cf-email" type="email" value="${(c.email||'').replace(/"/g,'&quot;')}" placeholder="jane@company.com"></div>
            <div class="modal-field"><label>Phone</label><input id="cf-phone" value="${(c.phone||'').replace(/"/g,'&quot;')}" placeholder="306-555-1234"></div>
        </div>
        <div class="modal-row">
            <div class="modal-field"><label>Buying Role</label>
                <select id="cf-role"><option value="">â€”</option>${BUYING_ROLES.map(r => `<option value="${r}"${r===c.buyingRole?' selected':''}>${r}</option>`).join('')}</select>
            </div>
            <div class="modal-field"><label>Influence</label>
                <select id="cf-influence"><option value="">â€”</option>${INFLUENCE_LEVELS.map(l => `<option value="${l}"${l===c.influenceLevel?' selected':''}>${l}</option>`).join('')}</select>
            </div>
            <div class="modal-field" style="max-width:120px;"><label>Stance (${c.relationshipStance||0})</label>
                <input type="range" id="cf-stance" min="-2" max="2" value="${c.relationshipStance||0}" style="width:100%;" oninput="this.closest('.modal-field').querySelector('label').textContent='Stance ('+this.value+')'">
            </div>
        </div>
        <div class="modal-row">
            <div class="modal-field" style="flex:1;"><label>Notes</label><input id="cf-notes" value="${(c.notes||'').replace(/"/g,'&quot;')}" placeholder="Reports to deputy minister..."></div>
        </div>
        <div class="contact-form-actions">
            <button class="modal-btn modal-btn-ghost" onclick="cancelContactForm()" style="padding:6px 14px;">Cancel</button>
            <button class="modal-btn modal-btn-primary" onclick="saveContact('${c.id||''}')" style="padding:6px 14px;">${isEdit ? 'Update' : 'Add'} Contact</button>
        </div>
    </div>`;
}

function showContactForm() {
    document.getElementById('contactFormWrap').innerHTML = getContactFormHTML(null);
    document.getElementById('cf-name').focus();
}

function editContact(id) {
    const d = getAcctData(currentModalAcct);
    migrateContactsToArray(d);
    const contact = (d.contacts || []).find(c => c.id === id);
    if (!contact) return;
    document.getElementById('contactFormWrap').innerHTML = getContactFormHTML(contact);
    document.getElementById('cf-name').focus();
}

function deleteContact(id) {
    if (!confirm('Remove this contact?')) return;
    const d = getAcctData(currentModalAcct);
    migrateContactsToArray(d);
    d.contacts = (d.contacts || []).filter(c => c.id !== id);
    setAcctData(currentModalAcct, d);
    renderModalContacts(d.contacts);
}

function saveContact(editId) {
    const name = document.getElementById('cf-name').value.trim();
    if (!name) { showToast('error', 'Contact name is required.'); return; }
    const contactData = {
        id: editId || ('c_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6)),
        name: name,
        title: document.getElementById('cf-title').value.trim(),
        email: document.getElementById('cf-email').value.trim(),
        phone: document.getElementById('cf-phone').value.trim(),
        buyingRole: document.getElementById('cf-role').value,
        influenceLevel: document.getElementById('cf-influence').value,
        relationshipStance: parseInt(document.getElementById('cf-stance').value) || 0,
        lastActivity: new Date().toISOString().slice(0, 10),
        notes: document.getElementById('cf-notes').value.trim()
    };
    const d = getAcctData(currentModalAcct);
    migrateContactsToArray(d);
    if (editId) {
        const idx = d.contacts.findIndex(c => c.id === editId);
        if (idx >= 0) {
            contactData.lastActivity = d.contacts[idx].lastActivity || contactData.lastActivity;
            d.contacts[idx] = contactData;
        }
    } else {
        d.contacts.push(contactData);
    }
    // Keep legacy contactName in sync with first contact for backwards compatibility
    if (d.contacts.length > 0) {
        d.contactName = d.contacts[0].name;
        d.contactTitle = d.contacts[0].title;
        d.contactEmail = d.contacts[0].email;
        d.contactPhone = d.contacts[0].phone;
    }
    setAcctData(currentModalAcct, d);
    renderModalContacts(d.contacts);
    showToast('success', editId ? 'Contact updated.' : 'Contact added.');
}

function cancelContactForm() {
    document.getElementById('contactFormWrap').innerHTML = '';
}

// ===== RELATIONSHIP HEALTH SCORING =====
function calculateHealthScore(acctData) {
    const activities = acctData.activities || [];
    const now = Date.now();

    // Use lastContact field as fallback if no activities have dates
    let daysSinceLastContact = 999;
    if (activities.length > 0) {
        const lastDate = [...activities].reverse().find(a => a.date);
        if (lastDate) daysSinceLastContact = Math.floor((now - new Date(lastDate.date).getTime()) / 86400000);
    }
    if (daysSinceLastContact === 999 && acctData.lastContact) {
        daysSinceLastContact = Math.floor((now - new Date(acctData.lastContact).getTime()) / 86400000);
    }

    // Recency (0-30)
    let recency = daysSinceLastContact <= 7 ? 30 :
                  daysSinceLastContact <= 14 ? 25 :
                  daysSinceLastContact <= 30 ? 20 :
                  daysSinceLastContact <= 60 ? 10 :
                  daysSinceLastContact <= 90 ? 5 : 0;

    // Frequency: touchpoints in last 90 days (0-25)
    const last90 = activities.filter(a => a.date && (now - new Date(a.date).getTime()) < 90 * 86400000);
    let frequency = last90.length >= 12 ? 25 :
                    last90.length >= 6 ? 20 :
                    last90.length >= 3 ? 15 :
                    last90.length >= 1 ? 8 : 0;

    // Depth: weighted by interaction type (0-25)
    const depthWeights = { meeting: 10, call: 5, email_out: 2, email_in: 3, note: 1, stage_change: 1 };
    let depth = Math.min(25, last90.reduce((sum, a) => sum + (depthWeights[a.type] || 1), 0));

    // Breadth: contacts engaged (0-20)
    const contacts = acctData.contacts || [];
    const now30 = 30 * 86400000;
    const activeContacts = contacts.filter(c => c.lastActivity && (now - new Date(c.lastActivity).getTime()) < now30);
    let breadth = activeContacts.length >= 5 ? 20 :
                  activeContacts.length >= 3 ? 15 :
                  activeContacts.length >= 2 ? 10 :
                  activeContacts.length >= 1 ? 5 :
                  (acctData.contactName ? 3 : 0);

    const total = recency + frequency + depth + breadth;
    return { total, recency, frequency, depth, breadth };
}

function healthDot(acctData) {
    const score = calculateHealthScore(acctData);
    const t = score.total;
    if (t >= 80) return `<span class="health-dot" title="Health: ${t}/100 (R:${score.recency} F:${score.frequency} D:${score.depth} B:${score.breadth})">&#128994;</span>`;
    if (t >= 40) return `<span class="health-dot" title="Health: ${t}/100 (R:${score.recency} F:${score.frequency} D:${score.depth} B:${score.breadth})">&#128993;</span>`;
    return `<span class="health-dot" title="Health: ${t}/100 (R:${score.recency} F:${score.frequency} D:${score.depth} B:${score.breadth})">&#128308;</span>`;
}

function updateAtRiskPanel() {
    const atRisk = [];
    const allAccts = [
        ...entAccounts.map(a => a.name),
        ...smbAccounts.map(a => a.name),
        ...(typeof k12Accounts !== 'undefined' ? k12Accounts.map(a => a.name) : []),
        ...(typeof higherEdAccounts !== 'undefined' ? higherEdAccounts.map(a => a.name) : []),
        ...(typeof cuAccounts !== 'undefined' ? cuAccounts.map(a => a.name) : [])
    ];
    allAccts.forEach(name => {
        const d = getAcctData(name);
        if (d.stage && d.stage !== 'Fresh' && d.stage !== 'Closed Won' && d.stage !== 'Closed Lost') {
            const score = calculateHealthScore(d);
            if (score.total < 40) {
                atRisk.push({ name, value: Number(d.value) || 0, score: score.total, stage: d.stage });
            }
        }
    });
    atRisk.sort((a, b) => b.value - a.value);
    const el = document.getElementById('dashAtRisk');
    if (!el) return;
    el.innerHTML = atRisk.length ? atRisk.slice(0, 8).map(a =>
        `<div class="at-risk-row">
            <span class="at-risk-name">${a.name}</span>
            <span class="at-risk-score" style="color:${a.score < 20 ? 'var(--accent4)' : 'var(--accent3)'}">${a.score}</span>
            <span class="at-risk-val">${a.value ? '$' + a.value.toLocaleString() : 'â€”'}</span>
        </div>`
    ).join('') : '<div style="color:var(--text3);font-style:italic;font-size:11px;">No at-risk accounts. Nice work!</div>';
}

function renderKanban() {
    const board = document.getElementById('kanbanBoard');
    const summary = document.getElementById('kanbanSummary');
    if (!board) return;
    const deals = getAllPipelineDeals();
    const byStage = {};
    KANBAN_STAGES.forEach(s => byStage[s] = []);
    deals.forEach(d => {
        if (byStage[d.stage]) byStage[d.stage].push(d);
    });

    // Summary
    const totalValue = deals.filter(d => d.stage !== 'Closed Won').reduce((s,d) => s + d.value, 0);
    const weighted = deals.filter(d => d.stage !== 'Closed Won').reduce((s,d) => s + d.value * (STAGE_CONFIG[d.stage]?.prob || 0) / 100, 0);
    const closedWon = deals.filter(d => d.stage === 'Closed Won').reduce((s,d) => s + d.value, 0);
    summary.innerHTML = `
        <span class="kanban-stat">Open Pipeline: <strong>$${totalValue.toLocaleString()}</strong></span>
        <span class="kanban-stat">Weighted: <strong>$${Math.round(weighted).toLocaleString()}</strong></span>
        <span class="kanban-stat">Won: <strong style="color:var(--accent2);">$${closedWon.toLocaleString()}</strong></span>
        <span class="kanban-stat">Deals: <strong>${deals.length}</strong></span>
    `;

    // Render columns
    board.innerHTML = KANBAN_STAGES.map(stage => {
        const config = STAGE_CONFIG[stage];
        const stageDeals = byStage[stage] || [];
        const stageTotal = stageDeals.reduce((s,d) => s + d.value, 0);
        const cards = stageDeals.sort((a,b) => b.value - a.value).map(deal => {
            const age = getDealAgeStatus(deal);
            const ageClass = age === 'critical' ? ' deal-card-age-critical' : age === 'warning' ? ' deal-card-age-warning' : '';
            const ageTitle = age === 'critical' ? 'STALE: ' + deal.daysInStage + 'd in ' + deal.stage + ' (expected ' + config.minDays + '-' + config.maxDays + 'd)' : age === 'warning' ? 'Aging: ' + deal.daysInStage + 'd in ' + deal.stage + ' (expected ' + config.minDays + '-' + config.maxDays + 'd)' : '';
            return `<div class="deal-card${ageClass}" data-account="${deal.account.replace(/"/g,'&quot;')}" style="--stage-color:${config.color};"${ageTitle ? ' title="' + ageTitle + '"' : ''} onclick="openModal('${deal.account.replace(/'/g,"\\'")}','${deal.type}')">
                <div class="deal-card-header">
                    <span class="deal-card-account">${deal.account}</span>
                    <span class="deal-card-health">${dealHealthDot(deal)}</span>
                </div>
                <div class="deal-card-value">${deal.value ? '$'+deal.value.toLocaleString() : 'â€”'}</div>
                <div class="deal-card-meta">
                    <span class="deal-card-days">${deal.daysInStage}d${age === 'critical' ? ' &#9888;' : age === 'warning' ? ' &#9201;' : ''}</span>
                    ${meddpiccBadge(deal.meddpicc)}
                </div>
                ${deal.nextAction ? `<div class="deal-card-next">&#128203; ${deal.nextAction}</div>` : ''}
            </div>`;
        }).join('');

        return `<div class="kanban-column" style="--stage-color:${config.color};">
            <div class="kanban-column-header" style="border-bottom-color:${config.color};">
                <span>${stage} <span style="opacity:.5;font-weight:400;">(${stageDeals.length})</span></span>
                <span class="col-total">${stageTotal ? '$'+stageTotal.toLocaleString() : ''}</span>
            </div>
            <div class="kanban-column-body" data-stage="${stage}">${cards}</div>
        </div>`;
    }).join('');

    // Init SortableJS on each column
    initKanbanDrag();
}

function initKanbanDrag() {
    document.querySelectorAll('.kanban-column-body').forEach(col => {
        if (col._sortable) col._sortable.destroy();
        col._sortable = new Sortable(col, {
            group: 'pipeline',
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            onEnd: function(evt) {
                const account = evt.item.dataset.account;
                const newStage = evt.to.dataset.stage;
                if (!account || !newStage) return;
                const d = getAcctData(account);
                const mScore = getMEDDPICCScore(d.meddpicc);

                // MEDDPICC gate enforcement
                if (newStage === 'Proposal' && mScore < 50) {
                    showToast('warning', 'MEDDPICC ' + mScore + '% â€” need 50%+ to advance to Proposal. Score Economic Buyer and Champion first.');
                    renderKanban(); // Revert
                    return;
                }
                if (newStage === 'Negotiation' && mScore < 70) {
                    showToast('warning', 'MEDDPICC ' + mScore + '% â€” need 70%+ to advance to Negotiation.');
                    renderKanban(); // Revert
                    return;
                }

                d.stage = newStage;
                d.stageEnteredDate = new Date().toISOString().slice(0, 10);
                if (STAGE_CONFIG[newStage]) d.prob = String(STAGE_CONFIG[newStage].prob);
                // Log stage change as activity
                if (!d.activities) d.activities = [];
                d.activities.push({ type: 'stage_change', date: new Date().toISOString(), note: 'Moved to ' + newStage });
                setAcctData(account, d);

                if (newStage === 'Closed Won') showToast('success', account + ' â€” Closed Won! Congratulations!');
                else showToast('info', account + ' moved to ' + newStage + ' (' + (STAGE_CONFIG[newStage]?.prob || 0) + '%)');

                renderKanban();
                updateDashPipeline();
                updateStageBreakdown();
                updateHotDeals();
                updateKPICards();
                updateAtRiskPanel();
                renderEnt(document.getElementById('entSearch').value, document.getElementById('entPriority').value, document.getElementById('entSector').value);
                renderSmb(document.getElementById('smbSearch').value, document.getElementById('smbIndustry').value);
                syncPipelineToProxy();
            }
        });
    });
}

// ===== TOAST NOTIFICATIONS =====
function showToast(type, message, duration) {
    duration = duration || 4000;
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'toastOut .3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// ===== FAB (Floating Action Button) =====
let fabOpen = false;
let fabCurrentType = 'call';

function toggleFAB() {
    fabOpen = !fabOpen;
    document.getElementById('fabMain').classList.toggle('open', fabOpen);
    document.getElementById('fabMenu').classList.toggle('show', fabOpen);
}

function logActivity(type) {
    fabCurrentType = type;
    toggleFAB(); // Close menu
    const titles = { call: 'Log Call', email: 'Log Email', meeting: 'Log Meeting', note: 'Add Note' };
    const icons = { call: '&#128222;', email: '&#128231;', meeting: '&#129309;', note: '&#128221;' };
    document.getElementById('fabLogTitle').innerHTML = icons[type] + ' ' + titles[type];
    document.getElementById('fabLogType').textContent = type.charAt(0).toUpperCase() + type.slice(1);
    document.getElementById('fab-log-acct').value = '';
    document.getElementById('fab-log-notes').value = '';
    document.getElementById('fabCharCount').textContent = '0';
    // Show/hide templates based on type
    document.getElementById('fabLogTemplates').style.display = (type === 'call' || type === 'meeting') ? 'flex' : 'none';
    document.getElementById('fabLogModal').classList.remove('hidden');
    document.getElementById('fab-log-acct').focus();
}

function setFabTemplate(tpl) {
    const templates = {
        discovery: 'Discovery call â€” discussed current environment, pain points, and upcoming initiatives.',
        demo: 'Demo follow-up â€” reviewed solution capabilities, addressed technical questions.',
        proposal: 'Proposal review â€” walked through SOW, pricing, and implementation timeline.',
        site: 'Site visit â€” toured facility, met stakeholders, assessed current infrastructure.'
    };
    document.getElementById('fab-log-notes').value = templates[tpl] || '';
    document.getElementById('fabCharCount').textContent = (templates[tpl] || '').length;
}

function closeFabLog() {
    document.getElementById('fabLogModal').classList.add('hidden');
}

function saveFabActivity() {
    const acct = document.getElementById('fab-log-acct').value.trim();
    const notes = document.getElementById('fab-log-notes').value.trim();
    if (!acct) { showToast('error', 'Select an account first.'); return; }

    const d = getAcctData(acct);
    const today = new Date().toISOString().slice(0, 10);
    d.lastContact = today;
    if (!d.activities) d.activities = [];
    d.activities.push({ type: fabCurrentType, date: new Date().toISOString(), note: notes || fabCurrentType });
    if (notes) d.notes = (d.notes ? d.notes + '\n\n' : '') + '[' + today + ' ' + fabCurrentType + '] ' + notes;
    setAcctData(acct, d);

    // Also post to cal-proxy notes
    fetch('http://127.0.0.1:18790/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: notes || fabCurrentType, account: acct, type: 'note', source: 'hub-fab' })
    }).catch(() => {});

    closeFabLog();
    showToast('success', fabCurrentType.charAt(0).toUpperCase() + fabCurrentType.slice(1) + ' logged for ' + acct);
    updateStaleAccounts();
    updateDashFollowUps();
    updateAtRiskPanel();
    renderKanban();
}

// FAB char counter
document.getElementById('fab-log-notes').addEventListener('input', function() {
    document.getElementById('fabCharCount').textContent = this.value.length;
});

// Close FAB log on overlay click / escape
document.getElementById('fabLogModal').addEventListener('click', e => {
    if (e.target.id === 'fabLogModal') closeFabLog();
});
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeFabLog();
});

// Close FAB menu on click outside
document.addEventListener('click', e => {
    if (fabOpen && !e.target.closest('.fab-container')) {
        fabOpen = false;
        document.getElementById('fabMain').classList.remove('open');
        document.getElementById('fabMenu').classList.remove('show');
    }
});

updateDashPipeline();
updateCompetitorFootprint();
updateDashFollowUps();
updateDashFlags();
updateStageBreakdown();
updateStaleAccounts();
updateHotDeals();
updateKPICards();
updateAtRiskPanel();
renderWhitespaceHeatmap();
renderKanban();
fetchOcNotes();
safePipelineSync(); // Safe sync on load â€” never overwrites cal-proxy with empty data
setInterval(fetchOcNotes, 30000); // Poll every 30s for new notes

// --- localStorage Backup & Restore ---
function backupLocalStorage() {
    const data = {};
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('xits_')) {
            data[key] = localStorage.getItem(key);
        }
    }
    if (Object.keys(data).length === 0) return; // Nothing to backup
    fetch('http://127.0.0.1:18790/backup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            keys: data,
            keyCount: Object.keys(data).length,
            userAgent: navigator.userAgent
        })
    }).then(() => console.log('[Hub] localStorage backed up'))
      .catch(() => console.warn('[Hub] Backup failed â€” cal-proxy unreachable'));
}

// Backup on page unload
window.addEventListener('beforeunload', backupLocalStorage);
// Also backup every 5 minutes while page is open
setInterval(backupLocalStorage, 300000);

function openRestoreModal() {
    const modal = document.getElementById('restoreModal');
    const info = document.getElementById('restoreInfo');
    const desc = document.getElementById('restoreDesc');
    const btn = document.getElementById('restoreBtn');
    info.textContent = 'Checking for backup...';
    desc.textContent = '';
    btn.style.display = 'none';
    modal.classList.remove('hidden');
    fetch('http://127.0.0.1:18790/backup').then(r => {
        if (!r.ok) throw new Error('No backup found');
        return r.json();
    }).then(backup => {
        const ts = new Date(backup.backupTimestamp);
        const ago = timeAgo(ts);
        const keyCount = backup.keyCount || Object.keys(backup.keys || {}).length;
        const ua = backup.userAgent || 'Unknown device';
        const shortDevice = ua.includes('Mac') ? 'Mac' : ua.includes('Windows') ? 'Windows' : ua.includes('Linux') ? 'Linux' : 'Unknown';
        info.textContent = 'Last backup: ' + ts.toLocaleString() + ' (' + ago + ')';
        desc.textContent = keyCount + ' keys from ' + shortDevice + '. Restoring will overwrite current localStorage data for all xits_ keys.';
        btn.style.display = 'inline-block';
    }).catch(() => {
        info.textContent = 'No backup available';
        desc.textContent = 'No previous backup found on cal-proxy. Open the Hub and use it normally â€” backups are created automatically when you close the page.';
    });
}

function restoreFromBackup() {
    fetch('http://127.0.0.1:18790/backup').then(r => r.json()).then(backup => {
        const keys = backup.keys || {};
        Object.entries(keys).forEach(([k, v]) => {
            localStorage.setItem(k, v);
        });
        document.getElementById('restoreModal').classList.add('hidden');
        location.reload();
    }).catch(() => {
        alert('Restore failed â€” could not reach cal-proxy');
    });
}
</script>

</body>
</html>
